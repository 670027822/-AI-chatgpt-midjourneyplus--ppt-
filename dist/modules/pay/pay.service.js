'use strict';function _0x9acd(_0x4e33de,_0xb261c1){const _0x366b8b=_0x366b();return _0x9acd=function(_0x9acda5,_0x2369c2){_0x9acda5=_0x9acda5-0x16b;let _0x19e760=_0x366b8b[_0x9acda5];return _0x19e760;},_0x9acd(_0x4e33de,_0xb261c1);}const _0x15fdeb=_0x9acd;(function(_0x33b2ea,_0x4d0b3b){const _0x430b24=_0x9acd,_0xd6da55=_0x33b2ea();while(!![]){try{const _0x4f26db=parseInt(_0x430b24(0x204))/0x1+-parseInt(_0x430b24(0x190))/0x2+parseInt(_0x430b24(0x16d))/0x3+parseInt(_0x430b24(0x173))/0x4+-parseInt(_0x430b24(0x1d3))/0x5*(-parseInt(_0x430b24(0x170))/0x6)+-parseInt(_0x430b24(0x199))/0x7+-parseInt(_0x430b24(0x1e7))/0x8;if(_0x4f26db===_0x4d0b3b)break;else _0xd6da55['push'](_0xd6da55['shift']());}catch(_0x1c81fb){_0xd6da55['push'](_0xd6da55['shift']());}}}(_0x366b,0x1f449));var __decorate=this&&this['__decorate']||function(_0x1e84ca,_0x50f52b,_0x15567b,_0x38a6f5){const _0x3035fe=_0x9acd;var _0x5db120=arguments[_0x3035fe(0x1ea)],_0x1a28c7=_0x5db120<0x3?_0x50f52b:_0x38a6f5===null?_0x38a6f5=Object[_0x3035fe(0x208)](_0x50f52b,_0x15567b):_0x38a6f5,_0x5dcdfc;if(typeof Reflect==='object'&&typeof Reflect[_0x3035fe(0x215)]==='function')_0x1a28c7=Reflect['decorate'](_0x1e84ca,_0x50f52b,_0x15567b,_0x38a6f5);else{for(var _0x568767=_0x1e84ca[_0x3035fe(0x1ea)]-0x1;_0x568767>=0x0;_0x568767--)if(_0x5dcdfc=_0x1e84ca[_0x568767])_0x1a28c7=(_0x5db120<0x3?_0x5dcdfc(_0x1a28c7):_0x5db120>0x3?_0x5dcdfc(_0x50f52b,_0x15567b,_0x1a28c7):_0x5dcdfc(_0x50f52b,_0x15567b))||_0x1a28c7;}return _0x5db120>0x3&&_0x1a28c7&&Object[_0x3035fe(0x1be)](_0x50f52b,_0x15567b,_0x1a28c7),_0x1a28c7;},__metadata=this&&this[_0x15fdeb(0x198)]||function(_0x106b7d,_0x227fec){const _0x58aa72=_0x15fdeb;if(typeof Reflect===_0x58aa72(0x1d9)&&typeof Reflect['metadata']===_0x58aa72(0x1a7))return Reflect[_0x58aa72(0x195)](_0x106b7d,_0x227fec);},__param=this&&this[_0x15fdeb(0x1b8)]||function(_0x1bb765,_0x567201){return function(_0x2f32b5,_0x51e3ef){_0x567201(_0x2f32b5,_0x51e3ef,_0x1bb765);};};function _0x366b(){const _0x2e597=['length','payHupiSecret','map','payHupiAppId','jsapi支付结果返回值:\x20','toFixed','join','payWeChatPublicKey','payEpayApiQueryUrl','time','__esModule','digest','1.1','payMpaySecret','errRaw','param','queryMpay','TRADE_SUCCESS','clientip','total_fee','device','typeorm','payWeChatNotifyUrl','本次支付类型:\x20','return_url','success','249917NMvWgN','alipay','sort','trade_state','getOwnPropertyDescriptor','post','failed','query','wx-native','trade_status','payHupiReturnUrl','payMpayReturnUrl','order','createRandomNonceStr','https://api.xunhupay.com/payment/query.html','sign_type','payEpaySecret','decorate','message','支付通知验证失败:\x20','payWeChatMchId','payEpayReturnUrl','535404vZWFTD','OrderEntity','text','6kFaBGR','UserService','Wap','424736zPXNfM','scene_info','findOne','MD5','Repository','queryWeChat','sign','@nestjs/common','order_no','update','toString','globalConfigService','用户openId:\x20','套餐不存在!','UserBalanceService','wechatpay-node-v3','HttpException','../user/user.service','payWeChat','notifyEpay','transactions_native','payHupiGatewayUrl','hash','wechat-pay:\x20','payWeChatH5Url','userService','payWeChatPrivateKey','log','submit.php','188384CgtSyC','payMpayPid','userBalanceService','title','wechat','metadata','default','queryEpay','__metadata','1528296qFubeu','goodsId','getOpenIdByUserId','getConfigs','out_trade_order','payEpay','notifyHupi','unsupported\x20pay\x20type','design:paramtypes','decipher_gcm','event_type','notifyMpay','epay\x20--->\x20res:\x20','version','function','支付请求失败:\x20','cramiPackageEntity','nonce_str','response','微信支付通知params:\x20','payHupi','payMpayNotifyUrl','payMpay','校验签名通过','@nestjs/typeorm','trade_order_id','payWeChatSecret','HttpStatus','epay','BAD_REQUEST','payHupiNotifyUrl','__param','payEpayPid','payWeChatAppId','192.168.1.100','addBalanceToOrder','wxpay','defineProperty','transactions_h5','Injectable','status','payer','支付请求失败!','md5','pay','appid','payMpayApiPayUrl','data','transactions_jsapi','h5_info','name','../order/order.entity','resource','queryHupi','notify_url','GlobalConfigService','pid','../crami/cramiPackage.entity','835385VjPNUG','out_trade_no','affected','payPlatform','notifyWeChat','payMpayApiQueryUrl','object','payType:\x20','orderEntity','get','createHash','key','订单不存在!','total','hupi','attach','PayService','InjectRepository','payEpayApiPayUrl','../globalConfig/globalConfig.service','2088424CTRiQX','../../common/utils','CramiPackageEntity'];_0x366b=function(){return _0x2e597;};return _0x366b();}Object[_0x15fdeb(0x1be)](exports,_0x15fdeb(0x1f4),{'value':!![]}),exports['PayService']=void 0x0;const typeorm_1=require(_0x15fdeb(0x1b1)),typeorm_2=require(_0x15fdeb(0x1ff)),common_1=require(_0x15fdeb(0x17a)),crypto=require('crypto'),axios_1=require('axios'),order_entity_1=require(_0x15fdeb(0x1cc)),cramiPackage_entity_1=require(_0x15fdeb(0x1d2)),userBalance_service_1=require('../userBalance/userBalance.service'),globalConfig_service_1=require(_0x15fdeb(0x1e6)),utils_1=require(_0x15fdeb(0x1e8)),user_service_1=require(_0x15fdeb(0x184));let PayService=class PayService{constructor(_0x4898c3,_0x29a4fc,_0x38a70d,_0x659bf7,_0x1e23b9){const _0x19f134=_0x15fdeb;this[_0x19f134(0x1a9)]=_0x4898c3,this['orderEntity']=_0x29a4fc,this[_0x19f134(0x192)]=_0x38a70d,this['globalConfigService']=_0x659bf7,this['userService']=_0x1e23b9;}async['onModuleInit'](){const _0x241985=_0x15fdeb,_0x5df546=await(0x0,utils_1['importDynamic'])(_0x241985(0x182));this['WxPay']=(_0x5df546===null||_0x5df546===void 0x0?void 0x0:_0x5df546[_0x241985(0x196)])?_0x5df546['default']:_0x5df546;}async['notify'](_0x267fca){const _0x5d575c=_0x15fdeb;if(_0x267fca[_0x5d575c(0x1f9)]==_0x5d575c(0x1b5))return this['notifyEpay'](_0x267fca);if(_0x267fca[_0x5d575c(0x1e2)]==_0x5d575c(0x1e1))return this['notifyHupi'](_0x267fca);if(typeof _0x267fca[_0x5d575c(0x1cd)]==_0x5d575c(0x1d9))return this[_0x5d575c(0x1d7)](_0x267fca);return this['notifyMpay'](_0x267fca);}async[_0x15fdeb(0x1c5)](_0x4b0df6,_0x412ef8,_0x3267bb=_0x15fdeb(0x1bd)){const _0x2d9934=_0x15fdeb,_0xfcc420=await this[_0x2d9934(0x1db)]['findOne']({'where':{'userId':_0x4b0df6,'orderId':_0x412ef8}});if(!_0xfcc420)throw new common_1[(_0x2d9934(0x183))]('订单不存在!',common_1[_0x2d9934(0x1b4)][_0x2d9934(0x1b6)]);const _0xb68044=await this[_0x2d9934(0x1a9)][_0x2d9934(0x175)]({'where':{'id':_0xfcc420['goodsId']}});if(!_0xb68044)throw new common_1[(_0x2d9934(0x183))]('套餐不存在!',common_1[_0x2d9934(0x1b4)][_0x2d9934(0x1b6)]);console[_0x2d9934(0x18e)](_0x2d9934(0x201),_0xfcc420['payPlatform']);try{if(_0xfcc420[_0x2d9934(0x1d6)]==_0x2d9934(0x194))return this[_0x2d9934(0x185)](_0x4b0df6,_0x412ef8,_0x3267bb);if(_0xfcc420[_0x2d9934(0x1d6)]=='epay')return this[_0x2d9934(0x19e)](_0x4b0df6,_0x412ef8,_0x3267bb);if(_0xfcc420['payPlatform']=='mpay')return this['payMpay'](_0x4b0df6,_0x412ef8,_0x3267bb);if(_0xfcc420[_0x2d9934(0x1d6)]==_0x2d9934(0x1e1))return this['payHupi'](_0x4b0df6,_0x412ef8,_0x3267bb);}catch(_0x152f3b){console[_0x2d9934(0x18e)](_0x2d9934(0x1a8),_0x152f3b);throw new common_1[(_0x2d9934(0x183))](_0x2d9934(0x1c3),common_1[_0x2d9934(0x1b4)]['BAD_REQUEST']);}}async[_0x15fdeb(0x20b)](_0x1cc1f2){const _0x589621=_0x15fdeb,_0x5a9735=await this[_0x589621(0x1db)][_0x589621(0x175)]({'where':{'orderId':_0x1cc1f2}});if(!_0x5a9735)throw new common_1[(_0x589621(0x183))]('订单不存在!',common_1[_0x589621(0x1b4)][_0x589621(0x1b6)]);return _0x5a9735;}async[_0x15fdeb(0x19f)](_0x3bb617){const _0x3a0c5b=_0x15fdeb,_0xd92a3a=await this[_0x3a0c5b(0x17e)][_0x3a0c5b(0x19c)]([_0x3a0c5b(0x1eb)]),_0xb8f9ae=_0x3bb617['hash'];delete _0x3bb617[_0x3a0c5b(0x189)];if(this['sign'](_0x3bb617,_0xd92a3a)!=_0xb8f9ae)return _0x3a0c5b(0x20a);const _0x36875a=await this[_0x3a0c5b(0x1db)]['findOne']({'where':{'orderId':_0x3bb617[_0x3a0c5b(0x1b2)],'status':0x0}});if(!_0x36875a)return _0x3a0c5b(0x20a);await this[_0x3a0c5b(0x192)]['addBalanceToOrder'](_0x36875a);const _0x204b08=await this[_0x3a0c5b(0x1db)][_0x3a0c5b(0x17c)]({'orderId':_0x3bb617[_0x3a0c5b(0x1b2)]},{'status':0x1,'paydAt':new Date()});if(_0x204b08[_0x3a0c5b(0x1d5)]!=0x1)return _0x3a0c5b(0x20a);return _0x3a0c5b(0x203);}async[_0x15fdeb(0x1ad)](_0xcc00df,_0x5f3fcd,_0x3a753e=_0x15fdeb(0x1bd)){const _0x910507=_0x15fdeb,_0x4a1a22=await this[_0x910507(0x1db)][_0x910507(0x175)]({'where':{'userId':_0xcc00df,'orderId':_0x5f3fcd}});if(!_0x4a1a22)throw new common_1[(_0x910507(0x183))](_0x910507(0x1df),common_1[_0x910507(0x1b4)]['BAD_REQUEST']);const _0x39536b=await this[_0x910507(0x1a9)][_0x910507(0x175)]({'where':{'id':_0x4a1a22[_0x910507(0x19a)]}});if(!_0x39536b)throw new common_1['HttpException'](_0x910507(0x180),common_1[_0x910507(0x1b4)][_0x910507(0x1b6)]);const {payHupiAppId:_0x169ff9,payHupiSecret:_0x1ea277,payHupiNotifyUrl:_0xebfeec,payHupiReturnUrl:_0x19bb37,payHupiGatewayUrl:_0x1daaa7}=await this[_0x910507(0x17e)][_0x910507(0x19c)]([_0x910507(0x1ed),_0x910507(0x1eb),_0x910507(0x1b7),_0x910507(0x20e),_0x910507(0x188)]),_0x2f2eca={};_0x2f2eca[_0x910507(0x1a6)]=_0x910507(0x1f6),_0x2f2eca['appid']=_0x169ff9,_0x2f2eca[_0x910507(0x1f3)]=(Date['now']()/0x3e8)[_0x910507(0x1ef)](0x0),_0x2f2eca[_0x910507(0x1aa)]=(0x0,utils_1[_0x910507(0x211)])(0x20),_0x2f2eca[_0x910507(0x1b2)]=_0x5f3fcd,_0x2f2eca[_0x910507(0x193)]=_0x39536b[_0x910507(0x1cb)],_0x2f2eca[_0x910507(0x1fd)]=_0x4a1a22[_0x910507(0x1e0)],_0x2f2eca[_0x910507(0x1cf)]=_0xebfeec,_0x2f2eca[_0x910507(0x202)]=_0x19bb37,_0x2f2eca[_0x910507(0x1e2)]=_0x910507(0x1e1),_0x2f2eca['hash']=this[_0x910507(0x179)](_0x2f2eca,_0x1ea277);const {data:{errcode:_0x5b73f6,errmsg:_0x2dfa35,url_qrcode:_0x23508c,url:_0x51a5b7}}=await axios_1[_0x910507(0x196)][_0x910507(0x209)](_0x1daaa7||'https://api.xunhupay.com/payment/do.html',_0x2f2eca);if(_0x5b73f6!=0x0)throw new common_1[(_0x910507(0x183))](_0x2dfa35,common_1[_0x910507(0x1b4)][_0x910507(0x1b6)]);return{'url_qrcode':_0x23508c,'url':_0x51a5b7};}async[_0x15fdeb(0x1ce)](_0x3cc400){const _0xcda522=_0x15fdeb,{payHupiAppId:_0x39d4a0,payHupiSecret:_0x109c25}=await this['globalConfigService'][_0xcda522(0x19c)]([_0xcda522(0x1ed),_0xcda522(0x1eb)]),_0x40d438={};_0x40d438[_0xcda522(0x1a6)]=_0xcda522(0x1f6),_0x40d438[_0xcda522(0x1c6)]=_0x39d4a0,_0x40d438[_0xcda522(0x1f3)]=(Date['now']()/0x3e8)[_0xcda522(0x1ef)](0x0),_0x40d438[_0xcda522(0x1aa)]=(0x0,utils_1[_0xcda522(0x211)])(0x20),_0x40d438[_0xcda522(0x19d)]=_0x3cc400,_0x40d438[_0xcda522(0x189)]=this['sign'](_0x40d438,_0x109c25);const {data:{errcode:_0x3aa538,errmsg:_0x585cc1,data:_0x348e0a}}=await axios_1['default'][_0xcda522(0x209)](_0xcda522(0x212),_0x40d438);if(_0x3aa538!=0x0)throw new common_1['HttpException'](_0x585cc1,common_1[_0xcda522(0x1b4)][_0xcda522(0x1b6)]);return _0x348e0a;}async[_0x15fdeb(0x186)](_0x595202){const _0x879d1d=_0x15fdeb,_0x4009bb=_0x595202['sign'];delete _0x595202[_0x879d1d(0x179)],delete _0x595202['sign_type'];const _0x41ee54=await this['globalConfigService'][_0x879d1d(0x19c)]([_0x879d1d(0x214)]);if(this[_0x879d1d(0x179)](_0x595202,_0x41ee54)!=_0x4009bb)return _0x879d1d(0x20a);console[_0x879d1d(0x18e)](_0x879d1d(0x1b0));const _0x173296=await this[_0x879d1d(0x1db)][_0x879d1d(0x175)]({'where':{'orderId':_0x595202[_0x879d1d(0x1d4)],'status':0x0}});if(!_0x173296)return _0x879d1d(0x20a);const _0x2d7123=_0x595202[_0x879d1d(0x20d)]==_0x879d1d(0x1fb)?0x1:0x2,_0x4cdc0c=await this[_0x879d1d(0x1db)][_0x879d1d(0x17c)]({'orderId':_0x595202[_0x879d1d(0x1d4)]},{'status':_0x2d7123,'paydAt':new Date()});_0x2d7123===0x1&&await this[_0x879d1d(0x192)][_0x879d1d(0x1bc)](_0x173296);if(_0x4cdc0c['affected']!=0x1)return _0x879d1d(0x20a);return'success';}async[_0x15fdeb(0x19e)](_0x1c3697,_0x29b5d8,_0x552038=_0x15fdeb(0x205)){const _0x438479=_0x15fdeb,_0x1cfc81=await this[_0x438479(0x1db)][_0x438479(0x175)]({'where':{'userId':_0x1c3697,'orderId':_0x29b5d8}});if(!_0x1cfc81)throw new common_1[(_0x438479(0x183))](_0x438479(0x1df),common_1[_0x438479(0x1b4)][_0x438479(0x1b6)]);const _0x185c89=await this[_0x438479(0x1a9)][_0x438479(0x175)]({'where':{'id':_0x1cfc81[_0x438479(0x19a)]}});if(!_0x185c89)throw new common_1[(_0x438479(0x183))](_0x438479(0x180),common_1[_0x438479(0x1b4)]['BAD_REQUEST']);const {payEpayPid:_0x532e34,payEpaySecret:_0x3a6551,payEpayNotifyUrl:_0x158405,payEpayReturnUrl:_0x1e1864,payEpayApiPayUrl:_0x26d3b4}=await this[_0x438479(0x17e)][_0x438479(0x19c)]([_0x438479(0x1b9),_0x438479(0x214),'payEpayNotifyUrl',_0x438479(0x16c),_0x438479(0x1e5)]);let _0x5c0bcd;_0x532e34[_0x438479(0x1ea)]<=0x10?_0x5c0bcd=Number(_0x532e34):_0x5c0bcd=BigInt(_0x532e34);const _0x3e07d8={};_0x3e07d8[_0x438479(0x1d1)]=_0x5c0bcd,_0x3e07d8['type']=_0x552038,_0x3e07d8[_0x438479(0x1d4)]=_0x29b5d8,_0x3e07d8[_0x438479(0x1cb)]=_0x185c89[_0x438479(0x1cb)],_0x3e07d8['money']=_0x1cfc81[_0x438479(0x1e0)],_0x3e07d8[_0x438479(0x1fc)]=_0x438479(0x1bb),_0x3e07d8[_0x438479(0x1fe)]='pc',_0x3e07d8['notify_url']=_0x158405,_0x3e07d8[_0x438479(0x202)]=_0x1e1864,_0x3e07d8['param']=_0x438479(0x1b5),_0x3e07d8[_0x438479(0x179)]=this['sign'](_0x3e07d8,_0x3a6551),_0x3e07d8['sign_type']=_0x438479(0x176);const _0xcc588=new URLSearchParams(_0x3e07d8)[_0x438479(0x17d)](),_0x19c8c6=_0x26d3b4+'?'+_0xcc588;if(_0x26d3b4['includes'](_0x438479(0x18f)))return{'url_qrcode':null,'redirectUrl':_0x19c8c6,'channel':_0x552038,'isRedirect':!![]};else{const _0x3c01d4=await axios_1['default'][_0x438479(0x1dc)](_0x26d3b4,{'params':_0x3e07d8});console['log'](_0x438479(0x1a5),_0x3c01d4[_0x438479(0x1c8)]);const {data:{code:_0x2075b6,msg:_0xa7ba8e,qrcode:_0x6f555b}}=_0x3c01d4;if(_0x2075b6!=0x1)throw new common_1[(_0x438479(0x183))](_0xa7ba8e,common_1[_0x438479(0x1b4)]['BAD_REQUEST']);return{'url_qrcode':_0x6f555b,'redirectUrl':null,'channel':_0x552038,'isRedirect':![]};}}async[_0x15fdeb(0x197)](_0x366469){const _0x2bfa03=_0x15fdeb,{payEpayPid:_0x453f6e,payEpaySecret:_0x505678,payEpayApiQueryUrl:_0x455120}=await this['globalConfigService'][_0x2bfa03(0x19c)]([_0x2bfa03(0x1b9),_0x2bfa03(0x214),_0x2bfa03(0x1f2)]),_0x261c92={};_0x261c92['act']=_0x2bfa03(0x210),_0x261c92[_0x2bfa03(0x1d4)]=_0x366469,_0x261c92['pid']=_0x453f6e,_0x261c92[_0x2bfa03(0x1de)]=_0x505678;const {data:{code:_0x5c70ec,msg:_0xc2873a,data:_0x56d0a1}}=await axios_1[_0x2bfa03(0x196)][_0x2bfa03(0x1dc)](_0x455120,{'params':_0x261c92});if(_0x5c70ec!=0x1)throw new common_1[(_0x2bfa03(0x183))](_0xc2873a,common_1[_0x2bfa03(0x1b4)][_0x2bfa03(0x1b6)]);return _0x56d0a1;}async[_0x15fdeb(0x1a4)](_0x1ce7d7){const _0x29b8d8=_0x15fdeb,_0x4b962d=_0x1ce7d7['sign'];delete _0x1ce7d7[_0x29b8d8(0x179)],delete _0x1ce7d7[_0x29b8d8(0x213)];const _0x53d905=await this[_0x29b8d8(0x17e)][_0x29b8d8(0x19c)]([_0x29b8d8(0x1f7)]);console[_0x29b8d8(0x18e)]('校验签名');if(this[_0x29b8d8(0x179)](_0x1ce7d7,_0x53d905)!=_0x4b962d)return _0x29b8d8(0x20a);console[_0x29b8d8(0x18e)](_0x29b8d8(0x1b0));const _0x4d8c2f=await this[_0x29b8d8(0x1db)][_0x29b8d8(0x175)]({'where':{'orderId':_0x1ce7d7[_0x29b8d8(0x1d4)],'status':0x0}});if(!_0x4d8c2f)return _0x29b8d8(0x20a);const _0x3bc83d=_0x1ce7d7[_0x29b8d8(0x20d)]==_0x29b8d8(0x1fb)?0x1:0x2;console[_0x29b8d8(0x18e)]('status:\x20',_0x3bc83d);const _0x1f60a4=await this['orderEntity'][_0x29b8d8(0x17c)]({'orderId':_0x1ce7d7[_0x29b8d8(0x1d4)]},{'status':_0x3bc83d,'paydAt':new Date()});_0x3bc83d===0x1&&await this[_0x29b8d8(0x192)][_0x29b8d8(0x1bc)](_0x4d8c2f);if(_0x1f60a4[_0x29b8d8(0x1d5)]!=0x1)return _0x29b8d8(0x20a);return _0x29b8d8(0x203);}async[_0x15fdeb(0x1af)](_0x1f6005,_0x2a6799,_0x897a54=_0x15fdeb(0x1bd)){const _0x2b9f7b=_0x15fdeb,_0x29765e=await this[_0x2b9f7b(0x1db)][_0x2b9f7b(0x175)]({'where':{'userId':_0x1f6005,'orderId':_0x2a6799}});if(!_0x29765e)throw new common_1['HttpException']('订单不存在!',common_1[_0x2b9f7b(0x1b4)][_0x2b9f7b(0x1b6)]);const _0x4251f1=await this['cramiPackageEntity'][_0x2b9f7b(0x175)]({'where':{'id':_0x29765e['goodsId']}});if(!_0x4251f1)throw new common_1[(_0x2b9f7b(0x183))]('套餐不存在!',common_1[_0x2b9f7b(0x1b4)][_0x2b9f7b(0x1b6)]);const {payMpayPid:_0x42072c,payMpaySecret:_0x146c52,payMpayNotifyUrl:_0x37771e,payMpayReturnUrl:_0x5923b9,payMpayApiPayUrl:_0x2a35f3}=await this[_0x2b9f7b(0x17e)][_0x2b9f7b(0x19c)]([_0x2b9f7b(0x191),_0x2b9f7b(0x1f7),_0x2b9f7b(0x1ae),_0x2b9f7b(0x20f),_0x2b9f7b(0x1c7)]),_0x5da7ea={};_0x5da7ea[_0x2b9f7b(0x1d1)]=Number(_0x42072c),_0x5da7ea['type']=_0x897a54,_0x5da7ea['out_trade_no']=_0x2a6799,_0x5da7ea[_0x2b9f7b(0x1cb)]=_0x4251f1[_0x2b9f7b(0x1cb)],_0x5da7ea['money']=_0x29765e[_0x2b9f7b(0x1e0)],_0x5da7ea['notify_url']=_0x37771e,_0x5da7ea[_0x2b9f7b(0x202)]=_0x5923b9,_0x5da7ea['sign']=this[_0x2b9f7b(0x179)](_0x5da7ea,_0x146c52),_0x5da7ea[_0x2b9f7b(0x213)]='MD5';const _0xebfeda=new URLSearchParams(_0x5da7ea)[_0x2b9f7b(0x17d)](),_0x52d634=_0x2a35f3+'?'+_0xebfeda;return{'url_qrcode':null,'redirectUrl':_0x52d634,'channel':_0x897a54,'isRedirect':!![]};const _0x2f98b9=await axios_1[_0x2b9f7b(0x196)][_0x2b9f7b(0x1dc)](_0x2a35f3,{'params':_0x5da7ea});}async[_0x15fdeb(0x1fa)](_0x2c4ad2){const _0x3a7cf7=_0x15fdeb,{payMpayApiQueryUrl:_0x219c29}=await this[_0x3a7cf7(0x17e)][_0x3a7cf7(0x19c)]([_0x3a7cf7(0x191),'payMpaySecret',_0x3a7cf7(0x1d8)]),_0x10d27c={};_0x10d27c['type']=0x2,_0x10d27c[_0x3a7cf7(0x17b)]=_0x2c4ad2;const {data:{code:_0x2a29c4,msg:_0x5e1300,data:_0x5c5e00}}=await axios_1[_0x3a7cf7(0x196)][_0x3a7cf7(0x1dc)](_0x219c29,{'params':_0x10d27c});if(_0x2a29c4!=0x1)throw new common_1[(_0x3a7cf7(0x183))](_0x5e1300,common_1[_0x3a7cf7(0x1b4)][_0x3a7cf7(0x1b6)]);return _0x5c5e00;}async[_0x15fdeb(0x1d7)](_0x558202){const _0x4151f4=_0x15fdeb;console[_0x4151f4(0x18e)](_0x4151f4(0x1ac),_0x558202);const {payWeChatAppId:_0x1f5d47,payWeChatMchId:_0x474245,payWeChatSecret:_0x196e66,payWeChatPublicKey:_0x4f6848,payWeChatPrivateKey:_0x5a70d6}=await this[_0x4151f4(0x17e)][_0x4151f4(0x19c)]([_0x4151f4(0x1ba),_0x4151f4(0x16b),_0x4151f4(0x1b3),_0x4151f4(0x1f1),_0x4151f4(0x18d)]),_0xc4017b=new this['WxPay']({'appid':_0x1f5d47,'mchid':_0x474245,'publicKey':_0x4f6848,'privateKey':_0x5a70d6});try{if(_0x558202[_0x4151f4(0x1a3)]=='TRANSACTION.SUCCESS'){const {ciphertext:_0x1971bc,associated_data:_0x49317f,nonce:_0x29de4f}=_0x558202[_0x4151f4(0x1cd)],_0x322b02=_0xc4017b[_0x4151f4(0x1a2)](_0x1971bc,_0x49317f,_0x29de4f,_0x196e66),_0x33c54c=await this[_0x4151f4(0x1db)][_0x4151f4(0x175)]({'where':{'orderId':_0x322b02[_0x4151f4(0x1d4)],'status':0x0}});if(!_0x33c54c)return _0x4151f4(0x20a);const _0x48517d=_0x322b02[_0x4151f4(0x207)]=='SUCCESS'?0x1:0x2,_0x17be97=await this[_0x4151f4(0x1db)][_0x4151f4(0x17c)]({'orderId':_0x322b02[_0x4151f4(0x1d4)]},{'status':_0x48517d,'paydAt':new Date()});_0x48517d===0x1&&await this['userBalanceService'][_0x4151f4(0x1bc)](_0x33c54c);if(_0x17be97[_0x4151f4(0x1d5)]!=0x1)return _0x4151f4(0x20a);}return _0x4151f4(0x203);}catch(_0x50fa4a){return console['log']('error:\x20',_0x50fa4a),console[_0x4151f4(0x18e)](_0x4151f4(0x217),_0x50fa4a),'failed';}}async[_0x15fdeb(0x185)](_0x3a367a,_0x47c7b,_0xd1dfd3='native'){const _0x3b5b9d=_0x15fdeb;var _0x5abde9,_0x272066,_0x123927;console['log'](_0x3b5b9d(0x1da),_0xd1dfd3);const _0x420507=await this['orderEntity'][_0x3b5b9d(0x175)]({'where':{'userId':_0x3a367a,'orderId':_0x47c7b}});if(!_0x420507)throw new common_1[(_0x3b5b9d(0x183))](_0x3b5b9d(0x1df),common_1[_0x3b5b9d(0x1b4)][_0x3b5b9d(0x1b6)]);const _0x61908d=await this[_0x3b5b9d(0x1a9)][_0x3b5b9d(0x175)]({'where':{'id':_0x420507[_0x3b5b9d(0x19a)]}});if(!_0x61908d)throw new common_1[(_0x3b5b9d(0x183))](_0x3b5b9d(0x180),common_1[_0x3b5b9d(0x1b4)][_0x3b5b9d(0x1b6)]);const {payWeChatAppId:_0x5c3fb1,payWeChatMchId:_0x5d3b29,payWeChatPublicKey:_0x4e4bdf,payWeChatPrivateKey:_0x2e546e,payWeChatNotifyUrl:_0x176927,payWeChatH5Name:_0x6432f3,payWeChatH5Url:_0x376aa0}=await this[_0x3b5b9d(0x17e)][_0x3b5b9d(0x19c)]([_0x3b5b9d(0x1ba),_0x3b5b9d(0x16b),_0x3b5b9d(0x1f1),_0x3b5b9d(0x18d),_0x3b5b9d(0x200),'payWeChatH5Name',_0x3b5b9d(0x18b)]),_0x3fd744=new this['WxPay']({'appid':_0x5c3fb1,'mchid':_0x5d3b29,'publicKey':_0x4e4bdf,'privateKey':_0x2e546e}),_0x4e271a={'appid':_0x5c3fb1,'mchid':_0x5d3b29,'description':_0x61908d[_0x3b5b9d(0x1cb)],'out_trade_no':_0x47c7b,'notify_url':_0x176927,'amount':{'total':Number(_0x420507[_0x3b5b9d(0x1e0)]*0x64)},'scene_info':{'payer_client_ip':_0x3b5b9d(0x1bb)}};console[_0x3b5b9d(0x18e)](_0x3b5b9d(0x18a),_0x4e271a);if(_0xd1dfd3=='h5'){_0x4e271a[_0x3b5b9d(0x174)][_0x3b5b9d(0x1ca)]={'type':_0x3b5b9d(0x172),'app_name':_0x6432f3,'app_url':_0x376aa0};const _0x5a57ca=await _0x3fd744[_0x3b5b9d(0x1bf)](_0x4e271a);if(_0x5a57ca[_0x3b5b9d(0x1c1)]===0x193){const _0x1223a3=(_0x123927=(_0x272066=(_0x5abde9=_0x5a57ca===null||_0x5a57ca===void 0x0?void 0x0:_0x5a57ca[_0x3b5b9d(0x1f8)])===null||_0x5abde9===void 0x0?void 0x0:_0x5abde9[_0x3b5b9d(0x1ab)])===null||_0x272066===void 0x0?void 0x0:_0x272066[_0x3b5b9d(0x16f)])===null||_0x123927===void 0x0?void 0x0:_0x123927[_0x3b5b9d(0x216)];throw new common_1['HttpException']((_0x5a57ca===null||_0x5a57ca===void 0x0?void 0x0:_0x5a57ca['message'])||'微信H5支付失败！',common_1['HttpStatus'][_0x3b5b9d(0x1b6)]);}const {h5_url:_0x3ecbea}=_0x5a57ca;return{'url':_0x3ecbea};}if(_0xd1dfd3=='jsapi'){const _0x29d633=await this[_0x3b5b9d(0x18c)][_0x3b5b9d(0x19b)](_0x3a367a);console[_0x3b5b9d(0x18e)](_0x3b5b9d(0x17f),_0x29d633),_0x4e271a[_0x3b5b9d(0x1c2)]={'openid':_0x29d633};const _0x202f55=await _0x3fd744[_0x3b5b9d(0x1c9)](_0x4e271a);return console[_0x3b5b9d(0x18e)](_0x3b5b9d(0x1ee),_0x202f55),_0x202f55;}if(_0xd1dfd3=='native'){const _0x5e474a=await _0x3fd744[_0x3b5b9d(0x187)](_0x4e271a),{code_url:_0x500433}=_0x5e474a;return!_0x500433&&console[_0x3b5b9d(0x18e)](_0x3b5b9d(0x20c),_0x5e474a),{'url_qrcode':_0x500433,'isRedirect':![]};}throw new common_1['HttpException'](_0x3b5b9d(0x1a0),common_1[_0x3b5b9d(0x1b4)][_0x3b5b9d(0x1b6)]);}async[_0x15fdeb(0x178)](_0x50f68b){const _0x443dc5=_0x15fdeb,{payWeChatAppId:_0x218e3b,payWeChatMchId:_0xfe23c8,payWeChatPublicKey:_0xb844f0,payWeChatPrivateKey:_0x3a9716,payWeChatNotifyUrl:_0x10a9b7,payWeChatH5Name:_0x5aece6,payWeChatH5Url:_0x2e6491}=await this['globalConfigService']['getConfigs']([_0x443dc5(0x1ba),'payWeChatMchId',_0x443dc5(0x1f1),_0x443dc5(0x18d)]),_0x45cf0e=new this['WxPay']({'appid':_0x218e3b,'mchid':_0xfe23c8,'publicKey':_0xb844f0,'privateKey':_0x3a9716}),_0x5270a0=await _0x45cf0e[_0x443dc5(0x20b)]({'out_trade_no':_0x50f68b});return _0x5270a0;}[_0x15fdeb(0x179)](_0x20ea54,_0x90985d){const _0x246f58=_0x15fdeb,_0xa60398=Object['keys'](_0x20ea54)[_0x246f58(0x206)]()[_0x246f58(0x1ec)](_0x19a185=>_0x19a185+'='+_0x20ea54[_0x19a185])[_0x246f58(0x1f0)]('&')+_0x90985d;return crypto[_0x246f58(0x1dd)](_0x246f58(0x1c4))[_0x246f58(0x17c)](_0xa60398)[_0x246f58(0x1f5)]('hex');}};PayService=__decorate([(0x0,common_1[_0x15fdeb(0x1c0)])(),__param(0x0,(0x0,typeorm_1[_0x15fdeb(0x1e4)])(cramiPackage_entity_1[_0x15fdeb(0x1e9)])),__param(0x1,(0x0,typeorm_1[_0x15fdeb(0x1e4)])(order_entity_1[_0x15fdeb(0x16e)])),__metadata(_0x15fdeb(0x1a1),[typeorm_2['Repository'],typeorm_2[_0x15fdeb(0x177)],userBalance_service_1[_0x15fdeb(0x181)],globalConfig_service_1[_0x15fdeb(0x1d0)],user_service_1[_0x15fdeb(0x171)]])],PayService),exports[_0x15fdeb(0x1e3)]=PayService;