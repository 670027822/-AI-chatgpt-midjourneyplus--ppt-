'use strict';const _0x15919f=_0x2c79;(function(_0x2005d5,_0x14c99c){const _0x429daf=_0x2c79,_0x2a63b5=_0x2005d5();while(!![]){try{const _0x4f6c65=-parseInt(_0x429daf(0x16c))/0x1+parseInt(_0x429daf(0x180))/0x2+parseInt(_0x429daf(0x114))/0x3*(parseInt(_0x429daf(0x197))/0x4)+-parseInt(_0x429daf(0x111))/0x5+-parseInt(_0x429daf(0x167))/0x6+-parseInt(_0x429daf(0x147))/0x7*(parseInt(_0x429daf(0x17a))/0x8)+parseInt(_0x429daf(0x141))/0x9;if(_0x4f6c65===_0x14c99c)break;else _0x2a63b5['push'](_0x2a63b5['shift']());}catch(_0x4a9e4f){_0x2a63b5['push'](_0x2a63b5['shift']());}}}(_0x416f,0x9440f));function _0x416f(){const _0x22293d=['typeorm','InjectRepository','registerFailEmailTitle','BAD_REQUEST','qureyUserInfoByInviteCode','ipAddress','验证码已过期、请重新发送！','ConfigEntity','userDefautlAvatar','family','userService','createRandomCode','addBalanceToNewUser','bcryptjs','function','text','../../common/constants/verification.constant',':PHONECODE:','getInfo','createMathExpr','sendPhoneCode','@nestjs/jwt','/api/auth/registerSuccess?id=','createRandomUid','verifyUserRegisterByPhone','decorate','Injectable','get','configEntity','AuthService','networkInterfaces','getIp','login','15947793TbVQXh','&username=','秒内不得重复发送短信！','visitor','length','userId','7RZMKcb','@nine.com','&registerSuccessEmaileAppend=','redirect',':CAPTCHA:','getUserInfo','address','RedisCacheService','verifyUserPassword','@nestjs/typeorm','savaLoginIp','verifyCaptcha','@nestjs/common','avatar','error:\x20','createTokenFromFingerprint','updateUserStatus','../userBalance/userBalance.service','./../verification/verification.service','redisCacheService','UserStatusEnum','response','object','forEach','HttpException','__metadata','VerificationEnum','configVal','loginByPhone','registerSuccessEmaileAppend','旧密码错误、请检查提交','toString','1521384gfIeGs','registerFailEmailTeamName','queryUserInfoById','验证码发送成功、请填写验证码完成注册！','verifyCode','432193mZSxog','Repository','账户已被激活过','getNamespace','password','../globalConfig/globalConfig.service','ACTIVE','VerificationService','verificationService','reduce','registerSuccessEmailTitle','getConfigs','GlobalConfigService','ttl','8163184xWtnIK','JwtService','saveToken','getUserStatus','hashSync','&email=','1654730jIPjHg','padStart','data','metadata','updatePassword','IPv4','../../common/constants/user.constant','internal','&registerFailEmailTitle=','userBalanceService','createUser','../mailer/mailer.service','验证码填写错误、请重新输入！','getClientIp','verifyUserCredentials','defineProperty','updatePassByOther','updateUserPassword','loginByOpenId','密码修改成功','&registerSuccessEmailTeamName=','register','验证码类型错误','228CCEckm','__param','createUserAndVerifycation','configKey','jwtService','globalConfigService','2950745tKmCmS','set','非法操作、请联系管理员！','16011NYzHcc','UserBalanceService','getOwnPropertyDescriptor','user','sign','registerSuccessEmailTeamName','mailerService','Registration','captcha','/api/auth/registerError?message=','HttpStatus','onModuleInit'];_0x416f=function(){return _0x22293d;};return _0x416f();}function _0x2c79(_0x168481,_0x3b400f){const _0x416fd1=_0x416f();return _0x2c79=function(_0x2c79d4,_0x38f903){_0x2c79d4=_0x2c79d4-0x10c;let _0x5478ce=_0x416fd1[_0x2c79d4];return _0x5478ce;},_0x2c79(_0x168481,_0x3b400f);}var __decorate=this&&this['__decorate']||function(_0x4b658e,_0x52dfbf,_0x116e89,_0x89e4b9){const _0xdbe247=_0x2c79;var _0xca0ec4=arguments[_0xdbe247(0x145)],_0x2e3f58=_0xca0ec4<0x3?_0x52dfbf:_0x89e4b9===null?_0x89e4b9=Object[_0xdbe247(0x116)](_0x52dfbf,_0x116e89):_0x89e4b9,_0x256b2c;if(typeof Reflect==='object'&&typeof Reflect[_0xdbe247(0x139)]===_0xdbe247(0x12e))_0x2e3f58=Reflect[_0xdbe247(0x139)](_0x4b658e,_0x52dfbf,_0x116e89,_0x89e4b9);else{for(var _0x3f4b51=_0x4b658e[_0xdbe247(0x145)]-0x1;_0x3f4b51>=0x0;_0x3f4b51--)if(_0x256b2c=_0x4b658e[_0x3f4b51])_0x2e3f58=(_0xca0ec4<0x3?_0x256b2c(_0x2e3f58):_0xca0ec4>0x3?_0x256b2c(_0x52dfbf,_0x116e89,_0x2e3f58):_0x256b2c(_0x52dfbf,_0x116e89))||_0x2e3f58;}return _0xca0ec4>0x3&&_0x2e3f58&&Object[_0xdbe247(0x18f)](_0x52dfbf,_0x116e89,_0x2e3f58),_0x2e3f58;},__metadata=this&&this[_0x15919f(0x160)]||function(_0x57c0aa,_0x295fa2){const _0x2cd6e9=_0x15919f;if(typeof Reflect===_0x2cd6e9(0x15d)&&typeof Reflect[_0x2cd6e9(0x183)]===_0x2cd6e9(0x12e))return Reflect[_0x2cd6e9(0x183)](_0x57c0aa,_0x295fa2);},__param=this&&this[_0x15919f(0x10c)]||function(_0x38e42c,_0xbda310){return function(_0x304b78,_0x2db97e){_0xbda310(_0x304b78,_0x2db97e,_0x38e42c);};};Object[_0x15919f(0x18f)](exports,'__esModule',{'value':!![]}),exports[_0x15919f(0x13d)]=void 0x0;const globalConfig_service_1=require(_0x15919f(0x171)),verification_constant_1=require(_0x15919f(0x130)),verification_service_1=require(_0x15919f(0x159)),common_1=require(_0x15919f(0x153)),jwt_1=require(_0x15919f(0x135)),user_service_1=require('../user/user.service'),mailer_service_1=require(_0x15919f(0x18b)),user_constant_1=require(_0x15919f(0x186)),userBalance_service_1=require(_0x15919f(0x158)),config_entity_1=require('../globalConfig/config.entity'),typeorm_1=require(_0x15919f(0x120)),typeorm_2=require(_0x15919f(0x150)),utils_1=require('../../common/utils'),os=require('os'),redisCache_service_1=require('../redisCache/redisCache.service'),svgCaptcha=require('svg-captcha'),bcrypt=require(_0x15919f(0x12d));let AuthService=class AuthService{constructor(_0x1f8975,_0x5a9364,_0x3e2b46,_0x11476f,_0x5ac3e8,_0x1c3745,_0x33a728,_0x6ebbed){const _0x342a28=_0x15919f;this[_0x342a28(0x13c)]=_0x1f8975,this[_0x342a28(0x12a)]=_0x5a9364,this[_0x342a28(0x10f)]=_0x3e2b46,this[_0x342a28(0x11a)]=_0x11476f,this[_0x342a28(0x174)]=_0x5ac3e8,this['userBalanceService']=_0x1c3745,this[_0x342a28(0x15a)]=_0x33a728,this['globalConfigService']=_0x6ebbed;}async[_0x15919f(0x11f)](){const _0xcab8f3=_0x15919f;this[_0xcab8f3(0x13f)]();}async[_0x15919f(0x195)](_0x545fd4,_0x35fcfe){const _0x517df8=_0x15919f;await this['verificationService'][_0x517df8(0x152)](_0x545fd4);const _0x29093a=await this[_0x517df8(0x12a)][_0x517df8(0x10d)](_0x545fd4,_0x35fcfe),{username:_0x53d119,email:_0x8c861c,client:_0x28e48d,id:_0x5cb30e}=_0x29093a,_0x3aaa2e={'username':_0x53d119,'email':_0x8c861c,'id':_0x5cb30e};return _0x28e48d&&(_0x3aaa2e['client']=_0x28e48d),_0x3aaa2e;}async['registerByPhone'](_0x24958f,_0x2546e9){const _0x2a424d=_0x15919f,{username:_0x256075,password:_0x4bfbd1,phone:_0x29bf24,phoneCode:_0x15dea8,invitedBy:_0x147c7d}=_0x24958f;await this[_0x2a424d(0x12a)][_0x2a424d(0x138)](_0x24958f);const _0x22658d=await this[_0x2a424d(0x110)][_0x2a424d(0x16f)](),_0xa5d459=_0x22658d+_0x2a424d(0x131)+_0x29bf24,_0x1a10fa=await this['redisCacheService'][_0x2a424d(0x13b)]({'key':_0xa5d459});if(!_0x1a10fa)throw new common_1[(_0x2a424d(0x15f))](_0x2a424d(0x126),common_1[_0x2a424d(0x11e)][_0x2a424d(0x123)]);if(_0x15dea8!==_0x1a10fa)throw new common_1[(_0x2a424d(0x15f))](_0x2a424d(0x18c),common_1['HttpStatus'][_0x2a424d(0x123)]);const _0x10cbe6=(0x0,utils_1[_0x2a424d(0x137)])()+_0x2a424d(0x148),_0x38509f={'username':_0x256075,'password':_0x4bfbd1,'phone':_0x29bf24,'invitedBy':_0x147c7d,'email':_0x10cbe6,'status':user_constant_1[_0x2a424d(0x15b)]['ACTIVE']},_0x82c95b=await this['globalConfigService'][_0x2a424d(0x177)]([_0x2a424d(0x128)]);_0x38509f[_0x2a424d(0x154)]=_0x82c95b;const _0x3bef2a=bcrypt[_0x2a424d(0x17e)](_0x4bfbd1,0xa);_0x38509f[_0x2a424d(0x170)]=_0x3bef2a;const _0x4df42a=await this[_0x2a424d(0x12a)][_0x2a424d(0x18a)](_0x38509f);let _0x3b8eaa;_0x147c7d&&(_0x3b8eaa=await this[_0x2a424d(0x12a)][_0x2a424d(0x124)](_0x147c7d));await this['userBalanceService'][_0x2a424d(0x12c)](_0x4df42a['id'],_0x3b8eaa===null||_0x3b8eaa===void 0x0?void 0x0:_0x3b8eaa['id']);return;}async[_0x15919f(0x140)](_0xbc6b01,_0x4427c3){const _0x4273fe=_0x15919f,_0x1de511=await this['userService'][_0x4273fe(0x18e)](_0xbc6b01),{username:_0x318dc0,id:_0x2fc022,email:_0x5a1c98,role:_0x4ee87b,openId:_0x247256,client:_0x51e5c5}=_0x1de511,_0x175f4e=(0x0,utils_1[_0x4273fe(0x18d)])(_0x4427c3);await this['userService'][_0x4273fe(0x151)](_0x2fc022,_0x175f4e);const _0x2d5380=await this['jwtService'][_0x4273fe(0x118)]({'username':_0x318dc0,'id':_0x2fc022,'email':_0x5a1c98,'role':_0x4ee87b,'openId':_0x247256,'client':_0x51e5c5});return await this[_0x4273fe(0x15a)][_0x4273fe(0x17c)](_0x2fc022,_0x2d5380),_0x2d5380;}async[_0x15919f(0x163)](_0x45c072,_0xa6a352){const _0x4848e4=_0x15919f,_0x3242d1=await this['userService']['verifyUserCredentials'](_0x45c072),{username:_0x3864b0,id:_0x41a169,email:_0x3d48b4,role:_0xb033fb,openId:_0x46c55c,client:_0x31e902}=_0x3242d1,_0x3658ac=(0x0,utils_1[_0x4848e4(0x18d)])(_0xa6a352);await this[_0x4848e4(0x12a)]['savaLoginIp'](_0x41a169,_0x3658ac);const {phone:_0x31b796}=_0x45c072,_0x1278aa=await this[_0x4848e4(0x10f)][_0x4848e4(0x118)]({'username':_0x3864b0,'id':_0x41a169,'email':_0x3d48b4,'role':_0xb033fb,'openId':_0x46c55c,'client':_0x31e902,'phone':_0x31b796});return await this[_0x4848e4(0x15a)][_0x4848e4(0x17c)](_0x41a169,_0x1278aa),_0x1278aa;}async[_0x15919f(0x192)](_0x2ad114,_0x391987){const _0x3fdaed=_0x15919f,{status:_0x476fd6}=_0x2ad114;if(_0x476fd6!==user_constant_1['UserStatusEnum'][_0x3fdaed(0x172)])throw new common_1['HttpException'](user_constant_1['UserStatusErrMsg'][_0x476fd6],common_1[_0x3fdaed(0x11e)][_0x3fdaed(0x123)]);const {username:_0x146db7,id:_0x57b282,email:_0xbc154,role:_0x22a2a3,openId:_0x3bbe8f,client:_0x49e926}=_0x2ad114,_0x1faebe=(0x0,utils_1[_0x3fdaed(0x18d)])(_0x391987);await this['userService'][_0x3fdaed(0x151)](_0x57b282,_0x1faebe);const _0x13cc3a=await this[_0x3fdaed(0x10f)][_0x3fdaed(0x118)]({'username':_0x146db7,'id':_0x57b282,'email':_0xbc154,'role':_0x22a2a3,'openId':_0x3bbe8f,'client':_0x49e926});return await this[_0x3fdaed(0x15a)][_0x3fdaed(0x17c)](_0x57b282,_0x13cc3a),_0x13cc3a;}async[_0x15919f(0x132)](_0xc05885){const _0xfe388a=_0x15919f,{id:_0x472848}=_0xc05885[_0xfe388a(0x117)];return await this[_0xfe388a(0x12a)][_0xfe388a(0x14c)](_0x472848);}async['activateAccount'](_0x5f42ab,_0x48a990){const _0x40590a=_0x15919f,_0x4c0129=await this[_0x40590a(0x13c)]['find']({'where':{'configKey':(0x0,typeorm_1['In'])([_0x40590a(0x176),'registerSuccessEmailTeamName',_0x40590a(0x164),_0x40590a(0x122),'registerFailEmailTeamName'])}}),_0x41ed7b=_0x4c0129[_0x40590a(0x175)]((_0xa2b3e,_0x4c4dc4)=>{const _0x1bde20=_0x40590a;return _0xa2b3e[_0x4c4dc4[_0x1bde20(0x10e)]]=_0x4c4dc4[_0x1bde20(0x162)],_0xa2b3e;},{});try{const _0x5aeeba=await this[_0x40590a(0x174)][_0x40590a(0x16b)](_0x5f42ab,verification_constant_1['VerificationEnum'][_0x40590a(0x11b)]),{type:_0x4e62a5,userId:_0x442987}=_0x5aeeba;if(_0x4e62a5!==verification_constant_1[_0x40590a(0x161)][_0x40590a(0x11b)])throw new common_1['HttpException'](_0x40590a(0x196),common_1['HttpStatus'][_0x40590a(0x123)]);const _0x2d82b8=await this[_0x40590a(0x12a)][_0x40590a(0x17d)](_0x442987);if(_0x2d82b8===user_constant_1[_0x40590a(0x15b)][_0x40590a(0x172)])throw new common_1[(_0x40590a(0x15f))](_0x40590a(0x16e),common_1[_0x40590a(0x11e)][_0x40590a(0x123)]);await this[_0x40590a(0x12a)][_0x40590a(0x157)](_0x5aeeba['userId'],user_constant_1['UserStatusEnum'][_0x40590a(0x172)]);const _0x3b2dde=await this[_0x40590a(0x12a)][_0x40590a(0x169)](_0x5aeeba[_0x40590a(0x146)]),{username:_0x3a6018,email:_0x3baf51,id:_0x335b8b,invitedBy:_0x1883ce}=_0x3b2dde;let _0x1563d6;_0x1883ce&&(_0x1563d6=await this['userService']['qureyUserInfoByInviteCode'](_0x1883ce)),await this[_0x40590a(0x189)]['addBalanceToNewUser'](_0x335b8b,_0x1563d6===null||_0x1563d6===void 0x0?void 0x0:_0x1563d6['id']),_0x48a990[_0x40590a(0x14a)](_0x40590a(0x136)+_0x335b8b[_0x40590a(0x166)]()[_0x40590a(0x181)](0x4,'0')+_0x40590a(0x142)+_0x3a6018+_0x40590a(0x17f)+_0x3baf51+'&registerSuccessEmailTitle='+_0x41ed7b[_0x40590a(0x176)]+_0x40590a(0x194)+_0x41ed7b[_0x40590a(0x119)]+_0x40590a(0x149)+_0x41ed7b['registerSuccessEmaileAppend']);}catch(_0x4ae8f1){console['log'](_0x40590a(0x155),_0x4ae8f1);const _0x41b9ff=_0x4ae8f1[_0x40590a(0x15c)];_0x48a990['redirect'](_0x40590a(0x11d)+_0x41b9ff+_0x40590a(0x188)+_0x41ed7b['registerFailEmailTitle']+'&registerFailEmailTeamName='+_0x41ed7b[_0x40590a(0x168)]);}}async[_0x15919f(0x184)](_0x339c9a,_0xf04f27){const _0x4d663d=_0x15919f,{id:_0x4fcc0b,client:_0x54590c,role:_0x4c5d8d}=_0x339c9a[_0x4d663d(0x117)];if(_0x54590c&&Number(_0x54590c)>0x0)throw new common_1[(_0x4d663d(0x15f))]('无权此操作、请联系管理员！',common_1[_0x4d663d(0x11e)][_0x4d663d(0x123)]);if(_0x4c5d8d==='admin')throw new common_1['HttpException'](_0x4d663d(0x113),common_1[_0x4d663d(0x11e)][_0x4d663d(0x123)]);const _0x3114ed=await this['userService'][_0x4d663d(0x14f)](_0x4fcc0b,_0xf04f27['oldPassword']);if(!_0x3114ed)throw new common_1[(_0x4d663d(0x15f))](_0x4d663d(0x165),common_1[_0x4d663d(0x11e)][_0x4d663d(0x123)]);return this[_0x4d663d(0x12a)][_0x4d663d(0x191)](_0x4fcc0b,_0xf04f27[_0x4d663d(0x170)]),_0x4d663d(0x193);}async[_0x15919f(0x190)](_0x2282ac,_0x3a47e0){const _0x40b368=_0x15919f,{id:_0x3b3567,client:_0x3136bc}=_0x2282ac[_0x40b368(0x117)];if(!_0x3136bc)throw new common_1[(_0x40b368(0x15f))]('无权此操作！',common_1[_0x40b368(0x11e)]['BAD_REQUEST']);return this['userService']['updateUserPassword'](_0x3b3567,_0x3a47e0['password']),'密码修改成功';}[_0x15919f(0x13f)](){const _0x527a9f=_0x15919f;let _0x307bcf;const _0x5cf944=os[_0x527a9f(0x13e)]();Object['keys'](_0x5cf944)[_0x527a9f(0x15e)](_0x15ca83=>{const _0x11927a=_0x527a9f,_0x3ed31c=_0x5cf944[_0x15ca83];for(let _0xb374b6=0x0;_0xb374b6<_0x3ed31c[_0x11927a(0x145)];_0xb374b6++){const _0x5339f2=_0x3ed31c[_0xb374b6];if(_0x5339f2[_0x11927a(0x129)]===_0x11927a(0x185)&&_0x5339f2[_0x11927a(0x14d)]!=='127.0.0.1'&&!_0x5339f2[_0x11927a(0x187)]){_0x307bcf=_0x5339f2[_0x11927a(0x14d)];break;}}}),this[_0x527a9f(0x125)]=_0x307bcf;}async[_0x15919f(0x11c)](_0x4611f2){const _0x141d7f=_0x15919f,_0x7aef50=await this[_0x141d7f(0x110)][_0x141d7f(0x16f)](),{color:color='#fff'}=_0x4611f2,_0x28b249=svgCaptcha[_0x141d7f(0x133)]({'background':color,'height':0x22,'width':0x78,'noise':0x3}),_0x3aa168=_0x28b249[_0x141d7f(0x12f)],_0x2853c7=(0x0,utils_1[_0x141d7f(0x137)])(),_0x2f911f=_0x7aef50+_0x141d7f(0x14b)+_0x2853c7;return await this[_0x141d7f(0x15a)][_0x141d7f(0x112)]({'key':_0x2f911f,'val':_0x28b249[_0x141d7f(0x12f)]},0x5*0x3c),{'svgCode':_0x28b249[_0x141d7f(0x182)],'code':_0x2853c7};}async[_0x15919f(0x134)](_0x32199c){const _0x153bc8=_0x15919f;await this[_0x153bc8(0x174)][_0x153bc8(0x152)](_0x32199c);const {phone:_0x56a1e1}=_0x32199c,_0x13249e=await this[_0x153bc8(0x110)][_0x153bc8(0x16f)](),_0x3e8b77=_0x13249e+_0x153bc8(0x131)+_0x56a1e1,_0xa1f515=await this[_0x153bc8(0x15a)][_0x153bc8(0x179)](_0x3e8b77);if(_0xa1f515&&_0xa1f515>0x0)throw new common_1[(_0x153bc8(0x15f))](_0xa1f515+_0x153bc8(0x143),common_1[_0x153bc8(0x11e)][_0x153bc8(0x123)]);const _0x35a70b=(0x0,utils_1[_0x153bc8(0x12b)])(),_0xe59da2={'phone':_0x56a1e1,'code':_0x35a70b};return await this[_0x153bc8(0x174)][_0x153bc8(0x134)](_0xe59da2),await this['redisCacheService'][_0x153bc8(0x112)]({'key':_0x3e8b77,'val':_0x35a70b},0x1*0x3c),_0x153bc8(0x16a);}[_0x15919f(0x156)](_0x4a13bd){const _0x3571a3=_0x15919f,_0x5a418d=this[_0x3571a3(0x10f)][_0x3571a3(0x118)]({'username':'游客'+_0x4a13bd,'id':_0x4a13bd,'email':_0x4a13bd+_0x3571a3(0x148),'role':_0x3571a3(0x144),'openId':null,'client':null});return _0x5a418d;}};AuthService=__decorate([(0x0,common_1[_0x15919f(0x13a)])(),__param(0x0,(0x0,typeorm_2[_0x15919f(0x121)])(config_entity_1[_0x15919f(0x127)])),__metadata('design:paramtypes',[typeorm_1[_0x15919f(0x16d)],user_service_1['UserService'],jwt_1[_0x15919f(0x17b)],mailer_service_1['MailerService'],verification_service_1[_0x15919f(0x173)],userBalance_service_1[_0x15919f(0x115)],redisCache_service_1[_0x15919f(0x14e)],globalConfig_service_1[_0x15919f(0x178)]])],AuthService),exports[_0x15919f(0x13d)]=AuthService;