'use strict';const _0x22a66e=_0x536b;(function(_0x1adf00,_0x4d744f){const _0x5e7f6c=_0x536b,_0x4c0dec=_0x1adf00();while(!![]){try{const _0x11920=-parseInt(_0x5e7f6c(0x252))/0x1+-parseInt(_0x5e7f6c(0x263))/0x2+parseInt(_0x5e7f6c(0x250))/0x3*(parseInt(_0x5e7f6c(0x261))/0x4)+-parseInt(_0x5e7f6c(0x27c))/0x5+-parseInt(_0x5e7f6c(0x204))/0x6*(parseInt(_0x5e7f6c(0x2a0))/0x7)+parseInt(_0x5e7f6c(0x2ab))/0x8+-parseInt(_0x5e7f6c(0x270))/0x9*(-parseInt(_0x5e7f6c(0x25a))/0xa);if(_0x11920===_0x4d744f)break;else _0x4c0dec['push'](_0x4c0dec['shift']());}catch(_0x40fa55){_0x4c0dec['push'](_0x4c0dec['shift']());}}}(_0x3ae6,0xd3d57));function _0x536b(_0x424c9a,_0x353868){const _0x3ae614=_0x3ae6();return _0x536b=function(_0x536bfc,_0x3ad6c6){_0x536bfc=_0x536bfc-0x1f4;let _0x3c4cf4=_0x3ae614[_0x536bfc];return _0x3c4cf4;},_0x536b(_0x424c9a,_0x353868);}var __decorate=this&&this[_0x22a66e(0x240)]||function(_0x7f1f42,_0x50da98,_0x213eef,_0x47ea97){const _0x3ee1a2=_0x22a66e;var _0x80959d=arguments[_0x3ee1a2(0x28c)],_0x9d6cad=_0x80959d<0x3?_0x50da98:_0x47ea97===null?_0x47ea97=Object[_0x3ee1a2(0x276)](_0x50da98,_0x213eef):_0x47ea97,_0x1e4f8f;if(typeof Reflect===_0x3ee1a2(0x293)&&typeof Reflect[_0x3ee1a2(0x275)]===_0x3ee1a2(0x210))_0x9d6cad=Reflect['decorate'](_0x7f1f42,_0x50da98,_0x213eef,_0x47ea97);else{for(var _0x4d7d97=_0x7f1f42[_0x3ee1a2(0x28c)]-0x1;_0x4d7d97>=0x0;_0x4d7d97--)if(_0x1e4f8f=_0x7f1f42[_0x4d7d97])_0x9d6cad=(_0x80959d<0x3?_0x1e4f8f(_0x9d6cad):_0x80959d>0x3?_0x1e4f8f(_0x50da98,_0x213eef,_0x9d6cad):_0x1e4f8f(_0x50da98,_0x213eef))||_0x9d6cad;}return _0x80959d>0x3&&_0x9d6cad&&Object[_0x3ee1a2(0x218)](_0x50da98,_0x213eef,_0x9d6cad),_0x9d6cad;},__metadata=this&&this[_0x22a66e(0x271)]||function(_0x1f851b,_0x308aa9){const _0x482627=_0x22a66e;if(typeof Reflect===_0x482627(0x293)&&typeof Reflect['metadata']===_0x482627(0x210))return Reflect[_0x482627(0x20c)](_0x1f851b,_0x308aa9);},__param=this&&this[_0x22a66e(0x26f)]||function(_0x55744f,_0xe000a8){return function(_0x4da220,_0x33b97a){_0xe000a8(_0x4da220,_0x33b97a,_0x55744f);};};Object[_0x22a66e(0x218)](exports,'__esModule',{'value':!![]}),exports[_0x22a66e(0x254)]=void 0x0;const globalConfig_service_1=require(_0x22a66e(0x2b7)),typeorm_1=require(_0x22a66e(0x25d)),balance_entity_1=require(_0x22a66e(0x239)),common_1=require(_0x22a66e(0x221)),typeorm_2=require(_0x22a66e(0x1fc)),balance_constant_1=require(_0x22a66e(0x243)),accountLog_entity_1=require(_0x22a66e(0x23e)),utils_1=require(_0x22a66e(0x257)),config_entity_1=require(_0x22a66e(0x21e)),cramiPackage_entity_1=require(_0x22a66e(0x209)),userBalance_entity_1=require('./userBalance.entity'),date_1=require(_0x22a66e(0x2ad)),user_entity_1=require(_0x22a66e(0x20f)),salesUsers_entity_1=require(_0x22a66e(0x283)),sales_service_1=require(_0x22a66e(0x241)),whiteList_entity_1=require(_0x22a66e(0x24a)),fingerprint_entity_1=require('./fingerprint.entity'),chatLog_entity_1=require('../chatLog/chatLog.entity'),chatGroup_entity_1=require('../chatGroup/chatGroup.entity'),midjourney_entity_1=require(_0x22a66e(0x2b8));let UserBalanceService=class UserBalanceService{constructor(_0x4e1799,_0xa56652,_0x2c6a96,_0x406484,_0x2c5533,_0x518935,_0x5e6128,_0x90dab8,_0x10fa8b,_0x2796ec,_0x5def15,_0x1c8f41,_0x395e0e,_0x78d7a1){const _0x5ef226=_0x22a66e;this['balanceEntity']=_0x4e1799,this[_0x5ef226(0x1f4)]=_0xa56652,this['accountLogEntity']=_0x2c6a96,this[_0x5ef226(0x208)]=_0x406484,this[_0x5ef226(0x227)]=_0x2c5533,this[_0x5ef226(0x26d)]=_0x518935,this['salesUsersEntity']=_0x5e6128,this[_0x5ef226(0x24f)]=_0x90dab8,this['fingerprintLogEntity']=_0x10fa8b,this[_0x5ef226(0x255)]=_0x2796ec,this['chatLogEntity']=_0x5def15,this['midjourneyEntity']=_0x1c8f41,this[_0x5ef226(0x237)]=_0x395e0e,this[_0x5ef226(0x21c)]=_0x78d7a1;}async[_0x22a66e(0x245)](_0x5af350,_0x1d3d60){const _0x3ed18b=_0x22a66e;try{const _0x29ddbc=await this[_0x3ed18b(0x227)]['find']({'where':{'configKey':(0x0,typeorm_2['In'])([_0x3ed18b(0x24e),_0x3ed18b(0x1f7),_0x3ed18b(0x223),'registerSendDrawMjCount',_0x3ed18b(0x26a),_0x3ed18b(0x2a8),'firstRregisterSendModel3Count',_0x3ed18b(0x258),'firstRregisterSendDrawMjCount',_0x3ed18b(0x269),_0x3ed18b(0x29c),'inviteGiveSendModel4Count',_0x3ed18b(0x29f),_0x3ed18b(0x23b),_0x3ed18b(0x231),'invitedGuestSendModel4Count'])}}),_0x1aaca5=_0x29ddbc[_0x3ed18b(0x1ff)]((_0x27f339,_0x38e863)=>{const _0x1aab34=_0x3ed18b,_0x19105e=Number(_0x38e863[_0x1aab34(0x232)]),_0x713d4f=Number[_0x1aab34(0x25b)](_0x19105e)&&_0x19105e>0x0?_0x19105e:0x0;return _0x27f339[_0x38e863['configKey']]=_0x713d4f,_0x27f339;},{});let _0x595fbd=0x0,_0x408c24=0x0,_0x759d45=0x0;_0x1aaca5[_0x3ed18b(0x24e)]===0x1&&(_0x595fbd=_0x595fbd+_0x1aaca5[_0x3ed18b(0x1f7)],_0x408c24=_0x408c24+_0x1aaca5[_0x3ed18b(0x223)],_0x759d45=_0x759d45+_0x1aaca5[_0x3ed18b(0x26e)]),_0x1aaca5[_0x3ed18b(0x24e)]===0x1&&_0x1aaca5['firstRegisterSendStatus']===0x1&&_0x5af350<=_0x1aaca5[_0x3ed18b(0x2a8)]&&(_0x595fbd=_0x595fbd+_0x1aaca5['firstRregisterSendModel3Count'],_0x408c24=_0x408c24+_0x1aaca5['firstRregisterSendModel4Count'],_0x759d45=_0x759d45+_0x1aaca5[_0x3ed18b(0x2aa)]),await this['saveRecordRechargeLog']({'userId':_0x5af350,'rechargeType':balance_constant_1[_0x3ed18b(0x203)]['REG_GIFT'],'model3Count':_0x595fbd,'drawMjCount':_0x759d45,'model4Count':_0x408c24}),_0x1d3d60&&(Number(_0x1aaca5[_0x3ed18b(0x269)])===0x1&&(_0x595fbd=_0x595fbd+Number(_0x1aaca5[_0x3ed18b(0x23b)]),_0x408c24=_0x408c24+Number(_0x1aaca5[_0x3ed18b(0x1fa)]),_0x759d45=_0x759d45+Number(_0x1aaca5[_0x3ed18b(0x231)]),await this['saveRecordRechargeLog']({'userId':_0x5af350,'rechargeType':balance_constant_1[_0x3ed18b(0x203)][_0x3ed18b(0x28d)],'model3Count':_0x1aaca5[_0x3ed18b(0x23b)],'model4Count':_0x1aaca5[_0x3ed18b(0x1fa)],'drawMjCount':_0x1aaca5[_0x3ed18b(0x231)]}),await this[_0x3ed18b(0x22c)](_0x1d3d60,{'model3Count':_0x1aaca5[_0x3ed18b(0x29c)],'model4Count':_0x1aaca5['inviteGiveSendModel4Count'],'drawMjCount':_0x1aaca5['inviteGiveSendDrawMjCount']}),await this[_0x3ed18b(0x22f)]({'userId':_0x1d3d60,'rechargeType':balance_constant_1[_0x3ed18b(0x203)][_0x3ed18b(0x285)],'model3Count':_0x1aaca5[_0x3ed18b(0x29c)],'model4Count':_0x1aaca5[_0x3ed18b(0x23d)],'drawMjCount':_0x1aaca5['inviteGiveSendDrawMjCount']}))),await this[_0x3ed18b(0x1f4)][_0x3ed18b(0x1f5)]({'userId':_0x5af350,'model3Count':_0x595fbd,'model4Count':_0x408c24,'drawMjCount':_0x759d45,'useTokens':0x0});}catch(_0x329895){console[_0x3ed18b(0x2a5)](_0x3ed18b(0x28f),_0x329895);throw new common_1[(_0x3ed18b(0x1fb))](_0x3ed18b(0x262),common_1['HttpStatus'][_0x3ed18b(0x22b)]);}}async['validateBalance'](_0x2b3e7c,_0x146cec,_0x38ab4b){const _0xc0af01=_0x22a66e,{id:_0x17d666,role:_0x23f0a7}=_0x2b3e7c['user'];let _0xc25ea6=await this['userBalanceEntity'][_0xc0af01(0x2b5)]({'where':{'userId':_0x17d666}});!_0xc25ea6&&(_0xc25ea6=await this[_0xc0af01(0x24d)](_0x17d666));if(_0x23f0a7===_0xc0af01(0x242))return this[_0xc0af01(0x24c)](_0x2b3e7c,_0x146cec,_0x38ab4b);const _0x41f55a=await this[_0xc0af01(0x227)][_0xc0af01(0x2b5)]({'where':{'configKey':_0xc0af01(0x21f)}}),_0xc71c50=_0x41f55a?_0x41f55a[_0xc0af01(0x232)]:_0xc0af01(0x236),_0x2da1a3=_0x146cec===_0xc0af01(0x228)?_0xc0af01(0x22a):_0x146cec==='model4'?_0xc0af01(0x246):_0x146cec===_0xc0af01(0x29b)?'memberDrawMjCount':null,_0x2c4502=_0x146cec==='model3'?_0xc0af01(0x207):_0x146cec===_0xc0af01(0x21b)?'model4Count':_0x146cec===_0xc0af01(0x29b)?_0xc0af01(0x2a4):null;if(_0xc25ea6[_0xc0af01(0x27d)]&&_0xc25ea6[_0x2da1a3]<_0x38ab4b){if(_0xc25ea6[_0x2c4502]<_0x38ab4b)throw new common_1[(_0xc0af01(0x1fb))](_0xc0af01(0x24b)+_0xc71c50+_0xc0af01(0x216),common_1[_0xc0af01(0x23c)]['PAYMENT_REQUIRED']);}if(!_0xc25ea6[_0xc0af01(0x27d)]&&_0xc25ea6[_0x2c4502]<_0x38ab4b)throw new common_1['HttpException']('您的账户余额不足,如果想继续体验服务,请联系管理员\x20<VX:\x20'+_0xc71c50+_0xc0af01(0x216),common_1[_0xc0af01(0x23c)][_0xc0af01(0x249)]);return _0xc25ea6;}async[_0x22a66e(0x24c)](_0x3833fe,_0x1a95b3,_0x2e4110){const _0x3564a5=_0x22a66e,{id:_0x4a37de}=_0x3833fe[_0x3564a5(0x29d)],_0x5b471b=_0x1a95b3===_0x3564a5(0x228)?_0x3564a5(0x207):_0x1a95b3===_0x3564a5(0x21b)?_0x3564a5(0x213):_0x1a95b3===_0x3564a5(0x29b)?'drawMjCount':null,_0x3e9791=new Date(),_0x2489b4=await this[_0x3564a5(0x296)]['findOne']({'where':{'fingerprint':_0x4a37de}}),{visitorModel3Num:_0x1a96f4,visitorModel4Num:_0x59de07,visitorMJNum:_0x286e33}=await this[_0x3564a5(0x21c)][_0x3564a5(0x253)](['visitorModel3Num',_0x3564a5(0x265),_0x3564a5(0x29a)]),_0x3418a3={'model3Count':_0x1a96f4?Number(_0x1a96f4):0x0,'model4Count':_0x59de07?Number(_0x59de07):0x0,'drawMjCount':_0x286e33?Number(_0x286e33):0x0};if(!_0x2489b4){let _0x3f014b={'fingerprint':_0x4a37de,'model3Count':0x0,'model4Count':0x0,'drawMjCount':0x0};_0x3f014b[_0x5b471b]=_0x3f014b[_0x5b471b]+_0x2e4110;if(_0x3f014b[_0x5b471b]>_0x3418a3[_0x5b471b])throw new common_1[(_0x3564a5(0x1fb))](_0x3564a5(0x2b9),common_1[_0x3564a5(0x23c)][_0x3564a5(0x249)]);else return await this[_0x3564a5(0x296)][_0x3564a5(0x1f5)](_0x3f014b),!![];}else{const {model3Count:_0x473848,model4Count:_0x27b24f,drawMjCount:_0x3c8497}=_0x2489b4;let _0x188d15={'model3Count':_0x473848,'model4Count':_0x27b24f,'drawMjCount':_0x3c8497};const _0x1a4508=Number(new Date(_0x2489b4['updatedAt'])),_0x4f1d62=this[_0x3564a5(0x279)](_0x1a4508);_0x4f1d62?_0x188d15[_0x5b471b]=_0x188d15[_0x5b471b]+_0x2e4110:(_0x188d15={'model3Count':0x0,'model4Count':0x0,'drawMjCount':0x0},_0x188d15[_0x5b471b]=_0x188d15[_0x5b471b]+_0x2e4110);if(_0x188d15[_0x5b471b]>_0x3418a3[_0x5b471b])throw new common_1[(_0x3564a5(0x1fb))](_0x3564a5(0x2b9),common_1[_0x3564a5(0x23c)][_0x3564a5(0x249)]);else return await this[_0x3564a5(0x296)]['update']({'fingerprint':_0x4a37de},_0x188d15),!![];}}[_0x22a66e(0x279)](_0x385acd){const _0x565f1b=_0x22a66e,_0xf0d37=new Date(),_0x578011=new Date(_0xf0d37[_0x565f1b(0x25f)](),_0xf0d37[_0x565f1b(0x274)](),_0xf0d37[_0x565f1b(0x1fd)]());return _0x385acd>=_0x578011;}async[_0x22a66e(0x2b3)](_0x1e3e8e,_0xc87645,_0x3be0f9,_0x82c470=0x0){const _0x5f13e9=_0x22a66e,_0x2334f5=await this[_0x5f13e9(0x1f4)][_0x5f13e9(0x2b5)]({'where':{'userId':_0x1e3e8e}});if(!_0x2334f5)throw new common_1[(_0x5f13e9(0x1fb))](_0x5f13e9(0x2a9),common_1['HttpStatus'][_0x5f13e9(0x22b)]);const _0x94e32=_0xc87645===_0x5f13e9(0x228)?'memberModel3Count':_0xc87645===_0x5f13e9(0x21b)?_0x5f13e9(0x246):_0xc87645===_0x5f13e9(0x29b)?_0x5f13e9(0x259):null,_0x1b0e46=_0xc87645===_0x5f13e9(0x228)?_0x5f13e9(0x207):_0xc87645===_0x5f13e9(0x21b)?'model4Count':_0xc87645===_0x5f13e9(0x29b)?'drawMjCount':null,_0x492efb=_0x2334f5[_0x5f13e9(0x27d)]&&_0x2334f5[_0x94e32]<_0x3be0f9?_0x1b0e46:_0x2334f5[_0x5f13e9(0x27d)]?_0x94e32:_0x1b0e46;let _0xed029=null;_0x492efb['includes'](_0x5f13e9(0x289))&&(_0xed029=_0x5f13e9(0x234));_0x492efb[_0x5f13e9(0x211)](_0x5f13e9(0x2b4))&&(_0xed029=_0x5f13e9(0x282));_0x492efb[_0x5f13e9(0x211)](_0x5f13e9(0x256))&&(_0xed029='useDrawMjToken');const _0xf9aac9={[_0x492efb]:_0x2334f5[_0x492efb]-_0x3be0f9<0x0?0x0:_0x2334f5[_0x492efb]-_0x3be0f9,[_0xed029]:_0x2334f5[_0xed029]+_0x82c470};_0xed029==='useModel3Token'&&(_0xf9aac9['useModel3Count']=_0x2334f5['useModel3Count']+0x1),_0xed029===_0x5f13e9(0x282)&&(_0xf9aac9[_0x5f13e9(0x22e)]=_0x2334f5[_0x5f13e9(0x22e)]+0x1);const _0x22592e=await this[_0x5f13e9(0x1f4)][_0x5f13e9(0x27b)]({'userId':_0x1e3e8e},_0xf9aac9);if(_0x22592e['affected']===0x0)throw new common_1['HttpException']('消费余额失败！',common_1[_0x5f13e9(0x23c)][_0x5f13e9(0x22b)]);}async[_0x22a66e(0x280)](_0x4fccbe){const _0x2d09c2=_0x22a66e;try{const _0x47c529=await this[_0x2d09c2(0x1f4)][_0x2d09c2(0x2b5)]({'where':{'userId':_0x4fccbe},'select':[_0x2d09c2(0x27d),_0x2d09c2(0x207),_0x2d09c2(0x213),_0x2d09c2(0x2a4),_0x2d09c2(0x22a),_0x2d09c2(0x246),'memberDrawMjCount',_0x2d09c2(0x27f),_0x2d09c2(0x22e),_0x2d09c2(0x234),_0x2d09c2(0x282),'useDrawMjToken',_0x2d09c2(0x287)]});if(!_0x47c529){const _0x3ef4e9=await this[_0x2d09c2(0x24d)](_0x4fccbe);if(_0x3ef4e9)return await this[_0x2d09c2(0x280)](_0x4fccbe);else throw new common_1[(_0x2d09c2(0x1fb))](_0x2d09c2(0x27e),common_1[_0x2d09c2(0x23c)]['BAD_REQUEST']);}return _0x47c529['sumModel3Count']=_0x47c529['packageId']?_0x47c529['model3Count']+_0x47c529[_0x2d09c2(0x22a)]:_0x47c529[_0x2d09c2(0x207)],_0x47c529[_0x2d09c2(0x294)]=_0x47c529['packageId']?_0x47c529[_0x2d09c2(0x213)]+_0x47c529[_0x2d09c2(0x246)]:_0x47c529[_0x2d09c2(0x213)],_0x47c529[_0x2d09c2(0x268)]=_0x47c529[_0x2d09c2(0x27d)]?_0x47c529[_0x2d09c2(0x2a4)]+_0x47c529[_0x2d09c2(0x259)]:_0x47c529['drawMjCount'],_0x47c529[_0x2d09c2(0x287)]=_0x47c529[_0x2d09c2(0x287)]?(0x0,date_1['formatDate'])(_0x47c529[_0x2d09c2(0x287)],_0x2d09c2(0x225)):null,_0x47c529;}catch(_0x156677){console['log'](_0x2d09c2(0x28f),_0x156677);}}async['saveRecordRechargeLog'](_0x616ef){const _0x466be5=_0x22a66e,{userId:_0x4dfdab,rechargeType:_0x461b0b,model3Count:_0x45ee40,model4Count:_0x28f6d3,drawMjCount:_0x24986f,days:days=-0x1,pkgName:pkgName='',extent:extent=''}=_0x616ef;if(!_0x4dfdab)throw new common_1[(_0x466be5(0x1fb))](_0x466be5(0x264),common_1['HttpStatus']['BAD_REQUEST']);const _0x160875=(0x0,utils_1[_0x466be5(0x214)])();return await this[_0x466be5(0x2b2)][_0x466be5(0x1f5)]({'userId':_0x4dfdab,'rechargeType':_0x461b0b,'model3Count':_0x45ee40,'model4Count':_0x28f6d3,'drawMjCount':_0x24986f,'days':days,'extent':extent,'uid':_0x160875,'pkgName':pkgName});}async[_0x22a66e(0x24d)](_0x5b6d2e,_0x3912bf={}){const _0x1c47dc=_0x22a66e,{model3Count:model3Count=0x0,model4Count:model4Count=0x0,drawMjCount:drawMjCount=0x0}=_0x3912bf,_0x1853eb=await this[_0x1c47dc(0x1f4)]['findOne']({'where':{'userId':_0x5b6d2e}});if(_0x1853eb)throw new common_1[(_0x1c47dc(0x1fb))](_0x1c47dc(0x206),common_1['HttpStatus'][_0x1c47dc(0x22b)]);return await this[_0x1c47dc(0x1f4)][_0x1c47dc(0x1f5)]({'userId':_0x5b6d2e,'model3Count':model3Count,'model4Count':model4Count,'drawMjCount':drawMjCount});}async[_0x22a66e(0x22c)](_0x426b27,_0x40bf30,_0x46dcf4=-0x1){const _0xed2b54=_0x22a66e;try{const _0x37b4a8=await this[_0xed2b54(0x1f4)][_0xed2b54(0x2b5)]({'where':{'userId':_0x426b27}})||await this['createBaseUserBalance'](_0x426b27);if(!_0x37b4a8)throw new common_1[(_0xed2b54(0x1fb))]('查询用户账户信息失败！',common_1[_0xed2b54(0x23c)]['BAD_REQUEST']);const {model3Count:_0x1ad164,model4Count:_0x103f61,drawMjCount:_0x1086b4,memberModel3Count:_0x36d156,memberModel4Count:_0x1bb1d4,memberDrawMjCount:_0x78cfb1}=_0x37b4a8;let _0x4bddf6={};if(_0x46dcf4>0x0){const {packageId:_0x5013b2}=_0x40bf30;if(!_0x5013b2)throw new common_1['HttpException'](_0xed2b54(0x29e),common_1['HttpStatus'][_0xed2b54(0x22b)]);const _0x4892fd=await this[_0xed2b54(0x208)]['findOne']({'where':{'id':_0x5013b2}});if(!_0x4892fd)throw new common_1[(_0xed2b54(0x1fb))]('当前套餐不存在！',common_1[_0xed2b54(0x23c)]['BAD_REQUEST']);const {weight:_0x279249}=_0x4892fd;if(!_0x37b4a8[_0xed2b54(0x27d)])_0x4bddf6={'memberModel3Count':_0x1ad164+_0x40bf30[_0xed2b54(0x207)],'memberModel4Count':_0x103f61+_0x40bf30[_0xed2b54(0x213)],'memberDrawMjCount':_0x1086b4+_0x40bf30[_0xed2b54(0x2a4)],'expirationTime':(0x0,date_1[_0xed2b54(0x222)])()[_0xed2b54(0x28e)](_0x46dcf4>0x0?_0x46dcf4:0x0,_0xed2b54(0x1f9))[_0xed2b54(0x286)](_0xed2b54(0x297)),'packageId':_0x5013b2};else{const _0x36d121=await this[_0xed2b54(0x208)][_0xed2b54(0x2b5)]({'where':{'id':_0x37b4a8[_0xed2b54(0x27d)]}});_0x279249>=_0x36d121[_0xed2b54(0x260)]&&(_0x4bddf6={'memberModel3Count':_0x36d156+_0x40bf30[_0xed2b54(0x207)],'memberModel4Count':_0x1bb1d4+_0x40bf30[_0xed2b54(0x213)],'memberDrawMjCount':_0x78cfb1+_0x40bf30[_0xed2b54(0x2a4)],'expirationTime':(0x0,date_1['default'])(_0x37b4a8['expirationTime'])[_0xed2b54(0x28e)](_0x46dcf4>0x0?_0x46dcf4:0x0,_0xed2b54(0x1f9))['format']('YYYY-MM-DD\x20HH:mm:ss'),'packageId':_0x5013b2}),_0x279249<_0x36d121[_0xed2b54(0x260)]&&(_0x4bddf6={'memberModel3Count':_0x36d156+_0x40bf30[_0xed2b54(0x207)],'memberModel4Count':_0x1bb1d4+_0x40bf30[_0xed2b54(0x213)],'memberDrawMjCount':_0x78cfb1+_0x40bf30[_0xed2b54(0x2a4)]});}}_0x46dcf4<=0x0&&(_0x4bddf6={'model3Count':_0x1ad164+_0x40bf30['model3Count'],'model4Count':_0x103f61+_0x40bf30[_0xed2b54(0x213)],'drawMjCount':_0x1086b4+_0x40bf30['drawMjCount']});const _0x30cfad=await this[_0xed2b54(0x1f4)][_0xed2b54(0x27b)]({'userId':_0x426b27},_0x4bddf6);if(_0x30cfad['affected']===0x0)throw new common_1[(_0xed2b54(0x1fb))](_0x426b27+_0xed2b54(0x299),common_1['HttpStatus']['BAD_REQUEST']);}catch(_0xa3ce6f){console[_0xed2b54(0x2a5)](_0xed2b54(0x28f),_0xa3ce6f);throw new common_1[(_0xed2b54(0x1fb))]('用户充值失败！',common_1[_0xed2b54(0x23c)][_0xed2b54(0x22b)]);}}async[_0x22a66e(0x219)](_0x23a4ba){const _0x2cc6fd=_0x22a66e;console[_0x2cc6fd(0x2a5)](_0x2cc6fd(0x272),_0x23a4ba);try{const {userId:_0x340e5b,goodsId:_0x152b3d}=_0x23a4ba,_0x3753a0=await this[_0x2cc6fd(0x208)][_0x2cc6fd(0x2b5)]({'where':{'id':_0x23a4ba[_0x2cc6fd(0x278)],'status':0x1}});if(!_0x3753a0)throw new common_1[(_0x2cc6fd(0x1fb))](_0x2cc6fd(0x273),common_1[_0x2cc6fd(0x23c)][_0x2cc6fd(0x22b)]);const {model3Count:_0x4afd68,model4Count:_0x212f27,drawMjCount:_0x2ced6c,days:_0x2fd6b9,name:_0x4fdd91}=_0x3753a0,_0x23a2f6={'model3Count':_0x4afd68,'model4Count':_0x212f27,'drawMjCount':_0x2ced6c,'days':_0x2fd6b9,'packageId':_0x23a4ba[_0x2cc6fd(0x278)]};await this[_0x2cc6fd(0x22c)](_0x340e5b,_0x23a2f6,_0x2fd6b9),await this['saveRecordRechargeLog']({'userId':_0x340e5b,'rechargeType':balance_constant_1[_0x2cc6fd(0x203)][_0x2cc6fd(0x217)],'model3Count':_0x4afd68,'model4Count':_0x212f27,'drawMjCount':_0x2ced6c,'pkgName':_0x4fdd91,'days':_0x2fd6b9});const _0x3efdae=await this[_0x2cc6fd(0x26d)][_0x2cc6fd(0x2b5)]({'where':{'id':_0x340e5b}}),{invitedBy:_0x37aff7}=_0x3efdae;if(_0x37aff7){const _0x525958=await this[_0x2cc6fd(0x26d)][_0x2cc6fd(0x2b5)]({'where':{'inviteCode':_0x37aff7}}),_0x46046d=await this[_0x2cc6fd(0x2b1)][_0x2cc6fd(0x2b5)]({'where':{'userId':_0x525958['id']}});if(!_0x525958)return;const {id:_0x22c4d5}=_0x525958,{performanceRatio:_0x12d894}=_0x46046d,_0x594bb7={'inviterUserId':_0x22c4d5,'inviteeUserId':_0x340e5b,'orderId':_0x23a4ba['id'],'orderPrice':_0x23a4ba[_0x2cc6fd(0x2a6)],'commissionPercentage':_0x12d894,'commissionAmount':(_0x23a4ba[_0x2cc6fd(0x2a6)]*_0x12d894/0x64)['toFixed'](0x2)};await this[_0x2cc6fd(0x237)][_0x2cc6fd(0x23f)](_0x594bb7),await this['salesService'][_0x2cc6fd(0x251)](_0x22c4d5,_0x594bb7[_0x2cc6fd(0x2a7)]);}}catch(_0x60c0d2){console['log'](_0x2cc6fd(0x28f),_0x60c0d2);throw new common_1[(_0x2cc6fd(0x1fb))](_0x2cc6fd(0x20a),common_1[_0x2cc6fd(0x23c)][_0x2cc6fd(0x22b)]);}}async[_0x22a66e(0x20e)](_0x597390,_0x467fd8){const _0x1f7207=_0x22a66e,{page:page=0x1,size:size=0x14}=_0x467fd8,{id:_0x89b84b}=_0x597390[_0x1f7207(0x29d)],[_0x496563,_0x3d22fd]=await this[_0x1f7207(0x2b2)]['findAndCount']({'where':{'userId':_0x89b84b},'order':{'id':_0x1f7207(0x284)},'skip':(page-0x1)*size,'take':size});return _0x496563[_0x1f7207(0x2a2)](_0x2128c6=>{const _0xd486b9=_0x1f7207;_0x2128c6[_0xd486b9(0x22d)]=_0x2128c6[_0xd486b9(0x205)]>0x0?_0x2128c6[_0xd486b9(0x205)]+'天':'永久';}),{'rows':(0x0,date_1['formatCreateOrUpdateDate'])(_0x496563),'count':_0x3d22fd};}async[_0x22a66e(0x25e)](_0x4543e6,_0xf01575){const _0x4ac8c6=_0x22a66e;try{const {page:page=0x1,size:size=0xa,userId:_0x4437f3,rechargeType:_0x4c9809,packageId:_0x5ce411}=_0xf01575,{role:_0xf19175}=_0x4543e6[_0x4ac8c6(0x29d)],_0x3ff266={};_0x4c9809&&(_0x3ff266[_0x4ac8c6(0x2a3)]=_0x4c9809),_0x3ff266[_0x4ac8c6(0x28b)]=_0x4437f3||(0x0,typeorm_2[_0x4ac8c6(0x267)])(0x186a0),_0x5ce411&&(_0x3ff266[_0x4ac8c6(0x27d)]={'$like':'%'+_0x5ce411+'%'});const [_0x21525e,_0x32d67d]=await this['accountLogEntity'][_0x4ac8c6(0x28a)]({'where':_0x3ff266,'order':{'id':_0x4ac8c6(0x284)},'skip':(page-0x1)*size,'take':size}),_0x41ad8a=_0x21525e[_0x4ac8c6(0x298)](_0x2e3412=>_0x2e3412[_0x4ac8c6(0x28b)]),_0x505482=await this[_0x4ac8c6(0x26d)]['find']({'where':{'id':(0x0,typeorm_2['In'])(_0x41ad8a)}});return _0x21525e[_0x4ac8c6(0x2a2)](_0x2e2795=>{const _0x553900=_0x4ac8c6,_0x576ed0=_0x505482['find'](_0x3d3db9=>_0x3d3db9['id']===_0x2e2795[_0x553900(0x28b)]);_0x2e2795[_0x553900(0x288)]=_0x576ed0===null||_0x576ed0===void 0x0?void 0x0:_0x576ed0['username'],_0x2e2795[_0x553900(0x2af)]=_0x576ed0===null||_0x576ed0===void 0x0?void 0x0:_0x576ed0['email'],_0x2e2795['phone']=_0x576ed0===null||_0x576ed0===void 0x0?void 0x0:_0x576ed0[_0x553900(0x1fe)],_0x2e2795[_0x553900(0x215)]=_0x576ed0===null||_0x576ed0===void 0x0?void 0x0:_0x576ed0[_0x553900(0x215)],_0x2e2795[_0x553900(0x220)]=_0x576ed0===null||_0x576ed0===void 0x0?void 0x0:_0x576ed0[_0x553900(0x220)];}),_0xf19175!==_0x4ac8c6(0x229)&&_0x21525e[_0x4ac8c6(0x2a2)](_0x848083=>{const _0xfe8728=_0x4ac8c6;_0x848083[_0xfe8728(0x2af)]=_0x848083['email']?(0x0,utils_1[_0xfe8728(0x295)])(_0x848083['email']):'',_0x848083['phone']=_0x848083['phone']?(0x0,utils_1['hideString'])(_0x848083[_0xfe8728(0x1fe)]):'';}),{'rows':_0x21525e,'count':_0x32d67d};}catch(_0x34bd4a){console[_0x4ac8c6(0x2a5)](_0x4ac8c6(0x28f),_0x34bd4a);throw new common_1[(_0x4ac8c6(0x1fb))](_0x4ac8c6(0x244),common_1[_0x4ac8c6(0x23c)]['BAD_REQUEST']);}}async['queryUserBalanceByIds'](_0x58bc6c){const _0x3b30fd=_0x22a66e;return await this['userBalanceEntity'][_0x3b30fd(0x2b6)]({'where':{'userId':(0x0,typeorm_2['In'])(_0x58bc6c)}});}async[_0x22a66e(0x21a)](_0x43fc49,_0x4fa798){const _0x144b00=_0x22a66e,_0x5d18dc=await this[_0x144b00(0x1f4)]['findOne']({'where':{'id':_0x43fc49}});console[_0x144b00(0x2a5)](_0x144b00(0x238),_0x5d18dc);if(_0x5d18dc&&_0x5d18dc[_0x144b00(0x2a4)]>=_0x4fa798)_0x5d18dc[_0x144b00(0x2a4)]+=_0x4fa798,await this[_0x144b00(0x1f4)][_0x144b00(0x1f5)](_0x5d18dc);else throw new Error(_0x144b00(0x248));}async[_0x22a66e(0x26b)](){const _0x41347a=_0x22a66e,_0xcdcd20=await this[_0x41347a(0x26d)][_0x41347a(0x2b6)]();if(!_0xcdcd20[_0x41347a(0x28c)])return;const _0x5c94e7=await this['globalConfigService'][_0x41347a(0x253)](['upgradeStatus']);if(!_0x5c94e7)await this['globalConfigService']['setConfig']({'settings':[{'configKey':'upgradeStatus','configVal':'1'}]});else throw new common_1[(_0x41347a(0x1fb))](_0x41347a(0x20d),common_1[_0x41347a(0x23c)]['BAD_REQUEST']);_0xcdcd20[_0x41347a(0x2a2)](_0x1ecc9a=>{const _0xee7796=_0x41347a,{id:_0x3c8af4}=_0x1ecc9a;this['balanceEntity'][_0xee7796(0x2b5)]({'where':{'userId':_0x3c8af4}})['then'](_0x348d70=>{const _0x2cc57b=_0xee7796;if(!_0x348d70)return;this[_0x2cc57b(0x277)](_0x3c8af4,_0x348d70);});});}async[_0x22a66e(0x277)](_0x1b3b02,_0x69562){const _0x34ef60=_0x22a66e,{balance:balance=0x0,usesLeft:usesLeft=0x0,paintCount:paintCount=0x0,useTokens:useTokens=0x0,useChats:useChats=0x0,usePaints:usePaints=0x0}=_0x69562,_0x526334=await this[_0x34ef60(0x24f)]['findOne']({'where':{'userId':_0x1b3b02}}),_0x54441f={'userId':_0x1b3b02,'model3Count':Number(usesLeft),'model4Count':(_0x526334===null||_0x526334===void 0x0?void 0x0:_0x526334[_0x34ef60(0x233)])||0x0,'drawMjCount':Number(balance),'useModel3Count':Number(useChats),'useModel4Count':(_0x526334===null||_0x526334===void 0x0?void 0x0:_0x526334[_0x34ef60(0x291)])||0x0,'useDrawMjCount':Number(usePaints),'useModel3Token':Number(useTokens),'useModel4Token':0x0,'useDrawMjToken':0x0},_0x46f88a=await this['userBalanceEntity'][_0x34ef60(0x2b5)]({'where':{'userId':_0x1b3b02}});_0x46f88a?common_1[_0x34ef60(0x266)]['debug']('用户'+_0x1b3b02+_0x34ef60(0x27a),'BalanceService'):this['userBalanceEntity'][_0x34ef60(0x1f5)](_0x54441f)[_0x34ef60(0x224)](_0x1b2acd=>{const _0x1a5cfd=_0x34ef60;common_1[_0x1a5cfd(0x266)][_0x1a5cfd(0x201)]('用户'+_0x1b3b02+'旧账户信息迁移成功','BalanceService');})[_0x34ef60(0x26c)](_0x509bd3=>{const _0x1d2a24=_0x34ef60;console[_0x1d2a24(0x2a5)](_0x1d2a24(0x28f),_0x509bd3),common_1[_0x1d2a24(0x266)][_0x1d2a24(0x201)]('用户'+_0x1b3b02+_0x1d2a24(0x230),'BalanceService');});}async['inheritVisitorData'](_0x1a1389){const _0x5c53b1=_0x22a66e,{fingerprint:_0x44f272}=_0x1a1389[_0x5c53b1(0x292)],{id:_0x52116c}=_0x1a1389[_0x5c53b1(0x29d)];return await this[_0x5c53b1(0x1f8)][_0x5c53b1(0x27b)]({'userId':Number(_0x44f272)},{'userId':_0x52116c}),await this['chatGroupEntity'][_0x5c53b1(0x27b)]({'userId':Number(_0x44f272)},{'userId':_0x52116c}),await this[_0x5c53b1(0x2ac)]['update']({'userId':Number(_0x44f272)},{'userId':_0x52116c}),0x1;}async[_0x22a66e(0x21d)](_0x560a4){const _0x55d6d4=_0x22a66e,{fingerprint:_0x5c6116}=_0x560a4[_0x55d6d4(0x292)],_0x56da11=await this[_0x55d6d4(0x1f8)][_0x55d6d4(0x233)]({'where':{'userId':_0x5c6116}}),_0x1b6985=await this[_0x55d6d4(0x255)][_0x55d6d4(0x233)]({'where':{'userId':_0x5c6116}}),_0x45d16b=await this['midjourneyEntity']['count']({'where':{'userId':_0x5c6116}});return _0x56da11||_0x1b6985||_0x45d16b||0x0;}};UserBalanceService=__decorate([(0x0,common_1[_0x22a66e(0x200)])(),__param(0x0,(0x0,typeorm_1[_0x22a66e(0x23a)])(balance_entity_1['BalanceEntity'])),__param(0x1,(0x0,typeorm_1['InjectRepository'])(userBalance_entity_1[_0x22a66e(0x20b)])),__param(0x2,(0x0,typeorm_1[_0x22a66e(0x23a)])(accountLog_entity_1[_0x22a66e(0x290)])),__param(0x3,(0x0,typeorm_1['InjectRepository'])(cramiPackage_entity_1[_0x22a66e(0x25c)])),__param(0x4,(0x0,typeorm_1['InjectRepository'])(config_entity_1[_0x22a66e(0x1f6)])),__param(0x5,(0x0,typeorm_1[_0x22a66e(0x23a)])(user_entity_1[_0x22a66e(0x247)])),__param(0x6,(0x0,typeorm_1['InjectRepository'])(salesUsers_entity_1[_0x22a66e(0x2ae)])),__param(0x7,(0x0,typeorm_1['InjectRepository'])(whiteList_entity_1[_0x22a66e(0x235)])),__param(0x8,(0x0,typeorm_1['InjectRepository'])(fingerprint_entity_1[_0x22a66e(0x281)])),__param(0x9,(0x0,typeorm_1['InjectRepository'])(chatGroup_entity_1['ChatGroupEntity'])),__param(0xa,(0x0,typeorm_1['InjectRepository'])(chatLog_entity_1[_0x22a66e(0x2b0)])),__param(0xb,(0x0,typeorm_1[_0x22a66e(0x23a)])(midjourney_entity_1[_0x22a66e(0x226)])),__metadata(_0x22a66e(0x2a1),[typeorm_2[_0x22a66e(0x212)],typeorm_2['Repository'],typeorm_2[_0x22a66e(0x212)],typeorm_2[_0x22a66e(0x212)],typeorm_2[_0x22a66e(0x212)],typeorm_2[_0x22a66e(0x212)],typeorm_2['Repository'],typeorm_2[_0x22a66e(0x212)],typeorm_2[_0x22a66e(0x212)],typeorm_2[_0x22a66e(0x212)],typeorm_2['Repository'],typeorm_2[_0x22a66e(0x212)],sales_service_1['SalesService'],globalConfig_service_1[_0x22a66e(0x202)]])],UserBalanceService),exports[_0x22a66e(0x254)]=UserBalanceService;function _0x3ae6(){const _0xa474f3=['accountLogEntity','deductFromBalance','odel4','findOne','find','./../globalConfig/globalConfig.service','../midjourney/midjourney.entity','今日当前类型免费额度已经使用完毕、建议您注册账户体验更加完整的服务内容！','userBalanceEntity','save','ConfigEntity','registerSendModel3Count','chatLogEntity','day','invitedGuestSendModel4Count','HttpException','typeorm','getDate','phone','reduce','Injectable','debug','GlobalConfigService','RechargeType','1614846OOxfdx','days','当前用户无需创建账户信息！','model3Count','cramiPackageEntity','../crami/cramiPackage.entity','充值失败！','UserBalanceEntity','metadata','您已经升级过了、请勿重复操作！','getRechargeLog','../user/user.entity','function','includes','Repository','model4Count','createRandomUid','status','>\x20或购买专属套餐\x20！','SCAN_PAY','defineProperty','addBalanceToOrder','refundMjBalance','model4','globalConfigService','getVisitorCount','../globalConfig/config.entity','vxNumber','avatar','@nestjs/common','default','registerSendModel4Count','then','YYYY-MM-DD','MidjourneyEntity','configEntity','model3','super','memberModel3Count','BAD_REQUEST','addBalanceToUser','expireDateCn','useModel4Count','saveRecordRechargeLog','旧账户信息迁移失败','invitedGuestSendDrawMjCount','configVal','count','useModel3Token','WhiteListEntity','---','salesService','userBalance35342','./balance.entity','InjectRepository','invitedGuestSendModel3Count','HttpStatus','inviteGiveSendModel4Count','./accountLog.entity','createSalesRecords','__decorate','../sales/sales.service','visitor','../../common/constants/balance.constant','查询用户账户失败！','addBalanceToNewUser','memberModel4Count','UserEntity','User\x20not\x20found\x20or\x20insufficient\x20balance','PAYMENT_REQUIRED','../chatgpt/whiteList.entity','您的账户余额不足,如果想继续体验服务,请联系管理员\x20<VX:\x20','validateVisitorBalance','createBaseUserBalance','registerSendStatus','whiteListEntity','36156cbwrNX','saveCommissionAmount','884456hkSJxc','getConfigs','UserBalanceService','chatGroupEntity','MjCount','../../common/utils','firstRregisterSendModel4Count','memberDrawMjCount','30151490xIyugQ','isInteger','CramiPackageEntity','@nestjs/typeorm','getAccountLog','getFullYear','weight','364dzNrjt','注册赠送失败,请联系管理员！','930874lFDROr','当前用户不存在,记录充值日志异常','visitorModel4Num','Logger','LessThan','sumDrawMjCount','inviteSendStatus','firstRegisterSendStatus','upgradeBalance','catch','userEntity','registerSendDrawMjCount','__param','9WeBawU','__metadata','充值的工单信息:','非法操作、当前充值套餐暂不存在！','getMonth','decorate','getOwnPropertyDescriptor','writeOldBalanceToNewTable','goodsId','isUpdatedToday','账户信息已经存在、迁移无效','update','8617150hOaAFN','packageId','查询当前用户余额失败！','useModel3Count','queryUserBalance','FingerprintLogEntity','useModel4Token','../sales/salesUsers.entity','DESC','REFER_GIFT','format','expirationTime','username','odel3','findAndCount','userId','length','INVITE_GIFT','add','error:\x20','AccountLogEntity','useCount','headers','object','sumModel4Count','hideString','fingerprintLogEntity','YYYY-MM-DD\x20HH:mm:ss','map','充值失败','visitorMJNum','mjDraw','inviteGiveSendModel3Count','user','缺失当前套餐ID、充值失败！','inviteGiveSendDrawMjCount','35LMMgvp','design:paramtypes','forEach','rechargeType','drawMjCount','log','total','commissionAmount','firstRegisterSendRank','缺失当前用户账户记录！','firstRregisterSendDrawMjCount','9398544stKXgS','midjourneyEntity','../../common/utils/date','SalesUsersEntity','email','ChatLogEntity','salesUsersEntity'];_0x3ae6=function(){return _0xa474f3;};return _0x3ae6();}