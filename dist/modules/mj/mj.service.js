'use strict';const _0x196f17=_0x19c8;(function(_0x247cf3,_0x31d155){const _0xc1b614=_0x19c8,_0x3c6b55=_0x247cf3();while(!![]){try{const _0x5ca777=-parseInt(_0xc1b614(0x1bd))/0x1*(-parseInt(_0xc1b614(0x160))/0x2)+parseInt(_0xc1b614(0x1e7))/0x3*(-parseInt(_0xc1b614(0x19c))/0x4)+parseInt(_0xc1b614(0x1da))/0x5+parseInt(_0xc1b614(0x1f1))/0x6*(-parseInt(_0xc1b614(0x188))/0x7)+parseInt(_0xc1b614(0x201))/0x8*(-parseInt(_0xc1b614(0x1b5))/0x9)+-parseInt(_0xc1b614(0x172))/0xa*(-parseInt(_0xc1b614(0x1b6))/0xb)+parseInt(_0xc1b614(0x1c6))/0xc*(parseInt(_0xc1b614(0x1ec))/0xd);if(_0x5ca777===_0x31d155)break;else _0x3c6b55['push'](_0x3c6b55['shift']());}catch(_0xff7c2){_0x3c6b55['push'](_0x3c6b55['shift']());}}}(_0x3832,0x3156c));var __decorate=this&&this[_0x196f17(0x1f3)]||function(_0x570c05,_0x3d33ba,_0x5d8724,_0x48beee){const _0x50b010=_0x196f17;var _0x21c974=arguments[_0x50b010(0x202)],_0x3bf943=_0x21c974<0x3?_0x3d33ba:_0x48beee===null?_0x48beee=Object[_0x50b010(0x16f)](_0x3d33ba,_0x5d8724):_0x48beee,_0x4267ea;if(typeof Reflect===_0x50b010(0x1a5)&&typeof Reflect['decorate']===_0x50b010(0x157))_0x3bf943=Reflect[_0x50b010(0x1ca)](_0x570c05,_0x3d33ba,_0x5d8724,_0x48beee);else{for(var _0x151319=_0x570c05[_0x50b010(0x202)]-0x1;_0x151319>=0x0;_0x151319--)if(_0x4267ea=_0x570c05[_0x151319])_0x3bf943=(_0x21c974<0x3?_0x4267ea(_0x3bf943):_0x21c974>0x3?_0x4267ea(_0x3d33ba,_0x5d8724,_0x3bf943):_0x4267ea(_0x3d33ba,_0x5d8724))||_0x3bf943;}return _0x21c974>0x3&&_0x3bf943&&Object[_0x50b010(0x16b)](_0x3d33ba,_0x5d8724,_0x3bf943),_0x3bf943;},__metadata=this&&this[_0x196f17(0x1c4)]||function(_0x4a2aa2,_0x1ebebd){const _0x2d6680=_0x196f17;if(typeof Reflect===_0x2d6680(0x1a5)&&typeof Reflect[_0x2d6680(0x1a7)]===_0x2d6680(0x157))return Reflect[_0x2d6680(0x1a7)](_0x4a2aa2,_0x1ebebd);},__param=this&&this[_0x196f17(0x159)]||function(_0xf67eb4,_0x4aee87){return function(_0x2bf120,_0x382f8e){_0x4aee87(_0x2bf120,_0x382f8e,_0xf67eb4);};};Object[_0x196f17(0x16b)](exports,'__esModule',{'value':!![]}),exports['MjService']=void 0x0;const globalConfig_service_1=require(_0x196f17(0x179)),upload_service_1=require('./../upload/upload.service'),common_1=require(_0x196f17(0x1fb)),axios_1=require(_0x196f17(0x1d9)),chatLog_service_1=require(_0x196f17(0x153)),balance_constant_1=require(_0x196f17(0x1fe)),utils_1=require(_0x196f17(0x205)),chatLog_entity_1=require(_0x196f17(0x1d4)),typeorm_1=require(_0x196f17(0x1fd)),typeorm_2=require(_0x196f17(0x187)),balance_entity_1=require(_0x196f17(0x1e2)),fanyi_service_1=require(_0x196f17(0x1b4)),badwords_service_1=require(_0x196f17(0x18d));function _0x19c8(_0x43ecb3,_0x5abcd8){const _0x383243=_0x3832();return _0x19c8=function(_0x19c821,_0x4ab523){_0x19c821=_0x19c821-0x14f;let _0x2f4c90=_0x383243[_0x19c821];return _0x2f4c90;},_0x19c8(_0x43ecb3,_0x5abcd8);}function _0x3832(){const _0x15cd65=['本次放大图片的id:\x20','url','12280tOJdLE','https://discord.com/api/v9/interactions','getClientIp','uploadService','chatLogEntity','baiduFanyiAppId','checkFree','imagine','https://discord.com/api/v9/channels/','/messages?limit=50','replace','defineProperty','当前图片没有绘画信息、无法变体!','stringify','由于速率限制、当前普通用户限制为','getOwnPropertyDescriptor','放大当前图片失败','badwordsService','467620LxWNed','response','match','findCurrentPromptResult','Not','checkAuth','ChatLogService','./../globalConfig/globalConfig.service','开始请求放大图片\x20队列+1:\x20','mjChannelId','mjProxy','ChatLogEntity','历史记录中不存在当前图片、请确认您放大的图片是否存在','\x20队列+1:\x20','push','drawWorking','mjApplicationId','mjAuthorization','\x20次开始查询[变换图片]','开始轮询单张变换图片结果','super','@nestjs/typeorm','63NgcYKM','本次绘图耗时:\x20','网络连接失败，请稍后再试！','Injectable','upscaleSingleImg','../badwords/badwords.service','post','convertToEnglish','balanceEntity','绘画任务开始','mjSessionId','rateLimits','BalanceEntity','error','chaxun12','userId\x20=\x20:userId','saveChatLog','拿到了远程地址:\x20','removeEmoji','log','212404iqsJjO','draw','findOne','queryMessageList','enlarge','发送放大指令成功','axios:\x20','变化图片任务异常中断\x20队列-1:\x20','BAD_REQUEST','object','绘画请求失败、当前使用人数过多、请稍后试试吧、排队中...','metadata','error:\x20','message','当前提示词已经在任务队列中了、请勿重复提交。。。','getMjDefaultParams','历史中存在当前图片、直接获取！','mjDraw','本次比对的随机ID:\x20','查询期间出现错误：','当前绘图任务满载、请排队等候、队列任务完成后即可开始您的任务...','Repository','MjService','parse','../fanyi/fanyi.service','2412HumoQQ','11CSjGvT','HttpException','orderId','pollForVariationResult','queueCount','mjRateLimit','get','13Qsfsvj','秒请求一次、请合理使用！','BadwordsService','变换当前图片超时！','绘画失败','baiduFanyiSecret','max','__metadata','filter','2322984ArUXvM','pollForResult','execute','\x20次开始查询','decorate','Like','pollForUpscaleResult','有历史信息之间返回:\x20','findCurrentEnlargeImgResult','floor','axios\x20get:\x20','PAINT_TYPE','balance','开始查询绘画结果轮询','../chatLog/chatLog.entity','fanyiService','mjNotSaveImg','freeQueueUsers','DeductionKey','axios','1713675yBKrzH','sendSmInteractions','checkBadWords','data','globalConfigService','update','uploadFileFromUrl','test','../userBalance/balance.entity','find','variationId','getConfigs','mjVersion','18gHugaD','存入图片完成:\x20','放大图片任务结束\x20队列-1:\x20','您当前暂无MJ绘画余额！！！','substring','26ScwVto','checkRateLimit','default','now','user','156498FqdjfY','prompt','__decorate','chatLogService','InjectRepository','variationSingleImg','findCurrentVariationImgResult','message_id','当前用户\x20','sleep','@nestjs/common','放大custom_id:\x20','typeorm','../../common/constants/balance.constant','绘制图片任务结束\x20队列-1:\x20','sendDrawInteractions','3016ONqeLQ','length','includes','deductBalance','../../common/utils','randomId:\x20','绘制图片任务异常中断\x20队列-1:\x20','IsNull','发送绘画指令结果:\x20','../chatLog/chatLog.service','mjGuildId','HttpStatus','UploadService','function','当前图片没有绘画信息、无法放大!','__param','components','\x20次开始查询\x20=>\x20当前查询结果：','http://172.247.48.137:8000/mj/draw','extractContent'];_0x3832=function(){return _0x15cd65;};return _0x3832();}let MjService=class MjService{constructor(_0x20ea88,_0x364c77,_0x19e90e,_0x380e12,_0x218702,_0x23319b,_0x2cb4e2){const _0x5063f1=_0x196f17;this[_0x5063f1(0x164)]=_0x20ea88,this[_0x5063f1(0x190)]=_0x364c77,this['uploadService']=_0x19e90e,this[_0x5063f1(0x1f4)]=_0x380e12,this['globalConfigService']=_0x218702,this[_0x5063f1(0x1d5)]=_0x23319b,this[_0x5063f1(0x171)]=_0x2cb4e2,this['rateLimits']={},this[_0x5063f1(0x181)]=[],this['enlargeWorking']=[],this[_0x5063f1(0x1ba)]=0x0,this['freeQueueUsers']={};}async[_0x196f17(0x1ad)](_0x10c9fa){const _0x387802=_0x196f17,{jobId:_0x530767,prompt:_0x45778a,startTime:_0x602e43,userId:_0x581136}=_0x10c9fa;return console[_0x387802(0x19b)](_0x387802(0x191),'mjservice'),await new Promise(_0x487672=>setTimeout(_0x487672,0x1388)),{'a':0x1,'b':0x2};}async[_0x196f17(0x19d)](_0x5a1f82,_0x47f795){const _0x42c592=_0x196f17;await this[_0x42c592(0x177)](_0x47f795),await this[_0x42c592(0x171)][_0x42c592(0x1dc)](_0x5a1f82['prompt'],_0x47f795[_0x42c592(0x1f0)]['id']);const _0x1cc63d=_0x5a1f82[_0x42c592(0x1f2)];let _0x55a0f8=_0x5a1f82['prompt'];const {baiduFanyiAppId:_0x505189,baiduFanyiSecret:_0x104e69}=await this[_0x42c592(0x1de)][_0x42c592(0x1e5)]([_0x42c592(0x165),_0x42c592(0x1c2)]);_0x505189&&_0x104e69&&(_0x55a0f8=await this['fanyiService'][_0x42c592(0x18f)](_0x1cc63d));const _0x3126f9='['+(0x0,utils_1['createRandomUid'])()+']',_0x28b3c4=_0x3126f9+'\x20'+_0x55a0f8;console[_0x42c592(0x19b)](_0x42c592(0x14f),_0x3126f9),console[_0x42c592(0x19b)]('prompt\x20-------->\x20\x20',_0x28b3c4);const _0xc09e3=this[_0x42c592(0x181)][_0x42c592(0x1e3)](_0x53dd0b=>_0x53dd0b[_0x42c592(0x203)](_0x5a1f82[_0x42c592(0x1f2)]));if(_0xc09e3)throw new common_1['HttpException'](_0x42c592(0x1aa),common_1[_0x42c592(0x155)][_0x42c592(0x1a4)]);if(this[_0x42c592(0x1ba)]>=0x3)throw new common_1[(_0x42c592(0x1b7))]('当前绘图任务满载、请排队等候、队列任务完成后即可开始您的任务...',common_1[_0x42c592(0x155)][_0x42c592(0x1a4)]);await this[_0x42c592(0x1ed)](_0x47f795),this['queueCount']++,console[_0x42c592(0x19b)]('开始请求用户'+_0x47f795[_0x42c592(0x1f0)]['id']+_0x42c592(0x17f),this[_0x42c592(0x1ba)]);try{const _0x124b54=await this['chatLogEntity'][_0x42c592(0x1e3)]({'where':{'prompt':(0x0,typeorm_1[_0x42c592(0x1cb)])('%'+_0x28b3c4+'%')}}),_0x530a00=_0x124b54['map'](_0x1c11fc=>_0x1c11fc[_0x42c592(0x1f8)]);this[_0x42c592(0x181)][_0x42c592(0x180)](_0x28b3c4);let _0x355fd5;const _0x37f639=await this[_0x42c592(0x200)](_0x28b3c4,_0x530a00,_0x3126f9);_0x37f639?(console[_0x42c592(0x19b)](_0x42c592(0x1ac)),_0x355fd5=_0x37f639):_0x355fd5=await this[_0x42c592(0x1c7)](_0x28b3c4,_0x530a00,_0x3126f9);this[_0x42c592(0x1ba)]--,this[_0x42c592(0x1ba)]<0x0&&(this[_0x42c592(0x1ba)]=0x0),console[_0x42c592(0x19b)](_0x42c592(0x1ff),this[_0x42c592(0x1ba)]);const {id:_0xb2f2e9,content:_0x126151,channel_id:_0x4ddb31,attachments:attachments=[],timestamp:_0x29406a}=_0x355fd5;if(!attachments[_0x42c592(0x202)]||!attachments[0x0][_0x42c592(0x15f)])throw new common_1[(_0x42c592(0x1b7))](_0x42c592(0x1c1),common_1[_0x42c592(0x155)][_0x42c592(0x1a4)]);const {filename:_0x27eea0,url:_0x4b9017,width:_0x47d6b4,height:_0x23859c,size:_0x231c96}=attachments[0x0];console[_0x42c592(0x19b)](_0x42c592(0x199),_0x4b9017);const _0x1b9bfd=this['globalConfigService'][_0x42c592(0x1e5)]([_0x42c592(0x1d6)]);let _0x2652c9='';(!Number(_0x1b9bfd)||Number(_0x1b9bfd)===0x0)&&(_0x2652c9=await this[_0x42c592(0x163)]['uploadFileFromUrl']({'filename':_0x27eea0,'url':_0x4b9017}),console[_0x42c592(0x19b)](_0x42c592(0x1e8),_0x2652c9));const _0x19e4a5={'curIp':(0x0,utils_1[_0x42c592(0x162)])(_0x47f795),'userId':_0x47f795[_0x42c592(0x1f0)]['id'],'type':balance_constant_1[_0x42c592(0x1d8)][_0x42c592(0x1d1)],'prompt':_0x28b3c4,'answer':_0x2652c9,'model':'mj','extend':this[_0x42c592(0x19a)](JSON[_0x42c592(0x16d)](_0x355fd5)),'message_id':_0xb2f2e9,'variationId':_0xb2f2e9,'upscaleId':_0xb2f2e9,'group':0x1,'isSaveImg':!Number(_0x1b9bfd)||Number(_0x1b9bfd)===0x0,'fileInfo':JSON['stringify']({'width':_0x47d6b4,'height':_0x23859c,'size':_0x231c96,'filename':_0x27eea0,'cosUrl':_0x2652c9})};return await this['chatLogService'][_0x42c592(0x198)](_0x19e4a5),await this[_0x42c592(0x204)](_0x47f795),this[_0x42c592(0x181)]=this[_0x42c592(0x181)][_0x42c592(0x1c5)](_0x7d165c=>_0x7d165c!==_0x5a1f82[_0x42c592(0x1f2)]),_0x2652c9;}catch(_0x55d1d0){this[_0x42c592(0x1ba)]--,this[_0x42c592(0x1ba)]<0x0&&(this[_0x42c592(0x1ba)]=0x0),console[_0x42c592(0x19b)](_0x42c592(0x150),this['queueCount']),this[_0x42c592(0x181)]=this[_0x42c592(0x181)][_0x42c592(0x1c5)](_0x35d0ab=>_0x35d0ab!==_0x5a1f82[_0x42c592(0x1f2)]);throw new common_1[(_0x42c592(0x1b7))](_0x55d1d0['response'],common_1[_0x42c592(0x155)][_0x42c592(0x1a4)]);}}async[_0x196f17(0x18c)](_0x4e573a,_0x4fd718){const _0x1c16cd=_0x196f17;if(this['queueCount']>=0x3)throw new common_1['HttpException'](_0x1c16cd(0x1b0),common_1[_0x1c16cd(0x155)][_0x1c16cd(0x1a4)]);this[_0x1c16cd(0x1ba)]++,console[_0x1c16cd(0x19b)]('用户'+_0x4fd718[_0x1c16cd(0x1f0)]['id']+_0x1c16cd(0x17a),this[_0x1c16cd(0x1ba)]);const {message_id:_0x5313c3,orderId:_0x209434}=_0x4e573a;try{const _0x3af370=await this['chatLogEntity']['findOne']({'where':{'message_id':_0x5313c3}});if(!_0x3af370)throw new common_1[(_0x1c16cd(0x1b7))](_0x1c16cd(0x17e),common_1[_0x1c16cd(0x155)][_0x1c16cd(0x1a4)]);const _0x18a6bc=await this[_0x1c16cd(0x164)]['findOne']({'where':{'upscaleId':_0x5313c3,'action':'enlarge','orderId':_0x209434}});if(_0x18a6bc)throw new common_1[(_0x1c16cd(0x1b7))]('当前图片已经放大过了、请勿重复放大!',common_1[_0x1c16cd(0x155)][_0x1c16cd(0x1a4)]);const {prompt:_0x15965e,extend:_0x258023}=_0x3af370;let _0x731fd0=null;try{_0x731fd0=JSON[_0x1c16cd(0x1b3)](_0x258023);}catch(_0x5a2494){_0x731fd0=[];}const {components:components=[]}=_0x731fd0;if(!components[_0x1c16cd(0x202)])throw new common_1[(_0x1c16cd(0x1b7))](_0x1c16cd(0x158),common_1[_0x1c16cd(0x155)][_0x1c16cd(0x1a4)]);const _0x455e66=components[0x0][_0x1c16cd(0x15a)][_0x209434-0x1],{custom_id:_0x61940c}=_0x455e66;console[_0x1c16cd(0x19b)](_0x1c16cd(0x1fc),_0x61940c);const _0x34277b={'message_id':_0x5313c3,'custom_id':_0x61940c,'prompt':_0x15965e,'orderId':_0x209434};await this[_0x1c16cd(0x1db)](_0x34277b),console[_0x1c16cd(0x19b)](_0x1c16cd(0x1a1));const _0x512994=await this[_0x1c16cd(0x164)][_0x1c16cd(0x1e3)]({'where':{'prompt':(0x0,typeorm_1[_0x1c16cd(0x1cb)])('%'+_0x15965e+'%')}}),_0x57b572=_0x512994['map'](_0x398e2e=>_0x398e2e[_0x1c16cd(0x1f8)]);console['log']('历史这些id已经被获取过了\x20不能拿了:\x20',_0x57b572);const _0x53cba9=await this['pollForUpscaleResult'](_0x34277b,_0x57b572);this[_0x1c16cd(0x1ba)]--,this[_0x1c16cd(0x1ba)]<0x0&&(this[_0x1c16cd(0x1ba)]=0x0),console[_0x1c16cd(0x19b)](_0x1c16cd(0x1e9),this[_0x1c16cd(0x1ba)]);const {id:_0x4aed33,content:_0x39535b,channel_id:_0x46ecce,attachments:attachments=[],timestamp:_0x445f15}=_0x53cba9;if(!attachments['length']||!attachments[0x0][_0x1c16cd(0x15f)])throw new common_1[(_0x1c16cd(0x1b7))](_0x1c16cd(0x170),common_1[_0x1c16cd(0x155)][_0x1c16cd(0x1a4)]);const {filename:_0x2b42bb,url:_0x2aad6d,width:_0x379ac2,height:_0xc1917c,size:_0x1f2ef2}=attachments[0x0],_0x5844d7=this[_0x1c16cd(0x1de)]['getConfigs']([_0x1c16cd(0x1d6)]);let _0x12a63b='';(!Number(_0x5844d7)||Number(_0x5844d7)===0x0)&&(_0x12a63b=await this[_0x1c16cd(0x163)][_0x1c16cd(0x1e0)]({'filename':_0x2b42bb,'url':_0x2aad6d}),console['log'](_0x1c16cd(0x1e8),_0x12a63b));const _0x17ec20={'curIp':(0x0,utils_1[_0x1c16cd(0x162)])(_0x4fd718),'userId':_0x4fd718['user']['id'],'type':balance_constant_1[_0x1c16cd(0x1d8)]['PAINT_TYPE'],'prompt':_0x15965e,'answer':_0x12a63b,'model':'mj','extend':this['removeEmoji'](JSON[_0x1c16cd(0x16d)](_0x53cba9)),'message_id':_0x5313c3,'upscaleId':_0x4aed33,'variationId':_0x4aed33,'action':_0x1c16cd(0x1a0),'orderId':_0x34277b[_0x1c16cd(0x1b8)],'isSaveImg':!Number(_0x5844d7)||Number(_0x5844d7)===0x0,'fileInfo':JSON[_0x1c16cd(0x16d)]({'width':_0x379ac2,'height':_0xc1917c,'size':_0x1f2ef2,'filename':_0x2b42bb,'cosUrl':_0x12a63b})};return await this[_0x1c16cd(0x1f4)][_0x1c16cd(0x198)](_0x17ec20),_0x12a63b;}catch(_0x148cf5){console['log'](_0x1c16cd(0x1a8),_0x148cf5),this[_0x1c16cd(0x1ba)]--,this['queueCount']<0x0&&(this[_0x1c16cd(0x1ba)]=0x0),console[_0x1c16cd(0x19b)]('放大图片任务异常中断\x20队列-1:\x20',this[_0x1c16cd(0x1ba)]);throw new common_1['HttpException'](_0x148cf5[_0x1c16cd(0x173)],common_1[_0x1c16cd(0x155)][_0x1c16cd(0x1a4)]);}}async[_0x196f17(0x1f6)](_0x156f52,_0x13760b){const _0x2cec28=_0x196f17;if(this['queueCount']>=0x3)throw new common_1[(_0x2cec28(0x1b7))](_0x2cec28(0x1b0),common_1[_0x2cec28(0x155)]['BAD_REQUEST']);await this[_0x2cec28(0x177)](_0x13760b),await this['checkRateLimit'](_0x13760b),this[_0x2cec28(0x1ba)]++,console[_0x2cec28(0x19b)]('用户'+_0x13760b[_0x2cec28(0x1f0)]['id']+'开始请求变换图片\x20队列+1:\x20',this[_0x2cec28(0x1ba)]);const {message_id:_0x232616,orderId:_0xce52b0}=_0x156f52;try{const _0x238244=await this[_0x2cec28(0x164)][_0x2cec28(0x19e)]({'where':{'message_id':_0x232616}});if(!_0x238244)throw new common_1[(_0x2cec28(0x1b7))]('历史记录中不存在当前图片、请确认您需要变换的图片是否存在',common_1['HttpStatus'][_0x2cec28(0x1a4)]);const {prompt:_0x5c7169,extend:_0x39fc70}=_0x238244;let _0xd7a01c=null;try{_0xd7a01c=JSON[_0x2cec28(0x1b3)](_0x39fc70);}catch(_0x2dcbdf){_0xd7a01c=[];}const {components:components=[]}=_0xd7a01c;if(!components[_0x2cec28(0x202)])throw new common_1[(_0x2cec28(0x1b7))](_0x2cec28(0x16c),common_1[_0x2cec28(0x155)][_0x2cec28(0x1a4)]);const _0xd1091b=components[0x1][_0x2cec28(0x15a)][_0xce52b0-0x1],{custom_id:_0x5787e7}=_0xd1091b,_0x3c9a27=await this['chatLogEntity']['find']({'where':{'variationId':(0x0,typeorm_1[_0x2cec28(0x176)])((0x0,typeorm_1[_0x2cec28(0x151)])()),'prompt':(0x0,typeorm_1[_0x2cec28(0x1cb)])('%'+_0x5c7169+'%')}}),_0x338d2a=_0x3c9a27['map'](_0x131ee3=>_0x131ee3[_0x2cec28(0x1e4)]),_0x2e858c={'message_id':_0x232616,'custom_id':_0x5787e7,'prompt':_0x5c7169,'orderId':_0xce52b0};await this[_0x2cec28(0x1db)](_0x2e858c);const _0x5c9d99=await this[_0x2cec28(0x1b9)](_0x2e858c,_0x338d2a);this['queueCount']--,this[_0x2cec28(0x1ba)]<0x0&&(this['queueCount']=0x0),console[_0x2cec28(0x19b)]('变换图片任务结束\x20队列-1:\x20',this[_0x2cec28(0x1ba)]);const {id:_0x5af0be,content:_0x365a5f,channel_id:_0x537773,attachments:attachments=[],timestamp:_0x12b13b}=_0x5c9d99;if(!attachments['length']||!attachments[0x0][_0x2cec28(0x15f)])throw new common_1[(_0x2cec28(0x1b7))]('变换当前图片失败',common_1[_0x2cec28(0x155)][_0x2cec28(0x1a4)]);const {filename:_0x1d7ed1,url:_0x3640d3,width:_0x2a6de4,height:_0x34a150,size:_0x3e1fa4}=attachments[0x0],_0x458ed2=this[_0x2cec28(0x1de)][_0x2cec28(0x1e5)](['mjNotSaveImg']);let _0x17e015='';(!Number(_0x458ed2)||Number(_0x458ed2)===0x0)&&(_0x17e015=await this[_0x2cec28(0x163)][_0x2cec28(0x1e0)]({'filename':_0x1d7ed1,'url':_0x3640d3}),console[_0x2cec28(0x19b)]('存入图片完成:\x20',_0x17e015));const _0x66b9f6={'curIp':(0x0,utils_1[_0x2cec28(0x162)])(_0x13760b),'userId':_0x13760b[_0x2cec28(0x1f0)]['id'],'type':balance_constant_1[_0x2cec28(0x1d8)][_0x2cec28(0x1d1)],'prompt':_0x5c7169,'answer':_0x17e015,'model':'mj','group':0x1,'extend':this[_0x2cec28(0x19a)](JSON['stringify'](_0x5c9d99)),'message_id':_0x5af0be,'upscaleId':_0x5af0be,'variationId':_0x5af0be,'action':_0x2cec28(0x1a0),'orderId':_0x2e858c[_0x2cec28(0x1b8)],'isSaveImg':!Number(_0x458ed2)||Number(_0x458ed2)===0x0,'fileInfo':JSON[_0x2cec28(0x16d)]({'width':_0x2a6de4,'height':_0x34a150,'size':_0x3e1fa4,'filename':_0x1d7ed1,'cosUrl':_0x17e015})};return await this[_0x2cec28(0x1f4)][_0x2cec28(0x198)](_0x66b9f6),_0x17e015;}catch(_0x4e734f){console[_0x2cec28(0x19b)](_0x2cec28(0x1a8),_0x4e734f),this[_0x2cec28(0x1ba)]--,this[_0x2cec28(0x1ba)]<0x0&&(this[_0x2cec28(0x1ba)]=0x0),console[_0x2cec28(0x19b)](_0x2cec28(0x1a3),this['queueCount']);throw new common_1[(_0x2cec28(0x1b7))](_0x4e734f[_0x2cec28(0x173)],common_1[_0x2cec28(0x155)][_0x2cec28(0x1a4)]);}}async[_0x196f17(0x1db)](_0x1b1bac){const _0xd4b61=_0x196f17,{message_id:_0x3e6a0e,custom_id:_0x364dd3}=_0x1b1bac,{application_id:_0x1e1992,guild_id:_0x4dc422,channel_id:_0x5f2569,session_id:_0x28a352,version:_0x597807,id:_0x2e5763,authorization:_0x5d3fd2,mjProxy:_0x273c89}=await this[_0xd4b61(0x1ab)](),_0xe594fb=_0x273c89==0x1?_0xd4b61(0x15c):_0xd4b61(0x161),_0x1cc1a7={'authorization':_0x5d3fd2},_0x188179={'type':0x3,'guild_id':_0x4dc422,'channel_id':_0x5f2569,'message_flags':0x0,'message_id':_0x3e6a0e,'application_id':_0x1e1992,'session_id':_0x28a352,'data':{'component_type':0x2,'custom_id':_0x364dd3}};try{await axios_1[_0xd4b61(0x1ee)][_0xd4b61(0x18e)](_0xe594fb,_0x188179,{'headers':_0x1cc1a7}),console[_0xd4b61(0x19b)]('绘图指令完成');}catch(_0x1ed23f){console[_0xd4b61(0x19b)]('error:\x20',_0x1ed23f);throw new common_1[(_0xd4b61(0x1b7))]('放大单张图片请求失败...',common_1[_0xd4b61(0x155)][_0xd4b61(0x1a4)]);}}async[_0x196f17(0x1cc)](_0x18971f,_0x4b7895){const _0x317595=_0x196f17,{message_id:_0x5ed7c6,custom_id:_0x3eefd0,prompt:_0x20981b,orderId:_0x2e36a4}=_0x18971f;let _0x234e50=null,_0x148d05=0x0;while(!_0x234e50&&_0x148d05<0xa){try{const _0x339f7c=Date[_0x317595(0x1ef)](),_0x16120e=await this['queryMessageList']();console[_0x317595(0x19b)]('第\x20'+(_0x148d05+0x1)+_0x317595(0x15b)+_0x16120e[_0x317595(0x202)]);_0x16120e&&_0x16120e['length']&&(_0x234e50=await this[_0x317595(0x1ce)](_0x16120e,_0x18971f,_0x4b7895));const _0x4f558f=Date['now']()-_0x339f7c,_0x10b732=0xbb8;await this[_0x317595(0x1fa)](Math[_0x317595(0x1c3)](_0x10b732-_0x4f558f,0x0)),_0x148d05++;}catch(_0x228486){console[_0x317595(0x195)]('查询期间出现错误：'+_0x228486['message']);}}return _0x234e50;}async['pollForVariationResult'](_0x48d5a3,_0x3a4a0b){const _0x25b5b0=_0x196f17,{message_id:_0xcce3da,custom_id:_0x22e271,prompt:_0x3624ec,orderId:_0x214e9c}=_0x48d5a3;console[_0x25b5b0(0x19b)](_0x25b5b0(0x185));let _0x4ca8b5=null,_0x31a934=0x0;while(!_0x4ca8b5&&_0x31a934<0xa){try{console['log']('第\x20'+(_0x31a934+0x1)+_0x25b5b0(0x184));const _0x3be5c0=Date[_0x25b5b0(0x1ef)](),_0x3791c1=await this['queryMessageList']();_0x3791c1&&_0x3791c1[_0x25b5b0(0x202)]&&(_0x4ca8b5=await this[_0x25b5b0(0x1f7)](_0x3791c1,_0x48d5a3,_0x3a4a0b));const _0x5a2c48=Date[_0x25b5b0(0x1ef)]()-_0x3be5c0,_0x432f08=0x1f40;await this[_0x25b5b0(0x1fa)](Math[_0x25b5b0(0x1c3)](_0x432f08-_0x5a2c48,0x0)),_0x31a934++;}catch(_0x45aef3){console[_0x25b5b0(0x195)](_0x25b5b0(0x1af)+_0x45aef3['message']);}}if(!_0x4ca8b5)throw new common_1['HttpException'](_0x25b5b0(0x1c0),common_1[_0x25b5b0(0x155)][_0x25b5b0(0x1a4)]);return _0x4ca8b5;}async[_0x196f17(0x1ce)](_0xad81db,_0x80e863,_0x122c0f){const _0x7f8c5c=_0x196f17,{message_id:_0x12b818,custom_id:_0x29aba0,prompt:_0x38002a,orderId:_0x25ae60}=_0x80e863,_0x29ba83=_0x38002a[_0x7f8c5c(0x1eb)](0x0,0xc);console[_0x7f8c5c(0x19b)](_0x7f8c5c(0x15e),_0x29ba83);const _0x1ecbfd=_0xad81db[_0x7f8c5c(0x1e3)](_0x33e878=>{const _0x392189=_0x7f8c5c,{content:_0x277e53}=_0x33e878;if(!this[_0x392189(0x15d)](_0x277e53))return![];const {prompt:_0x1a8215,order:_0x1af92c}=this['extractContent'](_0x277e53);return _0x1a8215[_0x392189(0x203)](_0x29ba83)&&_0x80e863[_0x392189(0x1b8)]===_0x1af92c&&!_0x122c0f[_0x392189(0x203)](_0x33e878['id']);});return _0x1ecbfd;}async['findCurrentVariationImgResult'](_0xf91192,_0xb65d2,_0x32affb){const _0x100e81=_0x196f17,{message_id:_0x302f4d,custom_id:_0x55ebb5,prompt:_0x4a20f1,orderId:_0x5a229c}=_0xb65d2,_0x37bd39=_0x4a20f1[_0x100e81(0x1eb)](0x0,0xc),_0x4abd11=_0xf91192[_0x100e81(0x1e3)](_0x15f72b=>{const _0x1ac10f=_0x100e81,{content:_0x573d3f}=_0x15f72b,_0x31d2e4=_0x573d3f[_0x1ac10f(0x174)](/\*\*(.+?)\*\*/),_0xbee3a3=_0x31d2e4?_0x31d2e4[0x1]:'';if(!_0xbee3a3)return![];return _0xbee3a3[_0x1ac10f(0x203)](_0x37bd39)&&!_0x32affb[_0x1ac10f(0x203)](_0x15f72b['id']);});return _0x4abd11;}async[_0x196f17(0x200)](_0x4e8270,_0x4e0638,_0x4913ee){const _0x117e85=_0x196f17,_0x149bab=await this[_0x117e85(0x19f)](),_0xf0e6a8=await this['findCurrentPromptResult'](_0x149bab,_0x4913ee,_0x4e0638);if(_0xf0e6a8)return console[_0x117e85(0x19b)](_0x117e85(0x1cd),_0xf0e6a8),_0xf0e6a8;const {application_id:_0x117923,guild_id:_0x5ae86e,channel_id:_0x3a92eb,session_id:_0x1eb512,version:_0x26be61,id:_0x201437,authorization:_0x49ca14,mjProxy:_0x5221f2}=await this[_0x117e85(0x1ab)](),_0x595fc2={'type':0x2,'application_id':_0x117923,'guild_id':_0x5ae86e,'channel_id':_0x3a92eb,'session_id':_0x1eb512,'data':{'version':_0x26be61,'id':_0x201437,'name':_0x117e85(0x167),'type':0x1,'options':[{'type':0x3,'name':_0x117e85(0x1f2),'value':_0x4e8270}],'attachments':[]}};try{const _0x529e8f=_0x5221f2==0x1?_0x117e85(0x15c):_0x117e85(0x161),_0x2e2392={'authorization':_0x49ca14},_0x2d732c=await axios_1['default'][_0x117e85(0x18e)](_0x529e8f,_0x595fc2,{'headers':_0x2e2392});return console['log'](_0x117e85(0x152),_0x2d732c[_0x117e85(0x1dd)]),![];}catch(_0x3f7ea4){console[_0x117e85(0x19b)](_0x117e85(0x1a2),_0x3f7ea4);throw new common_1[(_0x117e85(0x1b7))](_0x117e85(0x1a6),common_1['HttpStatus'][_0x117e85(0x1a4)]);}}async[_0x196f17(0x1c7)](_0x3453e5,_0xf3357b,_0x1ea4bc){const _0x95aefa=_0x196f17;console[_0x95aefa(0x19b)](_0x95aefa(0x1d3));const _0x4312a6=Date[_0x95aefa(0x1ef)]();try{const _0x3a36f2=0xd,_0x1c68bc=0x2ee0,_0x4aef37=0x1388,_0x46932d=0x3c*0x3e8;let _0x34e139=0x0,_0x55ac39=![],_0x23c46b=null;while(!_0x23c46b&&_0x34e139<_0x3a36f2){console[_0x95aefa(0x19b)]('第\x20'+(_0x34e139+0x1)+_0x95aefa(0x1c9)),console['log'](_0x95aefa(0x196));Date[_0x95aefa(0x1ef)]()-_0x4312a6>=_0x46932d&&(_0x55ac39=!![]);await this[_0x95aefa(0x1fa)](_0x55ac39?_0x4aef37:_0x1c68bc);const _0x402621=await this[_0x95aefa(0x19f)]();_0x23c46b=await this[_0x95aefa(0x175)](_0x402621,_0x1ea4bc,_0xf3357b),_0x34e139++;}if(!_0x23c46b)throw new common_1[(_0x95aefa(0x1b7))]('绘画超时，请稍后再试！',common_1[_0x95aefa(0x155)][_0x95aefa(0x1a4)]);const _0x287ec=Date[_0x95aefa(0x1ef)]();return console[_0x95aefa(0x19b)](_0x95aefa(0x189)+Math[_0x95aefa(0x1cf)]((_0x287ec-_0x4312a6)/0x3e8)+'\x20S'),_0x23c46b;}catch(_0x283636){console[_0x95aefa(0x195)](_0x283636[_0x95aefa(0x1a9)]);throw new common_1[(_0x95aefa(0x1b7))](_0x95aefa(0x18a),common_1['HttpStatus']['INTERNAL_SERVER_ERROR']);}}async[_0x196f17(0x175)](_0x252ea1,_0xd283c6,_0x29e8ea){const _0x674302=_0x196f17;if(!_0x252ea1||!_0x252ea1['length'])return;console[_0x674302(0x19b)](_0x674302(0x1ae),_0xd283c6);const _0x3682a0=_0x252ea1[_0x674302(0x1e3)](_0x1a7db7=>{const _0x56b5f2=_0x674302,{attachments:attachments=[],content:_0x5c36ba,edited_timestamp:_0x577a92}=_0x1a7db7;return _0x5c36ba[_0x56b5f2(0x203)](_0xd283c6)&&attachments[_0x56b5f2(0x202)]>0x0&&!_0x577a92&&!_0x29e8ea[_0x56b5f2(0x203)](_0x1a7db7['id']);});return _0x3682a0||null;}async[_0x196f17(0x19f)](){const _0x291ef2=_0x196f17;try{const {application_id:_0xc5412b,guild_id:_0x68b5c4,channel_id:_0x5b5de7,session_id:_0x46fa26,version:_0x1550ec,id:_0x2c27ac,authorization:_0x80bb90,mjProxy:_0x15827d}=await this[_0x291ef2(0x1ab)](),_0x4bbf5f=_0x15827d==0x1?'http://172.247.48.137:8000/mj/list?channel_id='+_0x5b5de7:_0x291ef2(0x168)+_0x5b5de7+_0x291ef2(0x169),_0x4e7655={'authorization':_0x80bb90},_0x249d06=await axios_1[_0x291ef2(0x1ee)][_0x291ef2(0x1bc)](_0x4bbf5f,{'headers':_0x4e7655});return _0x249d06[_0x291ef2(0x1dd)];}catch(_0x5b1e45){console[_0x291ef2(0x19b)](_0x291ef2(0x1d0),_0x5b1e45);throw new common_1[(_0x291ef2(0x1b7))]('查询绘制结果失败...',common_1[_0x291ef2(0x155)][_0x291ef2(0x1a4)]);}}async[_0x196f17(0x1fa)](_0x441e4e){return new Promise(_0x3b6fc8=>setTimeout(_0x3b6fc8,_0x441e4e));}[_0x196f17(0x15d)](_0x367173){const _0x1f9c8=_0x196f17,_0x3ade15=_0x367173[_0x1f9c8(0x174)](/\*\*(.+?)\*\*/),_0x334d87=_0x367173[_0x1f9c8(0x174)](/- Image #(\d+)/);if(!_0x3ade15||!_0x334d87)return null;const _0x3c6bb3=_0x3ade15[0x1],_0x2cc75e=parseInt(_0x334d87[0x1]);return{'prompt':_0x3c6bb3,'order':_0x2cc75e};}async[_0x196f17(0x1ab)](){const _0x494c47=_0x196f17,_0x404caf=await this[_0x494c47(0x1de)][_0x494c47(0x1e5)](['mjId',_0x494c47(0x182),_0x494c47(0x154),_0x494c47(0x17b),_0x494c47(0x192),'mjVersion',_0x494c47(0x183),_0x494c47(0x1bb),_0x494c47(0x17c)]),_0x4f6747={'application_id':_0x404caf['mjApplicationId'],'guild_id':_0x404caf['mjGuildId'],'channel_id':_0x404caf[_0x494c47(0x17b)],'session_id':_0x404caf['mjSessionId'],'version':_0x404caf[_0x494c47(0x1e6)],'id':_0x404caf['mjId'],'authorization':_0x404caf[_0x494c47(0x183)],'mjRateLimit':_0x404caf[_0x494c47(0x1bb)],'mjProxy':_0x404caf[_0x494c47(0x17c)]||0x0};return _0x4f6747;}[_0x196f17(0x19a)](_0x3acf59){const _0x58189c=_0x196f17,_0x3f1d25=/[\uD800-\uDBFF][\uDC00-\uDFFF]/g;return _0x3acf59[_0x58189c(0x16a)](_0x3f1d25,'');}async[_0x196f17(0x177)](_0x112491){const _0x38aaaa=_0x196f17,_0x3f6bda=await this['balanceEntity'][_0x38aaaa(0x19e)]({'where':{'userId':_0x112491[_0x38aaaa(0x1f0)]['id']}}),{id:_0x3ad94c,balance:_0x16d5e4}=_0x3f6bda;if(!_0x16d5e4||(_0x3f6bda===null||_0x3f6bda===void 0x0?void 0x0:_0x3f6bda[_0x38aaaa(0x1d2)])<0x1)throw new common_1[(_0x38aaaa(0x1b7))](_0x38aaaa(0x1ea),common_1[_0x38aaaa(0x155)][_0x38aaaa(0x1a4)]);}async[_0x196f17(0x166)](_0x201b12){const _0x27ac85=_0x196f17,{id:_0x27bdb3,role:_0x1c876b}=_0x201b12[_0x27ac85(0x1f0)];!this[_0x27ac85(0x1d7)][_0x27bdb3]?this[_0x27ac85(0x1d7)][_0x27bdb3]=0x1:this['freeQueueUsers'][_0x27bdb3]=this['freeQueueUsers'][_0x27bdb3]+0x1,console[_0x27ac85(0x19b)]('当前用户'+_0x27bdb3+'使用的次数：',this[_0x27ac85(0x1d7)][_0x27bdb3]);}async[_0x196f17(0x1ed)](_0x37c53e){const _0x18eec6=_0x196f17,{id:_0x53e5c4,role:_0x7bcf3c}=_0x37c53e['user'];if(['admin',_0x18eec6(0x186)][_0x18eec6(0x203)](_0x7bcf3c))return!![];const {mjRateLimit:_0x2e2ae4}=await this['getMjDefaultParams']();if(this['rateLimits'][_0x53e5c4]){const _0x179a8a=this[_0x18eec6(0x193)][_0x53e5c4];if(_0x179a8a>Date[_0x18eec6(0x1ef)]()){console['log'](_0x18eec6(0x1f9)+_0x53e5c4+'\x20请求过于频繁！');throw new common_1[(_0x18eec6(0x1b7))](_0x18eec6(0x16e)+_0x2e2ae4+_0x18eec6(0x1be),common_1['HttpStatus'][_0x18eec6(0x1a4)]);}else this[_0x18eec6(0x193)][_0x53e5c4]=Date[_0x18eec6(0x1ef)]()+Number(_0x2e2ae4)*0x3e8;}else{const _0x59101d=Date[_0x18eec6(0x1ef)]();this[_0x18eec6(0x193)][_0x53e5c4]=_0x59101d+0x3e8*Number(_0x2e2ae4);}}async[_0x196f17(0x204)](_0x2241a9){const _0x344a72=_0x196f17;await this[_0x344a72(0x190)]['createQueryBuilder']()[_0x344a72(0x1df)](balance_entity_1[_0x344a72(0x194)])['set']({'balance':()=>'balance\x20-\x201'})['where'](_0x344a72(0x197),{'userId':_0x2241a9['user']['id']})[_0x344a72(0x1c8)]();}async[_0x196f17(0x1e1)](){return 0x1;}};MjService=__decorate([(0x0,common_1[_0x196f17(0x18b)])(),__param(0x0,(0x0,typeorm_2['InjectRepository'])(chatLog_entity_1[_0x196f17(0x17d)])),__param(0x1,(0x0,typeorm_2[_0x196f17(0x1f5)])(balance_entity_1['BalanceEntity'])),__metadata('design:paramtypes',[typeorm_1[_0x196f17(0x1b1)],typeorm_1[_0x196f17(0x1b1)],upload_service_1[_0x196f17(0x156)],chatLog_service_1[_0x196f17(0x178)],globalConfig_service_1['GlobalConfigService'],fanyi_service_1['FanyiService'],badwords_service_1[_0x196f17(0x1bf)]])],MjService),exports[_0x196f17(0x1b2)]=MjService;