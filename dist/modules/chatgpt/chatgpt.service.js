'use strict';const _0x28c2d6=_0x325f;(function(_0x2a690a,_0xe165c9){const _0x41dd2f=_0x325f,_0x324195=_0x2a690a();while(!![]){try{const _0x4e72be=-parseInt(_0x41dd2f(0x221))/0x1*(parseInt(_0x41dd2f(0x282))/0x2)+parseInt(_0x41dd2f(0x251))/0x3*(-parseInt(_0x41dd2f(0x1f7))/0x4)+parseInt(_0x41dd2f(0x1d0))/0x5*(parseInt(_0x41dd2f(0x264))/0x6)+-parseInt(_0x41dd2f(0x201))/0x7+parseInt(_0x41dd2f(0x220))/0x8+-parseInt(_0x41dd2f(0x296))/0x9*(parseInt(_0x41dd2f(0x2c7))/0xa)+parseInt(_0x41dd2f(0x246))/0xb;if(_0x4e72be===_0xe165c9)break;else _0x324195['push'](_0x324195['shift']());}catch(_0x4ccd95){_0x324195['push'](_0x324195['shift']());}}}(_0xe5ff,0x91185));var __decorate=this&&this[_0x28c2d6(0x22d)]||function(_0x107923,_0x33eeab,_0x148d2b,_0x1a643b){const _0x5e84b8=_0x28c2d6;var _0x57ade8=arguments[_0x5e84b8(0x28f)],_0x4cb054=_0x57ade8<0x3?_0x33eeab:_0x1a643b===null?_0x1a643b=Object[_0x5e84b8(0x267)](_0x33eeab,_0x148d2b):_0x1a643b,_0x3c53fd;if(typeof Reflect===_0x5e84b8(0x1ca)&&typeof Reflect['decorate']===_0x5e84b8(0x239))_0x4cb054=Reflect[_0x5e84b8(0x222)](_0x107923,_0x33eeab,_0x148d2b,_0x1a643b);else{for(var _0x2cdd20=_0x107923[_0x5e84b8(0x28f)]-0x1;_0x2cdd20>=0x0;_0x2cdd20--)if(_0x3c53fd=_0x107923[_0x2cdd20])_0x4cb054=(_0x57ade8<0x3?_0x3c53fd(_0x4cb054):_0x57ade8>0x3?_0x3c53fd(_0x33eeab,_0x148d2b,_0x4cb054):_0x3c53fd(_0x33eeab,_0x148d2b))||_0x4cb054;}return _0x57ade8>0x3&&_0x4cb054&&Object['defineProperty'](_0x33eeab,_0x148d2b,_0x4cb054),_0x4cb054;},__metadata=this&&this['__metadata']||function(_0x4c04b8,_0x1a0e40){const _0x27246b=_0x28c2d6;if(typeof Reflect===_0x27246b(0x1ca)&&typeof Reflect[_0x27246b(0x20a)]===_0x27246b(0x239))return Reflect[_0x27246b(0x20a)](_0x4c04b8,_0x1a0e40);},__param=this&&this[_0x28c2d6(0x2b9)]||function(_0x3c7703,_0xcdf2b0){return function(_0x5673a7,_0x3e132b){_0xcdf2b0(_0x5673a7,_0x3e132b,_0x3c7703);};};Object[_0x28c2d6(0x1db)](exports,_0x28c2d6(0x2c3),{'value':!![]}),exports[_0x28c2d6(0x1cb)]=void 0x0;const upload_service_1=require('./../upload/upload.service'),user_service_1=require('./../user/user.service'),nestjs_config_1=require('nestjs-config'),common_1=require(_0x28c2d6(0x24b)),errorMessage_constant_1=require('../../common/constants/errorMessage.constant'),utils_1=require(_0x28c2d6(0x271)),axios_1=require(_0x28c2d6(0x1cc)),userBalance_service_1=require(_0x28c2d6(0x1f4)),balance_constant_1=require(_0x28c2d6(0x228)),chatLog_service_1=require(_0x28c2d6(0x252)),uuid=require(_0x28c2d6(0x1f3)),config_entity_1=require('../globalConfig/config.entity'),typeorm_1=require(_0x28c2d6(0x1dd)),typeorm_2=require(_0x28c2d6(0x1d8)),badwords_service_1=require(_0x28c2d6(0x26d)),autoreply_service_1=require(_0x28c2d6(0x28b)),gptkeys_entity_1=require(_0x28c2d6(0x263)),globalConfig_service_1=require(_0x28c2d6(0x1d4)),fanyi_service_1=require(_0x28c2d6(0x27d)),app_entity_1=require(_0x28c2d6(0x1d2)),chatGroup_service_1=require(_0x28c2d6(0x1ce)),models_service_1=require(_0x28c2d6(0x29f)),baidu_1=require('./baidu'),helper_1=require(_0x28c2d6(0x27e)),store_1=require(_0x28c2d6(0x2c6)),zhipu_1=require(_0x28c2d6(0x254)),openai_1=require(_0x28c2d6(0x287)),chatBoxType_entity_1=require(_0x28c2d6(0x1e9)),chatBox_entity_1=require('./chatBox.entity'),chatPre_entity_1=require(_0x28c2d6(0x218)),chatPreType_entity_1=require(_0x28c2d6(0x22a));let ChatgptService=class ChatgptService{constructor(_0x249e0d,_0x364b5d,_0x4ba7d3,_0x26604d,_0x31a9c4,_0x298745,_0x1e33aa,_0x20b1dc,_0x318f30,_0xf8bcb8,_0x1e3b72,_0x312d81,_0x588684,_0x5af7f1,_0x5740d6,_0x38e24f,_0x5981b2,_0x2abce6){const _0x499779=_0x28c2d6;this[_0x499779(0x2b1)]=_0x249e0d,this[_0x499779(0x238)]=_0x364b5d,this[_0x499779(0x2bf)]=_0x4ba7d3,this[_0x499779(0x243)]=_0x26604d,this[_0x499779(0x2a0)]=_0x31a9c4,this[_0x499779(0x261)]=_0x298745,this[_0x499779(0x20e)]=_0x1e33aa,this['configService']=_0x20b1dc,this['userBalanceService']=_0x318f30,this['chatLogService']=_0xf8bcb8,this['userService']=_0x1e3b72,this[_0x499779(0x291)]=_0x312d81,this[_0x499779(0x2b4)]=_0x588684,this[_0x499779(0x2c9)]=_0x5af7f1,this[_0x499779(0x274)]=_0x5740d6,this[_0x499779(0x2c1)]=_0x38e24f,this[_0x499779(0x244)]=_0x5981b2,this[_0x499779(0x1f0)]=_0x2abce6,this[_0x499779(0x23b)]=null,this[_0x499779(0x2ad)]=[],this['keyPool']={'list3':[],'list4':[]};}async[_0x28c2d6(0x23d)](){const _0x264a76=_0x28c2d6;let _0x2cacb5=await(0x0,utils_1[_0x264a76(0x225)])(_0x264a76(0x27f)),_0x2b0dc1=await(0x0,utils_1[_0x264a76(0x225)])(_0x264a76(0x1f5)),_0x178be4=await(0x0,utils_1[_0x264a76(0x225)])(_0x264a76(0x269));_0x2cacb5=(_0x2cacb5===null||_0x2cacb5===void 0x0?void 0x0:_0x2cacb5[_0x264a76(0x21d)])?_0x2cacb5[_0x264a76(0x21d)]:_0x2cacb5,_0x2b0dc1=(_0x2b0dc1===null||_0x2b0dc1===void 0x0?void 0x0:_0x2b0dc1[_0x264a76(0x21d)])?_0x2b0dc1[_0x264a76(0x21d)]:_0x2b0dc1,_0x178be4=(_0x178be4===null||_0x178be4===void 0x0?void 0x0:_0x178be4[_0x264a76(0x21d)])?_0x178be4[_0x264a76(0x21d)]:_0x178be4;const {ChatGPTAPI:_0x65d40c,ChatGPTError:_0x23a4dc,ChatGPTUnofficialProxyAPI:_0x57ff4c}=_0x2cacb5,_0xd9955d=+process[_0x264a76(0x279)][_0x264a76(0x281)],_0x4c2b2a=process[_0x264a76(0x279)]['REDIS_HOST'],_0x290ed2=process[_0x264a76(0x279)][_0x264a76(0x292)],_0x3083b5=process[_0x264a76(0x279)]['REDIS_USER'],_0x5863ca=_0x264a76(0x1c3)+(_0x3083b5||'')+':'+(_0x290ed2||'')+'@'+_0x4c2b2a+':'+_0xd9955d,_0x56fab2=new _0x2b0dc1(_0x5863ca),_0x5ca018=new _0x178be4({'store':_0x56fab2,'namespace':_0x264a76(0x253)});this[_0x264a76(0x23b)]=new store_1[(_0x264a76(0x266))]({'store':_0x5ca018,'namespace':_0x264a76(0x233)});}async[_0x28c2d6(0x25e)](_0x5a2ad9,_0xe05bf4,_0x234979,_0x1dbce7=null){const _0x16b6e2=_0x28c2d6;var _0x418d72;!_0x1dbce7&&(_0x1dbce7=(_0x418d72=await this[_0x16b6e2(0x1f0)]['getBaseConfig']())===null||_0x418d72===void 0x0?void 0x0:_0x418d72[_0x16b6e2(0x260)]);const {timeout:timeout=0x3c}=_0x234979,{topN:_0x516284,model:_0x26a0a8}=_0x1dbce7,{parentMessageId:parentMessageId=0x0}=_0x5a2ad9,_0x1fd803=await this[_0x16b6e2(0x274)][_0x16b6e2(0x1e5)]([_0x16b6e2(0x240)]),_0x3948c4=timeout*0x3e8||_0x1fd803||0x64*0x3e8,_0x23df9a={'parentMessageId':parentMessageId,'timeoutMs':+_0x3948c4,'completionParams':{'model':_0x26a0a8,'temperature':_0x516284}};return _0xe05bf4&&(_0x23df9a['systemMessage']=_0xe05bf4),_0x23df9a;}async[_0x28c2d6(0x289)](_0x1c5adb){const _0x2fcc81=_0x28c2d6,_0x129acb=await this[_0x2fcc81(0x1f0)][_0x2fcc81(0x2cb)](),_0x344c8e=await this[_0x2fcc81(0x274)]['getConfigs']([_0x2fcc81(0x24a)]),{maxModelTokens:maxModelTokens=0x1f40,maxResponseTokens:maxResponseTokens=0x1000,key:_0x249d91,model:_0x4f7440}=_0x129acb,_0x5f5692=await this['getModelProxyUrl'](_0x129acb),{context:_0x2cd81a}=await this[_0x2fcc81(0x23b)][_0x2fcc81(0x1c5)](_0x1c5adb,{'parentMessageId':'','systemMessage':_0x344c8e});try{const _0xea8a20=await(0x0,openai_1['sendMessageFromOpenAi'])(_0x2cd81a,{'apiKey':(0x0,utils_1[_0x2fcc81(0x2b3)])(_0x249d91),'model':_0x4f7440,'proxyUrl':_0x5f5692,'onProgress':null});return _0xea8a20===null||_0xea8a20===void 0x0?void 0x0:_0xea8a20[_0x2fcc81(0x1d1)];}catch(_0x4b8dc1){console['log']('error:\x20',_0x4b8dc1);}}async['chatProcess'](_0x94b15e,_0x20c9c1,_0x84a9ce){const _0x31b6a9=_0x28c2d6;var _0x196d02,_0x530453,_0x5fd054;const _0x52b63b=_0x20c9c1[_0x31b6a9(0x276)],{options:options={},appId:_0x3dadab,cusromPrompt:_0x48fd71,systemMessage:systemMessage='',imgsup:imgsup='[]'}=_0x94b15e;let _0xa5bdd0=systemMessage;const {parentMessageId:_0x525eec}=options,{prompt:_0x3f15db}=_0x94b15e,{groupId:_0x3506f4,usingNetwork:_0x532b64,usingduomo:_0x310e20}=options,_0x31588a=await this[_0x31b6a9(0x244)][_0x31b6a9(0x245)](_0x3506f4),_0x5bbdf4=(_0x31588a===null||_0x31588a===void 0x0?void 0x0:_0x31588a['config'])?JSON['parse'](_0x31588a[_0x31b6a9(0x2bc)]):await this[_0x31b6a9(0x1f0)][_0x31b6a9(0x1bf)](),{keyType:_0x1e55c7,model:_0x16d437,modelName:_0x12c9f1,modeltopN:_0xea6e78,systemMessage:_0x1c2b96,rounds:_0x235715}=_0x5bbdf4[_0x31b6a9(0x260)];let _0x2d3366=null;!_0x48fd71?(console['log'](_0x31b6a9(0x2c8),_0x16d437),_0x2d3366=await this[_0x31b6a9(0x1f0)]['getCurrentModelKeyInfo'](_0x16d437,_0x12c9f1)):_0x2d3366=await this[_0x31b6a9(0x1f0)][_0x31b6a9(0x2cb)]();if(!_0x2d3366)throw new common_1[(_0x31b6a9(0x286))](_0x31b6a9(0x200),common_1[_0x31b6a9(0x241)][_0x31b6a9(0x1c0)]);const {deduct:_0x17ac16,deductType:_0x107a6a,key:_0x27e168,secret:_0x3f4d8d,id:_0x5a6528,accessToken:_0x1de523}=_0x2d3366;await this[_0x31b6a9(0x1d7)][_0x31b6a9(0x22e)](_0x20c9c1[_0x31b6a9(0x2be)]),await this[_0x31b6a9(0x1e4)][_0x31b6a9(0x217)](_0x20c9c1,_0x107a6a===0x1?_0x31b6a9(0x29d):_0x31b6a9(0x2bd),_0x17ac16),_0x84a9ce&&_0x84a9ce['setHeader'](_0x31b6a9(0x26f),_0x31b6a9(0x1c6)),await this[_0x31b6a9(0x2b4)][_0x31b6a9(0x1e7)](_0x3f15db,_0x20c9c1[_0x31b6a9(0x2be)]['id']);const _0x4ddf4e=await this[_0x31b6a9(0x2c9)][_0x31b6a9(0x20b)](_0x3f15db);if(_0x4ddf4e&&_0x84a9ce){const _0x57938e={'message':_0x4ddf4e,'code':0x1f4};return _0x84a9ce[_0x31b6a9(0x247)](JSON['stringify'](_0x57938e)),_0x84a9ce['end']();}if(_0x3dadab){const _0x2f3712=await this[_0x31b6a9(0x2a0)][_0x31b6a9(0x22c)]({'where':{'id':_0x3dadab,'status':(0x0,typeorm_1['In'])([0x1,0x3,0x4,0x5])}});if(!_0x2f3712)throw new common_1['HttpException'](_0x31b6a9(0x2ae),common_1[_0x31b6a9(0x241)][_0x31b6a9(0x1c0)]);_0x2f3712[_0x31b6a9(0x2c5)]&&(_0xa5bdd0=_0x2f3712[_0x31b6a9(0x2c5)]);}else{if(_0x48fd71)_0xa5bdd0=systemMessage;else{if(_0x1c2b96)_0xa5bdd0=_0x1c2b96;else{const _0x1269a7=new Date()[_0x31b6a9(0x1d6)]()['split']('T')[0x0],_0x515e38=await this[_0x31b6a9(0x274)][_0x31b6a9(0x1e5)]([_0x31b6a9(0x24a)]);_0xa5bdd0=_0x515e38+(_0x31b6a9(0x1c4)+_0x1269a7);}}}let _0x3c1845='';if(_0x532b64){_0x3c1845=await(0x0,utils_1[_0x31b6a9(0x29c)])(_0x3f15db);const _0xf1db8a=new Date()[_0x31b6a9(0x1d6)]()[_0x31b6a9(0x1fb)]('T')[0x0],_0x4eb20a=await this[_0x31b6a9(0x274)][_0x31b6a9(0x1e5)](['systemPreMessage']);_0xa5bdd0=_0x4eb20a+(_0x31b6a9(0x1c4)+_0xf1db8a);}const _0x10bd7f=await this[_0x31b6a9(0x25e)](options,_0xa5bdd0,_0x2d3366,_0x5bbdf4[_0x31b6a9(0x260)]),{maxModelTokens:maxModelTokens=0x1f40,maxResponseTokens:maxResponseTokens=0x1000,key:_0x9a7602}=_0x2d3366;_0x84a9ce&&_0x84a9ce[_0x31b6a9(0x1fc)](0xc8);let _0x26ac0d=null,_0x2838d8=null;console[_0x31b6a9(0x23e)](0x78c969eb5);try{if(_0x84a9ce){let _0x2309a5=null,_0x2a413f=![];_0x84a9ce['on']('close',async()=>{const _0x13548b=_0x31b6a9;if(_0x2a413f)return;_0x52b63b[_0x13548b(0x27b)]();const _0x5a46fa=await(0x0,openai_1['getTokenCount'])(_0x3f15db)||0x0,_0x402e46=await(0x0,openai_1[_0x13548b(0x295)])(_0x2309a5===null||_0x2309a5===void 0x0?void 0x0:_0x2309a5['text'])||0x0,_0x35cb99=_0x5a46fa+_0x402e46,_0x564f46=(0x0,utils_1[_0x13548b(0x249)])(_0x20c9c1);await this[_0x13548b(0x2b2)][_0x13548b(0x2a3)]({'appId':_0x3dadab,'curIp':_0x564f46,'userId':_0x20c9c1['user']['id'],'type':balance_constant_1[_0x13548b(0x1d9)][_0x13548b(0x1e0)],'prompt':_0x3f15db,'answer':'','promptTokens':_0x5a46fa,'completionTokens':0x0,'totalTokens':_0x5a46fa,'model':_0x16d437,'role':_0x13548b(0x2be),'groupId':_0x3506f4,'requestOptions':JSON[_0x13548b(0x273)]({'options':null,'prompt':_0x3f15db})}),await this[_0x13548b(0x2b2)][_0x13548b(0x2a3)]({'appId':_0x3dadab,'curIp':_0x564f46,'userId':_0x20c9c1[_0x13548b(0x2be)]['id'],'type':balance_constant_1[_0x13548b(0x1d9)][_0x13548b(0x1e0)],'prompt':_0x3f15db,'answer':_0x2309a5===null||_0x2309a5===void 0x0?void 0x0:_0x2309a5['text'],'promptTokens':_0x5a46fa,'completionTokens':_0x402e46,'totalTokens':_0x35cb99,'model':_0x16d437,'role':_0x13548b(0x1f1),'groupId':_0x3506f4,'requestOptions':JSON['stringify']({'options':{'model':_0x16d437,'temperature':_0xea6e78},'prompt':_0x3f15db}),'conversationOptions':JSON['stringify']({'conversationId':_0x2309a5===null||_0x2309a5===void 0x0?void 0x0:_0x2309a5['conversationId'],'model':_0x16d437,'parentMessageId':_0x2309a5===null||_0x2309a5===void 0x0?void 0x0:_0x2309a5['id'],'temperature':_0xea6e78})}),await this[_0x13548b(0x1e4)][_0x13548b(0x21b)](_0x20c9c1[_0x13548b(0x2be)]['id'],'model'+(_0x107a6a===0x1?0x3:0x4),_0x17ac16,_0x35cb99);});if(Number(_0x1e55c7)===0x1){const {key:_0x58e28f,maxToken:_0x49b70a,maxTokenRes:_0x24b4c0,proxyResUrl:_0x21f834}=await this[_0x31b6a9(0x29e)](_0x2d3366),{parentMessageId:_0xf97d1b,completionParams:_0x292a0f,systemMessage:_0x3355c7}=_0x10bd7f,{model:_0x176be1,temperature:_0xe24699}=_0x292a0f,{context:_0x77e998}=await this['nineStore'][_0x31b6a9(0x1c5)](_0x532b64?_0x3c1845:_0x3f15db,{'parentMessageId':_0xf97d1b,'systemMessage':_0x3355c7,'maxModelToken':_0x49b70a,'maxResponseTokens':_0x24b4c0,'maxRounds':(0x0,helper_1[_0x31b6a9(0x21a)])(_0x235715)});let _0x34b273=!![],_0x3fe787=JSON[_0x31b6a9(0x248)](imgsup);_0x176be1===_0x31b6a9(0x25f)&&_0x3fe787['length']>0x0&&(_0x3fe787=await(0x0,openai_1[_0x31b6a9(0x1fd)])(_0x3fe787)),_0x26ac0d=await(0x0,openai_1['sendMessageFromOpenAi'])(_0x77e998,{'maxToken':_0x49b70a,'maxTokenRes':_0x24b4c0,'apiKey':_0x27e168,'model':_0x176be1,'temperature':_0xe24699,'proxyUrl':_0x21f834,'onProgress':_0x2e7c40=>{const _0x13551d=_0x31b6a9;_0x84a9ce['write'](_0x34b273?JSON[_0x13551d(0x273)](_0x2e7c40):'\x0a'+JSON[_0x13551d(0x273)](_0x2e7c40)),_0x2309a5=_0x2e7c40,_0x34b273=![];},'imgsup3':_0x3fe787}),_0x2a413f=!![];}if(Number(_0x1e55c7)===0x2){let _0x51637b=!![];const {context:_0x4ce637}=await this[_0x31b6a9(0x23b)][_0x31b6a9(0x1c5)](_0x532b64?_0x3c1845:_0x3f15db,{'parentMessageId':_0x525eec,'maxRounds':(0x0,helper_1[_0x31b6a9(0x21a)])(_0x235715)});_0x26ac0d=await(0x0,baidu_1['sendMessageFromBaidu'])(_0x532b64?_0x3c1845:_0x4ce637,{'temperature':_0xea6e78,'accessToken':_0x1de523,'model':_0x16d437,'onProgress':_0x13c48c=>{const _0x1202e3=_0x31b6a9;_0x84a9ce[_0x1202e3(0x247)](_0x51637b?JSON[_0x1202e3(0x273)](_0x13c48c):'\x0a'+JSON[_0x1202e3(0x273)](_0x13c48c)),_0x51637b=![],_0x2309a5=_0x13c48c;}}),_0x2a413f=!![];}if(Number(_0x1e55c7)===0x3){let _0x257be7=!![];const {context:_0x1fc3bd}=await this['nineStore']['buildMessageFromParentMessageId'](_0x532b64?_0x3c1845:_0x3f15db,{'parentMessageId':_0x525eec,'maxRounds':(0x0,helper_1['addOneIfOdd'])(_0x235715)});_0x26ac0d=await(0x0,zhipu_1[_0x31b6a9(0x290)])(_0x532b64?_0x3c1845:_0x1fc3bd,{'temperature':_0xea6e78,'key':_0x9a7602,'model':_0x16d437,'onProgress':_0x24708f=>{const _0x219b17=_0x31b6a9;_0x84a9ce['write'](_0x257be7?JSON['stringify'](_0x24708f):'\x0a'+JSON[_0x219b17(0x273)](_0x24708f)),_0x257be7=![],_0x2309a5=_0x24708f;}}),_0x2a413f=!![];}const _0x13f13b={'id':this[_0x31b6a9(0x23b)][_0x31b6a9(0x285)](),'text':_0x3f15db,'role':_0x31b6a9(0x2be),'name':undefined,'usage':null,'parentMessageId':_0x525eec,'conversationId':_0x26ac0d===null||_0x26ac0d===void 0x0?void 0x0:_0x26ac0d[_0x31b6a9(0x1ea)]};_0x2838d8={'model':_0x16d437,'parentMessageId':_0x525eec},await this[_0x31b6a9(0x23b)][_0x31b6a9(0x223)](_0x13f13b);const _0x49f710={'id':_0x26ac0d['id'],'text':_0x26ac0d[_0x31b6a9(0x1d1)],'role':_0x31b6a9(0x1f1),'name':undefined,'usage':_0x26ac0d['usage'],'parentMessageId':_0x13f13b['id'],'conversationId':_0x26ac0d===null||_0x26ac0d===void 0x0?void 0x0:_0x26ac0d['conversationId']};await this['nineStore'][_0x31b6a9(0x223)](_0x49f710),_0x2838d8={'model':_0x16d437,'parentMessageId':_0x13f13b['id']};}else{const {key:_0x5cc94e,maxToken:_0x4eb2bd,maxTokenRes:_0x32aca9,proxyResUrl:_0x290b40}=await this[_0x31b6a9(0x29e)](_0x2d3366),{parentMessageId:_0x2c96df,completionParams:_0x1110d3,systemMessage:_0x5dfe32}=_0x10bd7f,{model:_0xd59dd4,temperature:_0x89bbe3}=_0x1110d3,{context:_0x4011bc}=await this[_0x31b6a9(0x23b)][_0x31b6a9(0x1c5)](_0x532b64?_0x3c1845:_0x3f15db,{'parentMessageId':_0x2c96df,'systemMessage':_0x5dfe32,'maxRounds':(0x0,helper_1[_0x31b6a9(0x21a)])(_0x235715)});_0x26ac0d=await(0x0,openai_1['sendMessageFromOpenAi'])(_0x4011bc,{'apiKey':_0x27e168,'model':_0xd59dd4,'temperature':_0x89bbe3,'proxyUrl':_0x290b40,'onProgress':null});}const _0x443c51=await(0x0,helper_1['unifiedFormattingResponse'])(_0x1e55c7,_0x26ac0d,_0x2838d8),{prompt_tokens:prompt_tokens=0x0,completion_tokens:completion_tokens=0x0,total_tokens:total_tokens=0x0}=_0x443c51[_0x31b6a9(0x26b)];await this[_0x31b6a9(0x1e4)][_0x31b6a9(0x21b)](_0x20c9c1[_0x31b6a9(0x2be)]['id'],'model'+(_0x107a6a===0x1?0x3:0x4),_0x17ac16,total_tokens),await this['modelsService'][_0x31b6a9(0x24d)](_0x5a6528,total_tokens);const _0x25bc8f=(0x0,utils_1[_0x31b6a9(0x249)])(_0x20c9c1);await this[_0x31b6a9(0x2b2)]['saveChatLog']({'appId':_0x3dadab,'curIp':_0x25bc8f,'userId':_0x20c9c1[_0x31b6a9(0x2be)]['id'],'type':balance_constant_1['DeductionKey']['CHAT_TYPE'],'prompt':_0x3f15db,'answer':'','promptTokens':prompt_tokens,'completionTokens':0x0,'totalTokens':total_tokens,'model':_0x443c51[_0x31b6a9(0x2c8)],'role':_0x31b6a9(0x2be),'groupId':_0x3506f4,'requestOptions':JSON[_0x31b6a9(0x273)]({'options':null,'prompt':_0x3f15db})}),await this['chatLogService']['saveChatLog']({'appId':_0x3dadab,'curIp':_0x25bc8f,'userId':_0x20c9c1[_0x31b6a9(0x2be)]['id'],'type':balance_constant_1['DeductionKey'][_0x31b6a9(0x1e0)],'prompt':_0x3f15db,'answer':_0x443c51===null||_0x443c51===void 0x0?void 0x0:_0x443c51['text'],'promptTokens':prompt_tokens,'completionTokens':completion_tokens,'totalTokens':total_tokens,'model':_0x16d437,'role':'assistant','groupId':_0x3506f4,'requestOptions':JSON[_0x31b6a9(0x273)]({'options':{'model':_0x16d437,'temperature':_0xea6e78},'prompt':_0x3f15db}),'conversationOptions':JSON['stringify']({'conversationId':_0x26ac0d[_0x31b6a9(0x1ea)],'model':_0x16d437,'parentMessageId':_0x26ac0d['id'],'temperature':_0xea6e78})}),common_1[_0x31b6a9(0x280)]['debug'](_0x31b6a9(0x29a)+_0x20c9c1[_0x31b6a9(0x2be)]['id']+'\x20model:\x20'+_0x16d437+_0x31b6a9(0x277)+_0x9a7602+_0x31b6a9(0x1c2)+_0x12c9f1+_0x31b6a9(0x2aa)+maxResponseTokens,_0x31b6a9(0x1cb));const _0x3bdb98=await this['userBalanceService'][_0x31b6a9(0x229)](_0x20c9c1['user']['id']);return _0x26ac0d[_0x31b6a9(0x235)]=Object[_0x31b6a9(0x297)]({},_0x3bdb98),_0x26ac0d[_0x31b6a9(0x2b6)]&&(_0x26ac0d['result']=''),_0x26ac0d[_0x31b6a9(0x250)]=!![],_0x84a9ce?_0x84a9ce[_0x31b6a9(0x247)]('\x0a'+JSON[_0x31b6a9(0x273)](_0x26ac0d)):_0x26ac0d[_0x31b6a9(0x1d1)];}catch(_0x2c7b3e){console[_0x31b6a9(0x23e)]('chat-error\x20<----------------------------------------->',_0x27e168,_0x2c7b3e);const _0x1ced14=(_0x2c7b3e===null||_0x2c7b3e===void 0x0?void 0x0:_0x2c7b3e[_0x31b6a9(0x25c)])||0x190,_0x205735=((_0x196d02=_0x2c7b3e===null||_0x2c7b3e===void 0x0?void 0x0:_0x2c7b3e[_0x31b6a9(0x2a2)])===null||_0x196d02===void 0x0?void 0x0:_0x196d02['status'])||(_0x2c7b3e===null||_0x2c7b3e===void 0x0?void 0x0:_0x2c7b3e['statusCode'])||0x190;console['log'](_0x31b6a9(0x25d),_0x31b6a9(0x1cf),_0x1ced14,_0x31b6a9(0x2b0),_0x2c7b3e===null||_0x2c7b3e===void 0x0?void 0x0:_0x2c7b3e[_0x31b6a9(0x2b0)],_0x31b6a9(0x294),(_0x530453=_0x2c7b3e===null||_0x2c7b3e===void 0x0?void 0x0:_0x2c7b3e[_0x31b6a9(0x2a2)])===null||_0x530453===void 0x0?void 0x0:_0x530453[_0x31b6a9(0x1e1)],_0x31b6a9(0x1fc),(_0x5fd054=_0x2c7b3e===null||_0x2c7b3e===void 0x0?void 0x0:_0x2c7b3e[_0x31b6a9(0x2a2)])===null||_0x5fd054===void 0x0?void 0x0:_0x5fd054[_0x31b6a9(0x1fc)]);if(_0x2c7b3e[_0x31b6a9(0x1fc)]&&_0x2c7b3e[_0x31b6a9(0x1fc)]===0x192){const _0x59d194={'message':_0x31b6a9(0x2a4)+_0x2c7b3e['message'],'code':0x192};if(_0x84a9ce)return _0x84a9ce[_0x31b6a9(0x247)](JSON[_0x31b6a9(0x273)](_0x59d194));else throw new common_1[(_0x31b6a9(0x286))](_0x2c7b3e[_0x31b6a9(0x2b0)],common_1['HttpStatus'][_0x31b6a9(0x2a8)]);}if(!_0x205735){if(_0x84a9ce)return _0x84a9ce[_0x31b6a9(0x247)](JSON['stringify']({'message':_0x2c7b3e['message'],'code':0x1f4}));else throw new common_1[(_0x31b6a9(0x286))](_0x2c7b3e['message'],common_1[_0x31b6a9(0x241)][_0x31b6a9(0x1c0)]);}let _0x42fc74=errorMessage_constant_1[_0x31b6a9(0x1ff)][_0x205735]?errorMessage_constant_1[_0x31b6a9(0x1ff)][_0x205735]:_0x31b6a9(0x257);(_0x2c7b3e===null||_0x2c7b3e===void 0x0?void 0x0:_0x2c7b3e[_0x31b6a9(0x2b0)][_0x31b6a9(0x1fa)](_0x31b6a9(0x1cd)))&&Number(_0x1e55c7)===0x1&&(await this[_0x31b6a9(0x1f0)][_0x31b6a9(0x265)](_0x5a6528,_0x31b6a9(0x24c),-0x1),_0x42fc74='当前模型key已被封禁');(_0x2c7b3e===null||_0x2c7b3e===void 0x0?void 0x0:_0x2c7b3e[_0x31b6a9(0x25c)])===0x1ad&&_0x2c7b3e[_0x31b6a9(0x2b0)][_0x31b6a9(0x1fa)](_0x31b6a9(0x20c))&&Number(_0x1e55c7)===0x1&&(await this[_0x31b6a9(0x1f0)]['lockKey'](_0x5a6528,_0x31b6a9(0x208),-0x3),_0x42fc74='当前模型key余额已耗尽');(_0x2c7b3e===null||_0x2c7b3e===void 0x0?void 0x0:_0x2c7b3e[_0x31b6a9(0x25c)])===0x1ad&&(_0x2c7b3e===null||_0x2c7b3e===void 0x0?void 0x0:_0x2c7b3e[_0x31b6a9(0x1e1)])===_0x31b6a9(0x1ee)&&(_0x42fc74=_0x31b6a9(0x1ef));(_0x2c7b3e===null||_0x2c7b3e===void 0x0?void 0x0:_0x2c7b3e[_0x31b6a9(0x25c)])===0x191&&_0x2c7b3e[_0x31b6a9(0x2b0)][_0x31b6a9(0x1fa)](_0x31b6a9(0x1d3))&&Number(_0x1e55c7)===0x1&&(await this[_0x31b6a9(0x1f0)]['lockKey'](_0x5a6528,_0x31b6a9(0x2bb),-0x2),_0x42fc74=_0x31b6a9(0x22b));(_0x2c7b3e===null||_0x2c7b3e===void 0x0?void 0x0:_0x2c7b3e[_0x31b6a9(0x25c)])===0x194&&_0x2c7b3e[_0x31b6a9(0x2b0)]['includes']('This\x20is\x20not\x20a\x20chat\x20model\x20and\x20thus\x20not\x20supported')&&Number(_0x1e55c7)===0x1&&(await this[_0x31b6a9(0x1f0)][_0x31b6a9(0x265)](_0x5a6528,'当前模型不是聊天模型',-0x4),_0x42fc74=_0x31b6a9(0x26e));_0x1ced14===0x190&&console[_0x31b6a9(0x23e)](_0x31b6a9(0x2b8),_0x2c7b3e,_0x2c7b3e['message']);const _0x12c328={'message':_0x42fc74||'Please\x20check\x20the\x20back-end\x20console','code':_0x1ced14===0x191?0x190:_0x1ced14||0x1f4};if(_0x84a9ce)return _0x84a9ce['write'](JSON[_0x31b6a9(0x273)](_0x12c328));else throw new common_1[(_0x31b6a9(0x286))](_0x12c328[_0x31b6a9(0x2b0)],common_1[_0x31b6a9(0x241)]['BAD_REQUEST']);}finally{_0x84a9ce&&_0x84a9ce['end']();}}async[_0x28c2d6(0x27c)](_0x58ca96,_0x5007b1){const _0x500153=_0x28c2d6;var _0x32a7e3,_0x24c38f,_0x1b25f9,_0x4db6c7;await this[_0x500153(0x2b4)][_0x500153(0x1e7)](_0x58ca96[_0x500153(0x23c)],_0x5007b1[_0x500153(0x2be)]['id']),await this['userService']['checkUserStatus'](_0x5007b1[_0x500153(0x2be)]);const _0x49bf11=(_0x58ca96===null||_0x58ca96===void 0x0?void 0x0:_0x58ca96[_0x500153(0x1e3)])===_0x500153(0x2b7)?0x2:0x4;await this[_0x500153(0x1e4)]['validateBalance'](_0x5007b1,_0x500153(0x270),_0x49bf11);let _0x4053de=[];const _0x4b60df=await this['modelsService'][_0x500153(0x2cb)](),_0x433727=_0x4b60df===null||_0x4b60df===void 0x0?void 0x0:_0x4b60df['id'],{key:_0x546f71,proxyResUrl:_0x220019}=await this[_0x500153(0x29e)](_0x4b60df);common_1[_0x500153(0x280)][_0x500153(0x23e)](_0x500153(0x2a7)+_0x58ca96[_0x500153(0x23c)]+_0x500153(0x1fe)+_0x546f71,_0x500153(0x28d));try{const _0x52c678=_0x220019+_0x500153(0x232),_0x1968a5=Object[_0x500153(0x297)](Object['assign']({},_0x58ca96),{'model':'dall-e-3'});console['log'](_0x500153(0x288),_0x1968a5);const _0x568379=await axios_1[_0x500153(0x21d)][_0x500153(0x2a9)](_0x52c678,Object[_0x500153(0x297)](Object[_0x500153(0x297)]({},_0x1968a5),{'response_format':_0x500153(0x1dc)}),{'headers':{'Authorization':_0x500153(0x275)+_0x546f71}});_0x4053de=_0x568379[_0x500153(0x205)][_0x500153(0x205)],console[_0x500153(0x23e)]('imges',_0x4053de);const _0x3aa1a5=[];for(const _0x873d0b of _0x4053de){const _0x3397d4=uuid['v4']()[_0x500153(0x230)](0x0,0xa)+_0x500153(0x25b);let _0x13308a;if(_0x873d0b[_0x500153(0x1dc)])_0x13308a=Buffer[_0x500153(0x25a)](_0x873d0b[_0x500153(0x1dc)],_0x500153(0x236));else{if(_0x873d0b[_0x500153(0x2b5)]){const _0x10246a=await axios_1[_0x500153(0x21d)][_0x500153(0x2cc)](_0x873d0b[_0x500153(0x2b5)],{'responseType':_0x500153(0x242)});_0x13308a=Buffer[_0x500153(0x25a)](_0x10246a['data']);}}_0x13308a&&_0x3aa1a5[_0x500153(0x24e)](this['uploadService'][_0x500153(0x2af)]({'filename':_0x3397d4,'buffer':_0x13308a}));}const _0x50c59f=await Promise[_0x500153(0x227)](_0x3aa1a5);await this[_0x500153(0x1e4)]['deductFromBalance'](_0x5007b1[_0x500153(0x2be)]['id'],_0x500153(0x270),(_0x1968a5===null||_0x1968a5===void 0x0?void 0x0:_0x1968a5[_0x500153(0x219)])===_0x500153(0x204)?0x2:0x4,_0x49bf11);const _0x52a813=(0x0,utils_1[_0x500153(0x249)])(_0x5007b1),_0x1b8cc4=[],_0x2018dd=await this[_0x500153(0x291)]['getUploadType'](),[_0x3f480c,_0x53e776]=_0x58ca96[_0x500153(0x1e3)][_0x500153(0x1fb)]('x');return _0x50c59f[_0x500153(0x21c)](_0x2ac088=>{const _0x55b44a=_0x500153;_0x1b8cc4[_0x55b44a(0x24e)](this[_0x55b44a(0x2b2)][_0x55b44a(0x2a3)]({'curIp':_0x52a813,'userId':_0x5007b1['user']['id'],'type':balance_constant_1[_0x55b44a(0x1d9)]['PAINT_TYPE'],'prompt':_0x58ca96['prompt'],'answer':_0x2ac088,'fileInfo':JSON[_0x55b44a(0x273)]({'cosType':_0x2018dd,'width':_0x3f480c,'height':_0x53e776,'cosUrl':_0x2ac088}),'promptTokens':0x0,'completionTokens':0x0,'totalTokens':0x0,'model':_0x55b44a(0x23a)}));}),await Promise[_0x500153(0x227)](_0x1b8cc4),_0x50c59f;}catch(_0xde91ff){const _0x610b9d=((_0x32a7e3=_0xde91ff===null||_0xde91ff===void 0x0?void 0x0:_0xde91ff[_0x500153(0x2a2)])===null||_0x32a7e3===void 0x0?void 0x0:_0x32a7e3[_0x500153(0x1fc)])||0x1f4;console[_0x500153(0x23e)]('openai-draw\x20error:\x20',JSON[_0x500153(0x273)](_0xde91ff),_0x546f71,_0x610b9d);const _0x3e8e48=(_0x4db6c7=(_0x1b25f9=(_0x24c38f=_0xde91ff===null||_0xde91ff===void 0x0?void 0x0:_0xde91ff[_0x500153(0x2a2)])===null||_0x24c38f===void 0x0?void 0x0:_0x24c38f[_0x500153(0x205)])===null||_0x1b25f9===void 0x0?void 0x0:_0x1b25f9[_0x500153(0x268)])===null||_0x4db6c7===void 0x0?void 0x0:_0x4db6c7['message'];if(_0x610b9d===0x1ad)throw new common_1['HttpException'](_0x500153(0x213),common_1['HttpStatus'][_0x500153(0x1c0)]);if(_0x610b9d===0x190&&_0x3e8e48[_0x500153(0x1fa)](_0x500153(0x211)))throw new common_1[(_0x500153(0x286))](_0x500153(0x1e6),common_1[_0x500153(0x241)][_0x500153(0x1c0)]);if(_0x610b9d===0x190&&_0x3e8e48[_0x500153(0x1fa)](_0x500153(0x256))){await this[_0x500153(0x1f0)]['lockKey'](_0x433727,'当前模型key已被封禁、已冻结当前调用Key、尝试重新对话试试吧！',-0x1);throw new common_1[(_0x500153(0x286))]('当前Key余额已不足、请重新再试一次吧！',common_1['HttpStatus'][_0x500153(0x1c0)]);}if(_0x610b9d===0x1f4)throw new common_1[(_0x500153(0x286))](_0x500153(0x2a1),common_1['HttpStatus']['BAD_REQUEST']);if(_0x610b9d===0x191)throw new common_1[(_0x500153(0x286))]('绘制图片失败，此次绘画被拒绝了！',common_1[_0x500153(0x241)][_0x500153(0x1c0)]);throw new common_1[(_0x500153(0x286))]('绘制图片失败，请稍后试试吧！',common_1[_0x500153(0x241)]['BAD_REQUEST']);}}async[_0x28c2d6(0x215)](){const _0x1d6888=_0x28c2d6,_0x4e5c01=await this[_0x1d6888(0x2b1)]['find']({'where':{'status':0x1},'select':['id',_0x1d6888(0x255),_0x1d6888(0x1f2),'model',_0x1d6888(0x29b),_0x1d6888(0x2ab),'openaiProxyUrl',_0x1d6888(0x240)]}),_0x2ac103=_0x4e5c01['filter'](_0x34ad72=>_0x34ad72[_0x1d6888(0x2c8)][_0x1d6888(0x1fa)]('gpt-3')),_0x33ba75=_0x4e5c01[_0x1d6888(0x2ba)](_0x39b12c=>_0x39b12c[_0x1d6888(0x2c8)][_0x1d6888(0x1fa)](_0x1d6888(0x1d5)));this['keyPool']={'list3':_0x2ac103,'list4':_0x33ba75};}async[_0x28c2d6(0x283)](_0x539be4){const _0x295c72=_0x28c2d6,_0x46c0de=await this[_0x295c72(0x274)][_0x295c72(0x1e5)]([_0x295c72(0x278)]);return(_0x539be4===null||_0x539be4===void 0x0?void 0x0:_0x539be4[_0x295c72(0x272)])||_0x46c0de||_0x295c72(0x234);}async['formatModelToken'](_0x250611){const _0x495dcd=_0x28c2d6,{openaiModel3MaxTokens:openaiModel3MaxTokens=0x0,openaiModel3MaxTokensRes:openaiModel3MaxTokensRes=0x0,openaiModel3MaxTokens16k:openaiModel3MaxTokens16k=0x0,openaiModel3MaxTokens16kRes:openaiModel3MaxTokens16kRes=0x0,openaiModel4MaxTokens:openaiModel4MaxTokens=0x0,openaiModel4MaxTokensRes:openaiModel4MaxTokensRes=0x0,openaiModel4MaxTokens32k:openaiModel4MaxTokens32k=0x0,openaiModel4MaxTokens32kRes:openaiModel4MaxTokens32kRes=0x0,openaiBaseUrl:openaiBaseUrl=''}=await this[_0x495dcd(0x274)][_0x495dcd(0x1e5)](['openaiModel3MaxTokens',_0x495dcd(0x1e2),_0x495dcd(0x1c1),_0x495dcd(0x1eb),_0x495dcd(0x209),'openaiModel4MaxTokensRes',_0x495dcd(0x2c0),'openaiModel4MaxTokens32kRes',_0x495dcd(0x278)]);let _0x50c53d=null,_0x3715b8=null,_0x25bd32=null,{model:_0x44bb93,maxModelTokens:maxModelTokens=0x0,maxResponseTokens:maxResponseTokens=0x0,proxyUrl:proxyUrl='',key:_0x2ab91c}=_0x250611;return _0x44bb93[_0x495dcd(0x237)]()['includes']('gpt-4')&&(maxModelTokens>=0x2000&&(maxModelTokens=0x2000),_0x3715b8>=0x1000&&(maxModelTokens=0x1000),_0x50c53d=maxModelTokens||openaiModel4MaxTokens||0x2000,_0x3715b8=maxResponseTokens||openaiModel4MaxTokensRes||0x1000,_0x44bb93[_0x495dcd(0x237)]()[_0x495dcd(0x1fa)](_0x495dcd(0x2a6))&&(maxModelTokens>=0x8000&&(maxModelTokens=0x8000),_0x3715b8>=0x4000&&(maxModelTokens=0x4000),_0x50c53d=maxModelTokens||openaiModel4MaxTokens32k||0x8000,_0x3715b8=maxResponseTokens||openaiModel4MaxTokens32kRes||0x4000),_0x44bb93[_0x495dcd(0x237)]()[_0x495dcd(0x1fa)]('1106')&&(maxModelTokens>=0x3ffc&&(maxModelTokens=0x3ffc),_0x3715b8>=0x1000&&(maxModelTokens=0x1000),_0x50c53d=maxModelTokens||0x3ffc,_0x3715b8=maxResponseTokens||0x1000)),_0x44bb93[_0x495dcd(0x237)]()[_0x495dcd(0x1fa)](_0x495dcd(0x21e))&&(maxModelTokens>=0x1000&&(maxModelTokens=0x1000),_0x3715b8>=0x7d0&&(maxModelTokens=0x7d0),_0x50c53d=maxModelTokens||openaiModel3MaxTokens||0x1000,_0x3715b8=maxResponseTokens||openaiModel3MaxTokensRes||0x7d0,_0x44bb93[_0x495dcd(0x237)]()['includes'](_0x495dcd(0x1da))&&(maxModelTokens>=0x4000&&(maxModelTokens=0x4000),_0x3715b8>=0x2000&&(maxModelTokens=0x2000),_0x50c53d=maxModelTokens||openaiModel3MaxTokens16k||0x4000,_0x3715b8=maxResponseTokens||openaiModel3MaxTokens16kRes||0x2000),_0x44bb93['toLowerCase']()[_0x495dcd(0x1fa)]('1106')&&(maxModelTokens>=0x4000&&(maxModelTokens=0x4000),_0x3715b8>=0x1000&&(maxModelTokens=0x1000),_0x50c53d=maxModelTokens||0x4000,_0x3715b8=maxResponseTokens||0x1000)),_0x25bd32=proxyUrl||openaiBaseUrl||_0x495dcd(0x234),_0x3715b8>=_0x50c53d&&(_0x3715b8=Math['floor'](_0x50c53d/0x2)),{'key':_0x2ab91c,'maxToken':_0x50c53d,'maxTokenRes':_0x3715b8,'proxyResUrl':_0x25bd32};}async[_0x28c2d6(0x203)](_0x390944,_0x5a487f){const _0x829f37=_0x28c2d6;try{const {name:_0x5ae8d2,icon:_0x2f6f41,order:_0x7f66cd,id:_0x294c17,status:_0x2cd127}=_0x5a487f;return _0x294c17?await this[_0x829f37(0x2bf)][_0x829f37(0x293)]({'id':_0x294c17},{'name':_0x5ae8d2,'icon':_0x2f6f41,'order':_0x7f66cd,'status':_0x2cd127}):await this[_0x829f37(0x2bf)][_0x829f37(0x284)]({'name':_0x5ae8d2,'icon':_0x2f6f41,'order':_0x7f66cd,'status':_0x2cd127});}catch(_0x86a55a){console[_0x829f37(0x23e)]('error:\x20',_0x86a55a);}}async[_0x28c2d6(0x206)](_0x383f43,_0xb87136){const _0x3fc3b1=_0x28c2d6,{id:_0xd62952}=_0xb87136;if(!_0xd62952)throw new common_1[(_0x3fc3b1(0x286))]('非法操作！',common_1['HttpStatus'][_0x3fc3b1(0x1c0)]);const _0x3e0df8=await this[_0x3fc3b1(0x243)]['count']({'where':{'typeId':_0xd62952}});if(_0x3e0df8)throw new common_1[(_0x3fc3b1(0x286))](_0x3fc3b1(0x226),common_1[_0x3fc3b1(0x241)][_0x3fc3b1(0x1c0)]);return await this[_0x3fc3b1(0x2bf)][_0x3fc3b1(0x259)]({'id':_0xd62952});}async[_0x28c2d6(0x299)](){const _0x4006e1=_0x28c2d6;return await this[_0x4006e1(0x2bf)][_0x4006e1(0x212)]({'order':{'order':_0x4006e1(0x26a)}});}async[_0x28c2d6(0x1f8)](_0x853de8,_0x2f2199){const _0x19b495=_0x28c2d6,{title:_0x1a8ae0,prompt:_0xb85b80,appId:_0x1a7be7,order:_0xbebe54,status:_0x1fabcf,typeId:_0x231058,id:_0x100ae6,url:_0xab9b9d}=_0x2f2199;if(!_0x231058)throw new common_1['HttpException']('缺失必要参数！',common_1[_0x19b495(0x241)][_0x19b495(0x1c0)]);try{const _0x120adf={'title':_0x1a8ae0,'order':_0xbebe54,'status':_0x1fabcf,'typeId':_0x231058,'url':_0xab9b9d};return _0x120adf[_0x19b495(0x2c2)]=_0x1a7be7||0x0,_0x120adf[_0x19b495(0x23c)]=_0xb85b80||'',_0x100ae6?await this[_0x19b495(0x243)]['update']({'id':_0x100ae6},_0x120adf):await this['chatBoxEntity'][_0x19b495(0x284)](_0x120adf);}catch(_0x54845d){console[_0x19b495(0x23e)]('error:\x20',_0x54845d);}}async[_0x28c2d6(0x1de)](_0x3e269b,_0x1dd251){const _0x21867b=_0x28c2d6,{id:_0xaa2814}=_0x1dd251;if(!_0xaa2814)throw new common_1['HttpException'](_0x21867b(0x26c),common_1[_0x21867b(0x241)][_0x21867b(0x1c0)]);return await this[_0x21867b(0x243)][_0x21867b(0x259)]({'id':_0xaa2814});}async[_0x28c2d6(0x21f)](){const _0x30debd=_0x28c2d6,_0x380ce3=await this[_0x30debd(0x243)][_0x30debd(0x212)]({'order':{'order':_0x30debd(0x26a)}}),_0x386891=[...new Set(_0x380ce3[_0x30debd(0x1f6)](_0x5ea819=>_0x5ea819[_0x30debd(0x258)]))],_0x2f69b6=[...new Set(_0x380ce3['map'](_0x299328=>_0x299328[_0x30debd(0x2c2)]))],_0xeed6d=await this['chatBoxTypeEntity'][_0x30debd(0x212)]({'where':{'id':(0x0,typeorm_1['In'])(_0x386891)}}),_0x78027d=await this[_0x30debd(0x2a0)][_0x30debd(0x212)]({'where':{'id':(0x0,typeorm_1['In'])(_0x2f69b6)}});return _0x380ce3[_0x30debd(0x1f6)](_0x5735f7=>{const _0xe5c6ce=_0x30debd,{typeId:_0x267d76,appId:_0x4daf85}=_0x5735f7;return _0x5735f7[_0xe5c6ce(0x27a)]=_0xeed6d['find'](_0x41aabd=>_0x41aabd['id']===_0x267d76),_0x5735f7['appInfo']=_0x78027d[_0xe5c6ce(0x212)](_0x126868=>_0x126868['id']===_0x4daf85),_0x5735f7;});}async[_0x28c2d6(0x1f9)](){const _0x3bc6bc=_0x28c2d6,_0x4ef94b=await this[_0x3bc6bc(0x2bf)][_0x3bc6bc(0x212)]({'order':{'order':'DESC'},'where':{'status':!![]}}),_0x22d916=await this[_0x3bc6bc(0x243)][_0x3bc6bc(0x212)]({'where':{'status':!![]}}),_0x566bcd=[...new Set(_0x22d916[_0x3bc6bc(0x1f6)](_0x40fb62=>_0x40fb62['appId']))],_0x540208=await this[_0x3bc6bc(0x2a0)]['find']({'where':{'id':(0x0,typeorm_1['In'])(_0x566bcd)}});return _0x22d916[_0x3bc6bc(0x21c)](_0x177a86=>{const _0x5aef93=_0x3bc6bc,_0x5b5784=_0x540208['find'](_0x4e3cb6=>_0x4e3cb6['id']===_0x177a86[_0x5aef93(0x2c2)]);return _0x177a86[_0x5aef93(0x28e)]=_0x5b5784===null||_0x5b5784===void 0x0?void 0x0:_0x5b5784[_0x5aef93(0x28e)],_0x177a86;}),_0x4ef94b[_0x3bc6bc(0x1f6)](_0x4a2a19=>{const _0x489ed5=_0x3bc6bc;return _0x4a2a19['childList']=_0x22d916['filter'](_0xff7e23=>_0xff7e23[_0x489ed5(0x258)]===_0x4a2a19['id']&&_0xff7e23[_0x489ed5(0x1fc)]),_0x4a2a19;});}async['setChatPreType'](_0x2380f2,_0x57a0c5){const _0x4a6b60=_0x28c2d6;try{const {name:_0x100151,icon:_0x2a893d,order:_0x2f5688,id:_0x5bc59d,status:_0x39ac99}=_0x57a0c5;return _0x5bc59d?await this[_0x4a6b60(0x261)][_0x4a6b60(0x293)]({'id':_0x5bc59d},{'name':_0x100151,'icon':_0x2a893d,'order':_0x2f5688,'status':_0x39ac99}):await this[_0x4a6b60(0x261)][_0x4a6b60(0x284)]({'name':_0x100151,'icon':_0x2a893d,'order':_0x2f5688,'status':_0x39ac99});}catch(_0x882e99){console[_0x4a6b60(0x23e)]('error:\x20',_0x882e99);}}async['delChatPreType'](_0x4d88d6,_0x4d5c3e){const _0x557406=_0x28c2d6,{id:_0x4401d2}=_0x4d5c3e;if(!_0x4401d2)throw new common_1[(_0x557406(0x286))]('非法操作！',common_1[_0x557406(0x241)][_0x557406(0x1c0)]);const _0x23ca6c=await this[_0x557406(0x243)][_0x557406(0x20f)]({'where':{'typeId':_0x4401d2}});if(_0x23ca6c)throw new common_1['HttpException'](_0x557406(0x226),common_1[_0x557406(0x241)][_0x557406(0x1c0)]);return await this[_0x557406(0x261)]['delete']({'id':_0x4401d2});}async[_0x28c2d6(0x202)](){const _0x4fedc1=_0x28c2d6;return await this[_0x4fedc1(0x261)]['find']({'order':{'order':_0x4fedc1(0x26a)}});}async[_0x28c2d6(0x1c7)](_0xaa1b7c,_0x551c3a){const _0x19ad1b=_0x28c2d6,{title:_0x21794f,prompt:_0x35a79a,appId:_0x10fb72,order:_0x5d1294,status:_0x5e67e9,typeId:_0x3feb4c,id:_0x52938d,url:_0x51c41a}=_0x551c3a;if(!_0x3feb4c)throw new common_1[(_0x19ad1b(0x286))]('缺失必要参数！',common_1[_0x19ad1b(0x241)][_0x19ad1b(0x1c0)]);try{const _0x4f1563={'title':_0x21794f,'prompt':_0x35a79a,'order':_0x5d1294,'status':_0x5e67e9,'typeId':_0x3feb4c,'url':_0x51c41a};return _0x52938d?await this[_0x19ad1b(0x20e)][_0x19ad1b(0x293)]({'id':_0x52938d},_0x4f1563):await this[_0x19ad1b(0x20e)]['save'](_0x4f1563);}catch(_0x13be56){console['log'](_0x19ad1b(0x214),_0x13be56);}}async['delChatPre'](_0xe6e1d1,_0x1be4b7){const _0x18a971=_0x28c2d6,{id:_0x1b0863}=_0x1be4b7;if(!_0x1b0863)throw new common_1[(_0x18a971(0x286))](_0x18a971(0x26c),common_1[_0x18a971(0x241)][_0x18a971(0x1c0)]);return await this['chatPreEntity']['delete']({'id':_0x1b0863});}async[_0x28c2d6(0x224)](){const _0xb8cd66=_0x28c2d6,_0x13f801=await this['chatPreEntity'][_0xb8cd66(0x212)]({'order':{'order':_0xb8cd66(0x26a)}}),_0xf022d4=[...new Set(_0x13f801[_0xb8cd66(0x1f6)](_0x37d7b4=>_0x37d7b4[_0xb8cd66(0x258)]))],_0xb89edb=await this['chatPreTypeEntity'][_0xb8cd66(0x212)]({'where':{'id':(0x0,typeorm_1['In'])(_0xf022d4)}});return _0x13f801[_0xb8cd66(0x1f6)](_0x2c99f3=>{const _0x2734b8=_0xb8cd66,{typeId:_0x479a91,appId:_0x1ed714}=_0x2c99f3;return _0x2c99f3[_0x2734b8(0x27a)]=_0xb89edb['find'](_0x558ecc=>_0x558ecc['id']===_0x479a91),_0x2c99f3;});}async[_0x28c2d6(0x28a)](){const _0x216387=_0x28c2d6,_0x47c36d=await this[_0x216387(0x261)]['find']({'order':{'order':_0x216387(0x26a)},'where':{'status':!![]}}),_0x7dc76b=await this['chatPreEntity']['find']({'where':{'status':!![]}});return _0x47c36d[_0x216387(0x1f6)](_0x268c87=>{const _0x4db54a=_0x216387;return _0x268c87[_0x4db54a(0x210)]=_0x7dc76b[_0x4db54a(0x2ba)](_0x7e0f55=>_0x7e0f55['typeId']===_0x268c87['id']&&_0x7e0f55[_0x4db54a(0x1fc)]),_0x268c87;});}async[_0x28c2d6(0x1c9)](_0x3fea02,_0x567e79,_0x3d14db){const _0x4942ee=_0x28c2d6;let _0x307042=0x1000,_0x746251=0x800;return _0x3fea02['toLowerCase']()[_0x4942ee(0x1fa)](_0x4942ee(0x1d5))&&(_0x307042=_0x567e79>=0x2004?0x2004:_0x567e79,_0x746251=_0x3d14db>=0x1000?0x1000:_0x3d14db,_0x3fea02['toLowerCase']()[_0x4942ee(0x1fa)]('32k')&&(_0x307042=_0x567e79>=0x8000?0x8000:_0x567e79,_0x746251=_0x3d14db>=0x3e80?0x3e80:_0x3d14db),(_0x3fea02['toLowerCase']()[_0x4942ee(0x1fa)](_0x4942ee(0x298))||_0x3fea02[_0x4942ee(0x237)]()[_0x4942ee(0x1fa)](_0x4942ee(0x25f)))&&(_0x307042=_0x567e79>=0x1f400?0x1f400:_0x567e79,_0x746251=_0x3d14db>=0x1000?0x1000:_0x3d14db)),_0x3fea02[_0x4942ee(0x237)]()[_0x4942ee(0x1fa)]('gpt-3')&&(_0x307042=_0x567e79>=0x1000?0x1000:_0x567e79,_0x746251=_0x3d14db>=0x800?0x800:_0x3d14db,_0x3fea02[_0x4942ee(0x237)]()[_0x4942ee(0x1fa)](_0x4942ee(0x1da))&&(_0x307042=_0x567e79>=0x4000?0x4000:_0x567e79,_0x746251=_0x3d14db>=0x1f40?0x1f40:_0x3d14db),_0x3fea02[_0x4942ee(0x237)]()[_0x4942ee(0x1fa)]('1106')&&(_0x307042=_0x567e79>=0x4000?0x4000:_0x567e79,_0x746251=_0x3d14db>=0x1f40?0x1f40:_0x3d14db)),{'maxToken':_0x307042,'maxRes':_0x746251};}};function _0x325f(_0x2b18ed,_0x145356){const _0xe5ffce=_0xe5ff();return _0x325f=function(_0x325f7f,_0x469c4e){_0x325f7f=_0x325f7f-0x1bf;let _0x50f9a3=_0xe5ffce[_0x325f7f];return _0x50f9a3;},_0x325f(_0x2b18ed,_0x145356);}ChatgptService=__decorate([(0x0,common_1[_0x28c2d6(0x262)])(),__param(0x0,(0x0,typeorm_2[_0x28c2d6(0x1ec)])(gptkeys_entity_1[_0x28c2d6(0x2c4)])),__param(0x1,(0x0,typeorm_2[_0x28c2d6(0x1ec)])(config_entity_1[_0x28c2d6(0x1e8)])),__param(0x2,(0x0,typeorm_2[_0x28c2d6(0x1ec)])(chatBoxType_entity_1[_0x28c2d6(0x216)])),__param(0x3,(0x0,typeorm_2['InjectRepository'])(chatBox_entity_1[_0x28c2d6(0x1ed)])),__param(0x4,(0x0,typeorm_2[_0x28c2d6(0x1ec)])(app_entity_1[_0x28c2d6(0x2ac)])),__param(0x5,(0x0,typeorm_2[_0x28c2d6(0x1ec)])(chatPreType_entity_1[_0x28c2d6(0x23f)])),__param(0x6,(0x0,typeorm_2[_0x28c2d6(0x1ec)])(chatPre_entity_1[_0x28c2d6(0x2ca)])),__metadata(_0x28c2d6(0x24f),[typeorm_1['Repository'],typeorm_1[_0x28c2d6(0x207)],typeorm_1[_0x28c2d6(0x207)],typeorm_1[_0x28c2d6(0x207)],typeorm_1[_0x28c2d6(0x207)],typeorm_1[_0x28c2d6(0x207)],typeorm_1[_0x28c2d6(0x207)],nestjs_config_1['ConfigService'],userBalance_service_1['UserBalanceService'],chatLog_service_1[_0x28c2d6(0x20d)],user_service_1['UserService'],upload_service_1[_0x28c2d6(0x231)],badwords_service_1[_0x28c2d6(0x22f)],autoreply_service_1[_0x28c2d6(0x1df)],globalConfig_service_1[_0x28c2d6(0x1c8)],fanyi_service_1[_0x28c2d6(0x28c)],chatGroup_service_1[_0x28c2d6(0x2a5)],models_service_1['ModelsService']])],ChatgptService),exports[_0x28c2d6(0x1cb)]=ChatgptService;function _0xe5ff(){const _0x57134c=['typeId','delete','from','.png','statusCode','chat-error-detail\x20\x20<----------------------------------------->','getRequestParams','gpt-4-vision-preview','modelInfo','chatPreTypeEntity','Injectable','./gptkeys.entity','12WHFlEm','lockKey','NineStore','getOwnPropertyDescriptor','error','keyv','DESC','usage','非法操作！','../badwords/badwords.service','当前模型不是聊天模型、已冻结当前调用Key、请重新尝试对话！','Content-type','mjDraw','../../common/utils','proxyUrl','stringify','globalConfigService','Bearer\x20','abortController','\x20key\x20->\x20','openaiBaseUrl','env','typeInfo','abort','draw','../fanyi/fanyi.service','./helper','chatgpt-nine-ai','Logger','REDIS_PORT','8LcAypQ','getModelProxyUrl','save','getUuid','HttpException','./openai','dall-e\x20draw\x20params:\x20','chatSyncFree','queryChatPreList','../autoreply/autoreply.service','FanyiService','DrawService','coverImg','length','sendMessageFromZhipu','uploadService','REDIS_PASSWORD','update','statusText:','getTokenCount','2394162ffzlix','assign','gpt-4-1106','queryChatBoxType','本次调用:\x20','maxModelTokens','compileNetwork','model3','formatModelToken','../models/models.service','appEntity','绘制图片失败，请检查你的提示词是否有非法描述！','response','saveChatLog','Catch\x20Error\x20','ChatGroupService','32k','draw\x20paompt\x20info\x20<==**==>\x20','PAYMENT_REQUIRED','post',',\x20最大回复token:\x20','maxResponseTokens','AppEntity','whiteListUser','你当前使用的应用已被下架、请删除当前对话开启新的对话吧！','uploadFile','message','gptKeysEntity','chatLogService','removeSpecialCharacters','badwordsService','url','result','1024x1024','400\x20error','__param','filter','提供了错误的模型秘钥','config','model4','user','chatBoxTypeEntity','openaiModel4MaxTokens32k','fanyiService','appId','__esModule','GptKeysEntity','preset','./store','10XkZmWS','model','autoreplyService','ChatPreEntity','getRandomDrawKey','get','getBaseConfig','BAD_REQUEST','openaiModel3MaxTokens16k',',\x20模型名称:\x20','redis://','\x0a\x20Current\x20date:\x20','buildMessageFromParentMessageId','application/octet-stream;\x20charset=utf-8','setChatPre','GlobalConfigService','getMaxTokenFromModelWithOpenAi','object','ChatgptService','axios','The\x20OpenAI\x20account\x20associated\x20with\x20this\x20API\x20key\x20has\x20been\x20deactivated.','../chatGroup/chatGroup.service','code:\x20','2844385SRMtjs','text','../app/app.entity','Incorrect\x20API\x20key\x20provided','../globalConfig/globalConfig.service','gpt-4','toISOString','userService','@nestjs/typeorm','DeductionKey','16k','defineProperty','b64_json','typeorm','delChatBox','AutoreplyService','CHAT_TYPE','statusText','openaiModel3MaxTokensRes','size','userBalanceService','getConfigs','您的请求已被系统拒绝。您的提示可能存在一些非法的文本。','checkBadWords','ConfigEntity','./chatBoxType.entity','conversationId','openaiModel3MaxTokens16kRes','InjectRepository','ChatBoxEntity','Too\x20Many\x20Requests','当前模型调用过于频繁、请重新试试吧！','modelsService','assistant','weight','uuid','../userBalance/userBalance.service','@keyv/redis','map','256kfVFCD','setChatBox','queryChatBoxFrontend','includes','split','status','huoquurl',',\x20key\x20===>\x20','OpenAiErrorCodeMessage','当前流程所需要的模型已被管理员下架、请联系管理员上架专属模型！','6032383ttSkVA','queryChatPreType','setChatBoxType','standard','data','delChatBoxType','Repository','当前模型key余额已耗尽、已冻结当前调用Key、尝试重新对话试试吧！','openaiModel4MaxTokens','metadata','checkAutoReply','billing','ChatLogService','chatPreEntity','count','childList','This\x20request\x20has\x20been\x20blocked\x20by\x20our\x20content\x20filters','find','当前请求已过载、请稍等会儿再试试吧！','error:\x20','getAllKeyList','ChatBoxTypeEntity','validateBalance','./chatPre.entity','quality','addOneIfOdd','deductFromBalance','forEach','default','gpt-3','queryChatBox','4238104zVKWNN','158221BSoevK','decorate','setData','queryChatPre','importDynamic','当前分类下有未处理数据不可移除！','all','../../common/constants/balance.constant','queryUserBalance','./chatPreType.entity','提供了错误的模型秘钥、已冻结当前调用Key、请重新尝试对话！','findOne','__decorate','checkUserStatus','BadwordsService','slice','UploadService','/v1/images/generations','chat','https://api.openai.com','userBanance','base64','toLowerCase','configEntity','function','dall-e-3','nineStore','prompt','onModuleInit','log','ChatPreTypeEntity','openaiTimeoutMs','HttpStatus','arraybuffer','chatBoxEntity','chatGroupService','getGroupInfoFromId','14501421CxYqoM','write','parse','getClientIp','systemPreMessage','@nestjs/common','当前模型key已被封禁、已冻结当前调用Key、尝试重新对话试试吧！','saveUseLog','push','design:paramtypes','is_end','29571Nesfhj','../chatLog/chatLog.service','nineai-chatlog','./zhipu','key','Billing\x20hard\x20limit\x20has\x20been\x20reached','服务异常、请重新试试吧！！！'];_0xe5ff=function(){return _0x57134c;};return _0xe5ff();}