'use strict';const _0x367c89=_0x5c18;(function(_0x23b8c1,_0x151e89){const _0x286161=_0x5c18,_0x4b7069=_0x23b8c1();while(!![]){try{const _0x4172bd=-parseInt(_0x286161(0x108))/0x1+-parseInt(_0x286161(0x11b))/0x2*(parseInt(_0x286161(0x10f))/0x3)+parseInt(_0x286161(0x103))/0x4+parseInt(_0x286161(0x12e))/0x5+parseInt(_0x286161(0x10a))/0x6+parseInt(_0x286161(0x10e))/0x7*(-parseInt(_0x286161(0x122))/0x8)+-parseInt(_0x286161(0x128))/0x9*(-parseInt(_0x286161(0x117))/0xa);if(_0x4172bd===_0x151e89)break;else _0x4b7069['push'](_0x4b7069['shift']());}catch(_0x4211f9){_0x4b7069['push'](_0x4b7069['shift']());}}}(_0x80e8,0xaf98f));function _0x5c18(_0x328156,_0x691124){const _0x80e895=_0x80e8();return _0x5c18=function(_0x5c18a2,_0x257985){_0x5c18a2=_0x5c18a2-0xfe;let _0x3b6b5c=_0x80e895[_0x5c18a2];return _0x3b6b5c;},_0x5c18(_0x328156,_0x691124);}function _0x80e8(){const _0x34db63=['decorate','clean','__decorate','deductFromBalance','addDrawQueuech','object','mjTimeoutMs','../userBalance/userBalance.service','debug','userBalanceService','jobIds','add','__metadata','InjectQueue','3408912clTYzc','log','addMjDrawQueue','defineProperty','function','670746LwxJmP','MidjourneyActionEnum','2595840hExcPR','VARIATION','QueueService','globalConfigService','796761kSxtKu','3eDdQkK','error32424','push','服务启动时清除所有之前未执行完毕的队列任务！','MidjourneyService','design:paramtypes','getMjDefaultParams','Logger','10PbtVmy','params','UserBalanceService','active','2382678vzbPjs','length','onApplicationBootstrap','validateBalance','checkLimit','cleanQueue','../../common/utils','8qnCiaV','addDrawQueue','midjourneyService','UPSCALE','__esModule','assign','11053215sWrgrf','../../common/constants/midjourney.constant','checkIsUpscale','params76767','metadata','DRAW','910760LCYmFB','getConfigs','mjDrawQueue','__param','user','@nestjs/bull','mjDraw','getDrawActionDetailch','getDrawActionDetail','getDrawActionDetail2','REGENERATE','getOwnPropertyDescriptor'];_0x80e8=function(){return _0x34db63;};return _0x80e8();}var __decorate=this&&this[_0x367c89(0x13c)]||function(_0xf2b6dc,_0x1c158c,_0x10b089,_0x266e80){const _0x238638=_0x367c89;var _0x14f087=arguments[_0x238638(0x11c)],_0x5f1477=_0x14f087<0x3?_0x1c158c:_0x266e80===null?_0x266e80=Object[_0x238638(0x139)](_0x1c158c,_0x10b089):_0x266e80,_0x56a9b4;if(typeof Reflect===_0x238638(0x13f)&&typeof Reflect[_0x238638(0x13a)]==='function')_0x5f1477=Reflect[_0x238638(0x13a)](_0xf2b6dc,_0x1c158c,_0x10b089,_0x266e80);else{for(var _0x35eeab=_0xf2b6dc[_0x238638(0x11c)]-0x1;_0x35eeab>=0x0;_0x35eeab--)if(_0x56a9b4=_0xf2b6dc[_0x35eeab])_0x5f1477=(_0x14f087<0x3?_0x56a9b4(_0x5f1477):_0x14f087>0x3?_0x56a9b4(_0x1c158c,_0x10b089,_0x5f1477):_0x56a9b4(_0x1c158c,_0x10b089))||_0x5f1477;}return _0x14f087>0x3&&_0x5f1477&&Object[_0x238638(0x106)](_0x1c158c,_0x10b089,_0x5f1477),_0x5f1477;},__metadata=this&&this[_0x367c89(0x101)]||function(_0x4156e6,_0xe90501){const _0xc1386f=_0x367c89;if(typeof Reflect===_0xc1386f(0x13f)&&typeof Reflect[_0xc1386f(0x12c)]===_0xc1386f(0x107))return Reflect['metadata'](_0x4156e6,_0xe90501);},__param=this&&this[_0x367c89(0x131)]||function(_0x2b012a,_0x4fa0aa){return function(_0x33f443,_0x3f905c){_0x4fa0aa(_0x33f443,_0x3f905c,_0x2b012a);};};Object[_0x367c89(0x106)](exports,_0x367c89(0x126),{'value':!![]}),exports[_0x367c89(0x10c)]=void 0x0;const common_1=require('@nestjs/common'),bull_1=require(_0x367c89(0x133)),utils_1=require(_0x367c89(0x121)),midjourney_service_1=require('../midjourney/midjourney.service'),midjourney_constant_1=require(_0x367c89(0x129)),userBalance_service_1=require(_0x367c89(0x141)),globalConfig_service_1=require('../globalConfig/globalConfig.service');let QueueService=class QueueService{constructor(_0xaf83c1,_0xcbe07c,_0x593fb7,_0x4bdc61){const _0x143591=_0x367c89;this[_0x143591(0x130)]=_0xaf83c1,this['midjourneyService']=_0xcbe07c,this[_0x143591(0xfe)]=_0x593fb7,this[_0x143591(0x10d)]=_0x4bdc61,this['jobIds']=[];}async[_0x367c89(0x11d)](){const _0x7521b4=_0x367c89;common_1[_0x7521b4(0x116)][_0x7521b4(0x142)](_0x7521b4(0x112),_0x7521b4(0x10c));try{await this[_0x7521b4(0x130)][_0x7521b4(0x13b)](0x0,_0x7521b4(0x11a));}catch(_0x35ff19){console[_0x7521b4(0x104)](_0x35ff19);}await this['midjourneyService'][_0x7521b4(0x120)]();}async[_0x367c89(0x105)](_0x181f6a,_0x505e7d){const _0x3a7e37=_0x367c89,{prompt:_0x5b4d0b,imgUrl:_0x11bec5,extraParam:_0xf393c2,orderId:_0xd21dad,action:action=0x1,drawId:_0x20ce29}=_0x181f6a;await this[_0x3a7e37(0x124)][_0x3a7e37(0x11f)](_0x505e7d),await this[_0x3a7e37(0xfe)][_0x3a7e37(0x11e)](_0x505e7d,_0x3a7e37(0x134),action===0x2?0x1:0x4);if(action===midjourney_constant_1['MidjourneyActionEnum'][_0x3a7e37(0x12d)]||action===midjourney_constant_1[_0x3a7e37(0x109)]['GENERATE']){const _0x161ea1=''+(0x0,utils_1['createRandomUid'])(),_0x79e50e=Object['assign'](Object[_0x3a7e37(0x127)]({},_0x181f6a),{'userId':_0x505e7d[_0x3a7e37(0x132)]['id'],'randomDrawId':_0x161ea1});try{console[_0x3a7e37(0x104)](_0x3a7e37(0x12b),_0x79e50e);const _0x3ec9c8=await this[_0x3a7e37(0x124)][_0x3a7e37(0x123)](_0x79e50e),_0x4129f3=await this[_0x3a7e37(0x10d)]['getConfigs']([_0x3a7e37(0x140)])||0x30d40,_0x1e9bea=await this['mjDrawQueue'][_0x3a7e37(0x100)]('mjDraw',{'id':_0x3ec9c8['id'],'action':_0x11bec5?0x4:0x1,'userId':_0x505e7d[_0x3a7e37(0x132)]['id']},{'delay':0x3e8,'timeout':+_0x4129f3});return this['jobIds'][_0x3a7e37(0x111)](_0x1e9bea['id']),await this[_0x3a7e37(0xfe)][_0x3a7e37(0x13d)](_0x505e7d[_0x3a7e37(0x132)]['id'],_0x3a7e37(0x134),0x4,0x4),!![];}catch(_0x5647ce){console[_0x3a7e37(0x104)](_0x3a7e37(0x110),_0x5647ce);}}if(action===midjourney_constant_1[_0x3a7e37(0x109)][_0x3a7e37(0x125)]){const {channel_id:_0x57622d}=await this[_0x3a7e37(0x124)][_0x3a7e37(0x115)]();if(_0x57622d==='0'){const _0x35ead1=await this['midjourneyService'][_0x3a7e37(0x137)](_0x20ce29),{custom_id:_0x539ff9}=_0x35ead1;await this[_0x3a7e37(0x124)][_0x3a7e37(0x12a)](_0x539ff9);const _0x56e751=Object[_0x3a7e37(0x127)](Object[_0x3a7e37(0x127)](Object[_0x3a7e37(0x127)](Object[_0x3a7e37(0x127)]({},_0x181f6a),{'userId':_0x505e7d[_0x3a7e37(0x132)]['id']}),_0x35ead1),{'action':action,'orderId':_0xd21dad});console['log'](_0x3a7e37(0x118),_0x56e751);const _0x3d4cd0=await this[_0x3a7e37(0x124)][_0x3a7e37(0x123)](_0x56e751),_0x346a31=await this['globalConfigService'][_0x3a7e37(0x12f)]([_0x3a7e37(0x140)])||0x30d40,_0x45c9cf=await this[_0x3a7e37(0x130)][_0x3a7e37(0x100)](_0x3a7e37(0x134),{'id':_0x3d4cd0['id'],'action':action,'userId':_0x505e7d[_0x3a7e37(0x132)]['id']},{'delay':0x3e8,'timeout':+_0x346a31});await this['userBalanceService']['deductFromBalance'](_0x505e7d['user']['id'],_0x3a7e37(0x134),0x1,0x1),this[_0x3a7e37(0xff)][_0x3a7e37(0x111)](_0x45c9cf['id']);return;}else{const _0x368a98=await this['midjourneyService'][_0x3a7e37(0x136)](action,_0x20ce29,_0xd21dad),{custom_id:_0x4fab23}=_0x368a98;await this[_0x3a7e37(0x124)][_0x3a7e37(0x12a)](_0x4fab23);const _0x376704=Object[_0x3a7e37(0x127)](Object['assign'](Object[_0x3a7e37(0x127)]({},_0x181f6a),{'userId':_0x505e7d['user']['id']}),_0x368a98),_0xdf2c94=await this[_0x3a7e37(0x124)]['addDrawQueue'](_0x376704),_0x5a1f22=await this['globalConfigService']['getConfigs']([_0x3a7e37(0x140)])||0x30d40,_0x420e62=await this[_0x3a7e37(0x130)][_0x3a7e37(0x100)]('mjDraw',{'id':_0xdf2c94['id'],'action':action,'userId':_0x505e7d[_0x3a7e37(0x132)]['id']},{'delay':0x3e8,'timeout':+_0x5a1f22});await this[_0x3a7e37(0xfe)]['deductFromBalance'](_0x505e7d[_0x3a7e37(0x132)]['id'],_0x3a7e37(0x134),0x1,0x1),this['jobIds'][_0x3a7e37(0x111)](_0x420e62['id']);return;}};if(action===midjourney_constant_1[_0x3a7e37(0x109)][_0x3a7e37(0x10b)]){const _0x520b7c=await this[_0x3a7e37(0x124)][_0x3a7e37(0x137)](_0x20ce29),_0x1ef25a=Object[_0x3a7e37(0x127)](Object[_0x3a7e37(0x127)](Object[_0x3a7e37(0x127)](Object[_0x3a7e37(0x127)]({},_0x181f6a),{'userId':_0x505e7d[_0x3a7e37(0x132)]['id']}),_0x520b7c),{'action':action,'orderId':_0xd21dad}),_0x5d03e=await this[_0x3a7e37(0x124)][_0x3a7e37(0x123)](_0x1ef25a),_0x195924=await this[_0x3a7e37(0x10d)][_0x3a7e37(0x12f)]([_0x3a7e37(0x140)])||0x30d40,_0x2977b2=await this[_0x3a7e37(0x130)][_0x3a7e37(0x100)](_0x3a7e37(0x134),{'id':_0x5d03e['id'],'action':action,'userId':_0x505e7d[_0x3a7e37(0x132)]['id']},{'delay':0x3e8,'timeout':+_0x195924});this[_0x3a7e37(0xff)][_0x3a7e37(0x111)](_0x2977b2['id']),await this[_0x3a7e37(0xfe)][_0x3a7e37(0x13d)](_0x505e7d['user']['id'],_0x3a7e37(0x134),0x4,0x4);return;}if(action===midjourney_constant_1['MidjourneyActionEnum'][_0x3a7e37(0x138)]){const _0x4b7542=await this[_0x3a7e37(0x124)]['getDrawActionDetail2'](_0x20ce29),_0xc835ed=Object[_0x3a7e37(0x127)](Object[_0x3a7e37(0x127)](Object['assign'](Object[_0x3a7e37(0x127)]({},_0x181f6a),{'userId':_0x505e7d[_0x3a7e37(0x132)]['id']}),_0x4b7542),{'action':action,'orderId':_0xd21dad,'drawId':_0x20ce29}),_0x3e336f=await this[_0x3a7e37(0x124)][_0x3a7e37(0x123)](_0xc835ed),_0x3aceba=await this['globalConfigService']['getConfigs']([_0x3a7e37(0x140)])||0x30d40,_0x769457=await this[_0x3a7e37(0x130)]['add'](_0x3a7e37(0x134),{'id':_0x3e336f['id'],'action':action,'userId':_0x505e7d[_0x3a7e37(0x132)]['id']},{'delay':0x3e8,'timeout':+_0x3aceba});this['jobIds'][_0x3a7e37(0x111)](_0x769457['id']),await this['userBalanceService'][_0x3a7e37(0x13d)](_0x505e7d['user']['id'],'mjDraw',0x4,0x4);return;}if(action===0x7||action===0x8){const _0x2fac1d=await this[_0x3a7e37(0x124)][_0x3a7e37(0x137)](_0x20ce29),_0x1c9710=Object['assign'](Object['assign'](Object[_0x3a7e37(0x127)](Object[_0x3a7e37(0x127)]({},_0x181f6a),{'userId':_0x505e7d[_0x3a7e37(0x132)]['id']}),_0x2fac1d),{'action':action,'orderId':_0xd21dad,'drawId':_0x20ce29}),_0x49b023=await this[_0x3a7e37(0x124)][_0x3a7e37(0x123)](_0x1c9710),_0x33a099=await this[_0x3a7e37(0x10d)][_0x3a7e37(0x12f)]([_0x3a7e37(0x140)])||0x30d40,_0xe26152=await this['mjDrawQueue'][_0x3a7e37(0x100)](_0x3a7e37(0x134),{'id':_0x49b023['id'],'action':action,'userId':_0x505e7d['user']['id']},{'delay':0x3e8,'timeout':+_0x33a099});this['jobIds'][_0x3a7e37(0x111)](_0xe26152['id']),await this[_0x3a7e37(0xfe)][_0x3a7e37(0x13d)](_0x505e7d[_0x3a7e37(0x132)]['id'],_0x3a7e37(0x134),0x4,0x4);return;}if(action===0x6||action===0x9){const _0x4da756=await this[_0x3a7e37(0x124)]['getDrawActionDetail2'](_0x20ce29),_0x103ab8=Object[_0x3a7e37(0x127)](Object[_0x3a7e37(0x127)](Object['assign'](Object[_0x3a7e37(0x127)]({},_0x181f6a),{'userId':_0x505e7d[_0x3a7e37(0x132)]['id']}),_0x4da756),{'action':action,'orderId':_0xd21dad,'drawId':_0x20ce29}),_0x36de25=await this[_0x3a7e37(0x124)]['addDrawQueue'](_0x103ab8),_0x1b3cc0=await this[_0x3a7e37(0x10d)]['getConfigs']([_0x3a7e37(0x140)])||0x30d40,_0x2022ef=await this[_0x3a7e37(0x130)][_0x3a7e37(0x100)](_0x3a7e37(0x134),{'id':_0x36de25['id'],'action':action,'userId':_0x505e7d[_0x3a7e37(0x132)]['id']},{'delay':0x3e8,'timeout':+_0x1b3cc0});this[_0x3a7e37(0xff)]['push'](_0x2022ef['id']),await this[_0x3a7e37(0xfe)][_0x3a7e37(0x13d)](_0x505e7d[_0x3a7e37(0x132)]['id'],'mjDraw',0x4,0x4);return;};if(action===0xa||action===0xb||action===0xc||action===0xd){const _0x273e6f=await this[_0x3a7e37(0x124)]['getDrawActionDetail2'](_0x20ce29),_0x37e5dc=Object[_0x3a7e37(0x127)](Object['assign'](Object[_0x3a7e37(0x127)](Object['assign']({},_0x181f6a),{'userId':_0x505e7d[_0x3a7e37(0x132)]['id']}),_0x273e6f),{'action':action,'orderId':_0xd21dad,'drawId':_0x20ce29}),_0x4e4a76=await this[_0x3a7e37(0x124)][_0x3a7e37(0x123)](_0x37e5dc),_0x201573=await this[_0x3a7e37(0x10d)]['getConfigs']([_0x3a7e37(0x140)])||0x30d40,_0x25cb47=await this['mjDrawQueue'][_0x3a7e37(0x100)](_0x3a7e37(0x134),{'id':_0x4e4a76['id'],'action':action,'userId':_0x505e7d[_0x3a7e37(0x132)]['id']},{'delay':0x3e8,'timeout':+_0x201573});this['jobIds'][_0x3a7e37(0x111)](_0x25cb47['id']),await this[_0x3a7e37(0xfe)][_0x3a7e37(0x13d)](_0x505e7d[_0x3a7e37(0x132)]['id'],'mjDraw',0x4,0x4);return;};if(action===0xf){const _0x6c7049=await this[_0x3a7e37(0x124)][_0x3a7e37(0x135)](_0x20ce29),_0x2d9052=Object[_0x3a7e37(0x127)](Object[_0x3a7e37(0x127)](Object['assign'](Object[_0x3a7e37(0x127)]({},_0x181f6a),{'userId':_0x505e7d[_0x3a7e37(0x132)]['id']}),_0x6c7049),{'action':action,'orderId':_0xd21dad,'drawId':_0x20ce29}),_0x3d8484=await this[_0x3a7e37(0x124)][_0x3a7e37(0x13e)](_0x2d9052),_0x520c48=await this[_0x3a7e37(0x10d)][_0x3a7e37(0x12f)](['mjTimeoutMs'])||0x30d40,_0x36ae36=await this['mjDrawQueue'][_0x3a7e37(0x100)]('mjDraw',{'id':_0x3d8484['id'],'action':action,'userId':_0x505e7d[_0x3a7e37(0x132)]['id']},{'delay':0x3e8,'timeout':+_0x520c48});this['jobIds'][_0x3a7e37(0x111)](_0x36ae36['id']),await this['userBalanceService'][_0x3a7e37(0x13d)](_0x505e7d[_0x3a7e37(0x132)]['id'],'mjDraw',0x4,0x4);return;};}async['getQueue'](){const _0x5a1aaf=_0x367c89;return{'jobIds':this[_0x5a1aaf(0xff)]};}};QueueService=__decorate([__param(0x0,(0x0,bull_1[_0x367c89(0x102)])('MJDRAW')),__metadata(_0x367c89(0x114),[Object,midjourney_service_1[_0x367c89(0x113)],userBalance_service_1[_0x367c89(0x119)],globalConfig_service_1['GlobalConfigService']])],QueueService),exports[_0x367c89(0x10c)]=QueueService;