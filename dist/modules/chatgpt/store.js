'use strict';const _0x33be8d=_0x54f4;function _0x16c1(){const _0x2bc6a3=['1566537sFCYzk','max','@dqbd/tiktoken','concat','491770rwqUyO','replace','get','splice','_recursivePruning','slice','store','namespace','setData','getUuid','cl100k_base','uuid','encode','set','120552IPHcxR','system','defineProperty','1715344PssbBu','95ZyPCJc','18kSUpoq','expires','getData','252900PaAyXa','get_encoding','NineStore','length','3371358OcUfSN','content','reduce','user','_getTokenCount','6NdKCVE','formatOptions','min','本次携带上下文的长度','chat','generateKey','__esModule','buildMessageFromParentMessageId','22dLHjzx','138700omnCJp'];_0x16c1=function(){return _0x2bc6a3;};return _0x16c1();}function _0x54f4(_0x31a229,_0xd12223){const _0x16c114=_0x16c1();return _0x54f4=function(_0x54f49c,_0x37aea4){_0x54f49c=_0x54f49c-0x1ca;let _0x33d92d=_0x16c114[_0x54f49c];return _0x33d92d;},_0x54f4(_0x31a229,_0xd12223);}(function(_0x235283,_0x3025f9){const _0x1dc7dc=_0x54f4,_0x1cf9ed=_0x235283();while(!![]){try{const _0x4355fb=parseInt(_0x1dc7dc(0x1d4))/0x1+-parseInt(_0x1dc7dc(0x1cb))/0x2*(parseInt(_0x1dc7dc(0x1ef))/0x3)+-parseInt(_0x1dc7dc(0x1e7))/0x4*(parseInt(_0x1dc7dc(0x1eb))/0x5)+parseInt(_0x1dc7dc(0x1f3))/0x6+parseInt(_0x1dc7dc(0x1d5))/0x7+-parseInt(_0x1dc7dc(0x1ea))/0x8*(-parseInt(_0x1dc7dc(0x1ec))/0x9)+-parseInt(_0x1dc7dc(0x1d9))/0xa*(parseInt(_0x1dc7dc(0x1d3))/0xb);if(_0x4355fb===_0x3025f9)break;else _0x1cf9ed['push'](_0x1cf9ed['shift']());}catch(_0x3b9eec){_0x1cf9ed['push'](_0x1cf9ed['shift']());}}}(_0x16c1,0x68d20));Object[_0x33be8d(0x1e9)](exports,_0x33be8d(0x1d1),{'value':!![]}),exports['NineStore']=void 0x0;const uuid_1=require(_0x33be8d(0x1e4)),tiktoken_1=require(_0x33be8d(0x1d7)),tokenizer=(0x0,tiktoken_1[_0x33be8d(0x1f0)])(_0x33be8d(0x1e3));class NineStore{constructor(_0x346dcd){const _0x15495e=_0x33be8d,{store:_0x5cc3e6,namespace:_0x46ac48,expires:_0x19002d}=this[_0x15495e(0x1cc)](_0x346dcd);this[_0x15495e(0x1df)]=_0x5cc3e6,this[_0x15495e(0x1e0)]=_0x46ac48,this[_0x15495e(0x1ed)]=_0x19002d;}[_0x33be8d(0x1cc)](_0x2d9622){const _0x32da0b=_0x33be8d,{store:_0x461a68,expires:expires=0x3e8*0x3c*0x3c*0x18*0x3,namespace:namespace=_0x32da0b(0x1cf)}=_0x2d9622;return{'store':_0x461a68,'namespace':namespace,'expires':expires};}[_0x33be8d(0x1d0)](_0x4e9184){return this['namespace']?this['namespace']+'-'+_0x4e9184:_0x4e9184;}async[_0x33be8d(0x1ee)](_0x3983d6){const _0x5a4e79=_0x33be8d,_0x5d19e5=await this[_0x5a4e79(0x1df)][_0x5a4e79(0x1db)](_0x3983d6);return _0x5d19e5;}async[_0x33be8d(0x1e1)](_0x31e52e,_0x87e81d=this[_0x33be8d(0x1ed)]){const _0x414252=_0x33be8d;await this['store'][_0x414252(0x1e6)](_0x31e52e['id'],_0x31e52e,_0x87e81d);}async[_0x33be8d(0x1d2)](_0x47c3f1,_0x292b53){const _0x4c5679=_0x33be8d;let {maxRounds:_0x5f133b,maxModelToken:_0x716e95,maxResponseTokens:_0x3a4545,systemMessage:systemMessage='',name:_0x234794}=_0x292b53,{parentMessageId:_0x4da494}=_0x292b53,_0x47b1f3=[],_0x429d2c=0x0;systemMessage&&_0x47b1f3['push']({'role':_0x4c5679(0x1e8),'content':systemMessage});const _0x48b569=_0x47b1f3['length'];let _0xaf758=0x0,_0x210257=_0x47c3f1?_0x47b1f3[_0x4c5679(0x1d8)]([{'role':_0x4c5679(0x1f6),'content':_0x47c3f1,'name':_0x234794}]):_0x47b1f3;do{if(!_0x4da494)break;const _0x3da5e1=await this[_0x4c5679(0x1ee)](_0x4da494);if(!_0x3da5e1)break;const {text:_0x54f582,name:_0x42943a,role:_0x3bf32a}=_0x3da5e1;_0x210257=_0x210257['slice'](0x0,_0x48b569)[_0x4c5679(0x1d8)]([{'role':_0x3bf32a,'content':_0x54f582,'name':_0x42943a},..._0x210257[_0x4c5679(0x1de)](_0x48b569)]),_0xaf758++;if(_0x5f133b&&_0xaf758>=_0x5f133b)break;if(_0x716e95&&_0x3a4545){const _0x22508e=_0x716e95-_0x3a4545;_0x429d2c=await this[_0x4c5679(0x1ca)](_0x210257);const _0x4c8f1a=_0x429d2c+0xc8<=_0x22508e;!_0x4c8f1a&&(_0x210257=this['_recursivePruning'](_0x210257,_0x22508e,systemMessage));}_0x4da494=_0x3da5e1['parentMessageId'];}while(!![]);const _0x5b0dd9=Math[_0x4c5679(0x1d6)](0x1,Math[_0x4c5679(0x1cd)](_0x716e95-_0x429d2c,_0x3a4545));return console['log'](_0x4c5679(0x1ce),_0x210257[_0x4c5679(0x1f2)],_0x429d2c),{'context':_0x210257,'round':_0x210257[_0x4c5679(0x1f2)],'historyToken':_0x429d2c};}['_getTokenCount'](_0x1b5c50){const _0x5a8ad3=_0x33be8d;let _0x1257c8=_0x1b5c50[_0x5a8ad3(0x1f5)]((_0xba4526,_0x221b87)=>{const _0x5ddd83=_0x5a8ad3;return _0xba4526+=_0x221b87[_0x5ddd83(0x1f4)];},'');return _0x1257c8=_0x1257c8[_0x5a8ad3(0x1da)](/<\|endoftext\|>/g,''),tokenizer[_0x5a8ad3(0x1e5)](_0x1257c8)[_0x5a8ad3(0x1f2)];}['_recursivePruning'](_0x2d0f87,_0x256b07,_0x122f93){const _0x4f071d=_0x33be8d,_0xfba42a=this[_0x4f071d(0x1ca)](_0x2d0f87);if(_0xfba42a<=_0x256b07)return _0x2d0f87;return _0x2d0f87[_0x4f071d(0x1dc)](_0x122f93?0x1:0x0,0x1),this[_0x4f071d(0x1dd)](_0x2d0f87,_0x256b07,_0x122f93);}[_0x33be8d(0x1e2)](){return(0x0,uuid_1['v4'])();}}exports[_0x33be8d(0x1f1)]=NineStore;