'use strict';const _0xe3cf91=_0x2f58;(function(_0x4a6788,_0x51364f){const _0x5258ad=_0x2f58,_0x51243f=_0x4a6788();while(!![]){try{const _0x3caf71=-parseInt(_0x5258ad(0x131))/0x1*(parseInt(_0x5258ad(0x166))/0x2)+-parseInt(_0x5258ad(0x173))/0x3+parseInt(_0x5258ad(0x18d))/0x4+parseInt(_0x5258ad(0x178))/0x5+parseInt(_0x5258ad(0x12b))/0x6+-parseInt(_0x5258ad(0x174))/0x7*(-parseInt(_0x5258ad(0x180))/0x8)+-parseInt(_0x5258ad(0x142))/0x9;if(_0x3caf71===_0x51364f)break;else _0x51243f['push'](_0x51243f['shift']());}catch(_0x12577b){_0x51243f['push'](_0x51243f['shift']());}}}(_0x2908,0xa390f));function _0x2908(){const _0x29de74=['chatlog','&end_date=','orderBy','ConfigEntity','../../common/constants/midjourney.constant','请先配置百度统计accessToken','select','5476524igJWaa','getBaiduStatistics','countDrawsByTimeRange','decorate','userEntity','../../common/utils/date','20dcYGYf','__metadata','baiduToken','@nestjs/common','andWhere','setHours','MidjourneyEntity','groupBy','overview/getTimeTrendRpt','../../common/constants/balance.constant','请先配置百度统计siteId','chatLogEntity','PAINT_TYPE','chatLog.createdAt\x20>=\x20:today','typeorm','ChatLogEntity','baiduSiteId','12330288cbJXfN','default','countNewChatsToday','../globalConfig/config.entity','__decorate','chatLog.createdAt\x20<\x20:tomorrow','countNewUsersToday','data','get','countChatsByTimeRange','HttpStatus','StatisticService','order.createdAt\x20<\x20:tomorrow','getTime','countNewOrdersToday','getChatStatistic','M.DD','Repository','order.createdAt\x20>=\x20:today','获取百度统计数据失败','find','../user/user.entity','setDate','&site_id=','pv_count,visitor_count,ip_count,bounce_ratio,avg_visit_time','push','countOrders','user.createdAt\x20<\x20:tomorrow','chatLog','midjourneyEntity','orderEntity','getDate','configKey','date','configVal','value','61764nMlwVp','getCount','chatlog.type\x20=\x20:type','defineProperty','user.createdAt\x20>=\x20:today','../midjourney/midjourney.entity','count','DATE(chatlog.createdAt)\x20as\x20date,\x20COUNT(*)\x20as\x20count','&metrics=','getRawMany','result','getOwnPropertyDescriptor','metadata','2073273SYURzm','3537065qrgIkJ','createQueryBuilder','midjourney.createdAt\x20>=\x20:startDate','InjectRepository','4836570pxIdwx','countNewMidhourneysToday','now','where','design:paramtypes','CHAT_TYPE','chatlog.createdAt\x20>=\x20:startDate','OrderEntity','8JBwhDQ','https://openapi.baidu.com/rest/2.0/tongji/report/getData?access_token=','map','countDraws','configEntity','countUsers','formatDate','@nestjs/typeorm','order','YYYYMMDD','HttpException','countChats','length','3853468Mjramt','BAD_REQUEST','object','getBaseStatistic','midjourney','midjourney.createdAt\x20<\x20:tomorrow','../chatLog/chatLog.entity','getBaiduVisit','DATE(midjourney.createdAt)\x20as\x20date,\x20COUNT(*)\x20as\x20count','DeductionKey','midjourney.status\x20=\x20:status'];_0x2908=function(){return _0x29de74;};return _0x2908();}function _0x2f58(_0x4fb8d4,_0x342f3a){const _0x290847=_0x2908();return _0x2f58=function(_0x2f5883,_0x25276f){_0x2f5883=_0x2f5883-0x126;let _0x3e38c2=_0x290847[_0x2f5883];return _0x3e38c2;},_0x2f58(_0x4fb8d4,_0x342f3a);}var __decorate=this&&this[_0xe3cf91(0x146)]||function(_0x5d441e,_0xcf1dc0,_0xc2a615,_0x32dbbd){const _0x3565cc=_0xe3cf91;var _0x38196f=arguments[_0x3565cc(0x18c)],_0x4f5137=_0x38196f<0x3?_0xcf1dc0:_0x32dbbd===null?_0x32dbbd=Object[_0x3565cc(0x171)](_0xcf1dc0,_0xc2a615):_0x32dbbd,_0x15f64e;if(typeof Reflect===_0x3565cc(0x18f)&&typeof Reflect['decorate']==='function')_0x4f5137=Reflect[_0x3565cc(0x12e)](_0x5d441e,_0xcf1dc0,_0xc2a615,_0x32dbbd);else{for(var _0x196eba=_0x5d441e[_0x3565cc(0x18c)]-0x1;_0x196eba>=0x0;_0x196eba--)if(_0x15f64e=_0x5d441e[_0x196eba])_0x4f5137=(_0x38196f<0x3?_0x15f64e(_0x4f5137):_0x38196f>0x3?_0x15f64e(_0xcf1dc0,_0xc2a615,_0x4f5137):_0x15f64e(_0xcf1dc0,_0xc2a615))||_0x4f5137;}return _0x38196f>0x3&&_0x4f5137&&Object[_0x3565cc(0x169)](_0xcf1dc0,_0xc2a615,_0x4f5137),_0x4f5137;},__metadata=this&&this[_0xe3cf91(0x132)]||function(_0x29e8d2,_0x188818){const _0x51cecf=_0xe3cf91;if(typeof Reflect===_0x51cecf(0x18f)&&typeof Reflect['metadata']==='function')return Reflect[_0x51cecf(0x172)](_0x29e8d2,_0x188818);},__param=this&&this['__param']||function(_0x8efef3,_0x256245){return function(_0xade361,_0x2eca2a){_0x256245(_0xade361,_0x2eca2a,_0x8efef3);};};Object['defineProperty'](exports,'__esModule',{'value':!![]}),exports[_0xe3cf91(0x14d)]=void 0x0;const common_1=require(_0xe3cf91(0x134)),typeorm_1=require(_0xe3cf91(0x187)),user_entity_1=require(_0xe3cf91(0x157)),typeorm_2=require(_0xe3cf91(0x13f)),chatLog_entity_1=require(_0xe3cf91(0x193)),balance_constant_1=require(_0xe3cf91(0x13a)),date_1=require(_0xe3cf91(0x130)),axios_1=require('axios'),config_entity_1=require(_0xe3cf91(0x145)),order_entity_1=require('../order/order.entity'),midjourney_entity_1=require(_0xe3cf91(0x16b)),midjourney_constant_1=require(_0xe3cf91(0x128));let StatisticService=class StatisticService{constructor(_0x34159b,_0x1ac404,_0x26bcf9,_0x56da1a,_0x351123){const _0x5df80f=_0xe3cf91;this[_0x5df80f(0x12f)]=_0x34159b,this[_0x5df80f(0x13c)]=_0x1ac404,this['configEntity']=_0x26bcf9,this[_0x5df80f(0x160)]=_0x56da1a,this[_0x5df80f(0x15f)]=_0x351123;}async[_0xe3cf91(0x190)](){const _0xc15127=_0xe3cf91,_0x3aea4c=await this[_0xc15127(0x185)](),_0x1194cc=await this[_0xc15127(0x148)](),_0x3c9981=await this[_0xc15127(0x18b)](),_0x3740c6=await this[_0xc15127(0x144)](),_0x4c235a=await this[_0xc15127(0x183)](),_0x5eaecb=await this['countNewDrawsToday'](),_0x488bbb=await this[_0xc15127(0x179)](),_0x545dad=await this[_0xc15127(0x15c)](),_0x430e1e=await this[_0xc15127(0x150)]();return{'userCount':_0x3aea4c,'newUserCount':_0x1194cc,'chatCount':_0x3c9981,'newChatCount':_0x3740c6,'drawCount':_0x4c235a,'newDrawCount':_0x488bbb+_0x5eaecb,'orderCount':_0x545dad,'newOrderCount':_0x430e1e};}async[_0xe3cf91(0x151)]({days:days=0x7}){const _0x342648=_0xe3cf91,_0x2dadd3=await this[_0x342648(0x14b)](days),_0x249165=await this[_0x342648(0x12d)](days),_0x1c1fab=await this['countMjDrawsByTimeRange'](days);return{'date':_0x2dadd3[_0x342648(0x182)](_0x49b873=>_0x49b873[_0x342648(0x163)]),'chat':_0x2dadd3[_0x342648(0x182)](_0x5ad95c=>_0x5ad95c['value']),'draw':_0x249165[_0x342648(0x182)]((_0x36e235,_0x1d4bc6)=>{const _0x44586d=_0x342648;return _0x36e235[_0x44586d(0x165)]+_0x1c1fab[_0x1d4bc6][_0x44586d(0x165)];})};}async[_0xe3cf91(0x194)]({days:days=0x7}){const _0x33cfd0=await this['getBaiduStatistics'](days);return _0x33cfd0;}async[_0xe3cf91(0x185)](){const _0x4261bb=_0xe3cf91,_0x450804=await this[_0x4261bb(0x12f)]['count']();return _0x450804;}async[_0xe3cf91(0x148)](){const _0x4526a0=_0xe3cf91,_0x2fc06a=new Date();_0x2fc06a[_0x4526a0(0x136)](0x0,0x0,0x0,0x0);const _0xadda2c=new Date(_0x2fc06a[_0x4526a0(0x14f)]()+0x18*0x3c*0x3c*0x3e8),_0x50b6c3=this[_0x4526a0(0x12f)]['createQueryBuilder']('user'),_0x3cbe4b=await _0x50b6c3['where'](_0x4526a0(0x16a),{'today':_0x2fc06a})[_0x4526a0(0x135)](_0x4526a0(0x15d),{'tomorrow':_0xadda2c})['getCount']();return _0x3cbe4b;}async[_0xe3cf91(0x18b)](){const _0x3ac1ad=_0xe3cf91,_0x312035=await this[_0x3ac1ad(0x13c)][_0x3ac1ad(0x16c)]({'where':{'type':balance_constant_1[_0x3ac1ad(0x196)][_0x3ac1ad(0x17d)]}});return _0x312035;}async[_0xe3cf91(0x144)](){const _0x3d366e=_0xe3cf91,_0x3d1369=new Date();_0x3d1369['setHours'](0x0,0x0,0x0,0x0);const _0x51cc08=new Date(_0x3d1369[_0x3d366e(0x14f)]()+0x18*0x3c*0x3c*0x3e8),_0x1c8fd7=this[_0x3d366e(0x13c)][_0x3d366e(0x175)](_0x3d366e(0x15e)),_0x40d204=await _0x1c8fd7['where']('chatLog.type\x20=\x20:type',{'type':balance_constant_1[_0x3d366e(0x196)][_0x3d366e(0x17d)]})[_0x3d366e(0x135)](_0x3d366e(0x13e),{'today':_0x3d1369})[_0x3d366e(0x135)](_0x3d366e(0x147),{'tomorrow':_0x51cc08})[_0x3d366e(0x167)]();return _0x40d204;}async[_0xe3cf91(0x183)](){const _0x522c59=_0xe3cf91,_0x486f22=await this[_0x522c59(0x13c)][_0x522c59(0x16c)]({'where':{'type':balance_constant_1[_0x522c59(0x196)][_0x522c59(0x13d)]}});return _0x486f22;}async['countNewDrawsToday'](){const _0x3dae0a=_0xe3cf91,_0xa0baa9=new Date();_0xa0baa9[_0x3dae0a(0x136)](0x0,0x0,0x0,0x0);const _0x4d10ac=new Date(_0xa0baa9['getTime']()+0x18*0x3c*0x3c*0x3e8),_0x50b641=this['chatLogEntity'][_0x3dae0a(0x175)](_0x3dae0a(0x15e)),_0x34c4f1=await _0x50b641[_0x3dae0a(0x17b)]('chatLog.type\x20=\x20:type',{'type':balance_constant_1[_0x3dae0a(0x196)][_0x3dae0a(0x13d)]})['andWhere']('chatLog.createdAt\x20>=\x20:today',{'today':_0xa0baa9})[_0x3dae0a(0x135)]('chatLog.createdAt\x20<\x20:tomorrow',{'tomorrow':_0x4d10ac})[_0x3dae0a(0x167)]();return _0x34c4f1;}async['countNewMidhourneysToday'](){const _0x3a6e4b=_0xe3cf91,_0x5dc307=new Date();_0x5dc307[_0x3a6e4b(0x136)](0x0,0x0,0x0,0x0);const _0x1ad0a8=new Date(_0x5dc307[_0x3a6e4b(0x14f)]()+0x18*0x3c*0x3c*0x3e8),_0x157889=this[_0x3a6e4b(0x15f)]['createQueryBuilder'](_0x3a6e4b(0x191)),_0x3774dc=await _0x157889['where']('midjourney.createdAt\x20>=\x20:today',{'today':_0x5dc307})['andWhere'](_0x3a6e4b(0x192),{'tomorrow':_0x1ad0a8})[_0x3a6e4b(0x167)]();return _0x3774dc;}async[_0xe3cf91(0x14b)](_0x2477e0){const _0x4cbeff=_0xe3cf91;var _0x5ee7e1,_0x165354;const _0xb7524c=new Date();_0xb7524c[_0x4cbeff(0x136)](0x0,0x0,0x0,0x0);const _0x41838b=new Date(_0xb7524c['getTime']()-(_0x2477e0-0x1)*0x18*0x3c*0x3c*0x3e8),_0x2ee305=this[_0x4cbeff(0x13c)][_0x4cbeff(0x175)](_0x4cbeff(0x198)),_0x1a7480=await _0x2ee305['select'](_0x4cbeff(0x16d))[_0x4cbeff(0x17b)](_0x4cbeff(0x168),{'type':balance_constant_1[_0x4cbeff(0x196)]['CHAT_TYPE']})[_0x4cbeff(0x135)](_0x4cbeff(0x17e),{'startDate':_0x41838b})['groupBy']('date')[_0x4cbeff(0x126)](_0x4cbeff(0x163))[_0x4cbeff(0x16f)](),_0xacca5d=[],_0x4df467=_0x41838b;for(let _0x2d5d58=0x0;_0x2d5d58<_0x2477e0;_0x2d5d58++){const _0x47d3c0=(0x0,date_1[_0x4cbeff(0x186)])(new Date(_0x4df467),'M.DD'),_0x40a22c=(_0x165354=(_0x5ee7e1=_0x1a7480['find'](_0x586095=>(0x0,date_1[_0x4cbeff(0x186)])(new Date(_0x586095['date']),'M.DD')===_0x47d3c0))===null||_0x5ee7e1===void 0x0?void 0x0:_0x5ee7e1[_0x4cbeff(0x16c)])!==null&&_0x165354!==void 0x0?_0x165354:0x0;_0x40a22c>0x0?_0xacca5d[_0x4cbeff(0x15b)]({'date':_0x47d3c0,'value':Number(_0x40a22c)}):_0xacca5d[_0x4cbeff(0x15b)]({'date':_0x47d3c0,'value':0x0}),_0x4df467[_0x4cbeff(0x158)](_0x4df467[_0x4cbeff(0x161)]()+0x1);}return _0xacca5d;}async[_0xe3cf91(0x12d)](_0x43fd28){const _0x24f4a3=_0xe3cf91;var _0x27860a,_0xb06fa5;const _0x1799ce=new Date();_0x1799ce['setHours'](0x0,0x0,0x0,0x0);const _0x351fd9=new Date(_0x1799ce[_0x24f4a3(0x14f)]()-(_0x43fd28-0x1)*0x18*0x3c*0x3c*0x3e8),_0x380fb3=this[_0x24f4a3(0x13c)][_0x24f4a3(0x175)](_0x24f4a3(0x198)),_0x4ee4be=await _0x380fb3['select'](_0x24f4a3(0x16d))['where'](_0x24f4a3(0x168),{'type':balance_constant_1[_0x24f4a3(0x196)]['PAINT_TYPE']})['andWhere']('chatlog.createdAt\x20>=\x20:startDate',{'startDate':_0x351fd9})[_0x24f4a3(0x138)](_0x24f4a3(0x163))[_0x24f4a3(0x126)](_0x24f4a3(0x163))[_0x24f4a3(0x16f)](),_0xc3283f=[],_0x16441b=_0x351fd9;for(let _0x5a4420=0x0;_0x5a4420<_0x43fd28;_0x5a4420++){const _0x1cb881=(0x0,date_1[_0x24f4a3(0x186)])(new Date(_0x16441b),'M.DD'),_0x268b71=(_0xb06fa5=(_0x27860a=_0x4ee4be[_0x24f4a3(0x156)](_0x4eac2e=>(0x0,date_1[_0x24f4a3(0x186)])(new Date(_0x4eac2e[_0x24f4a3(0x163)]),_0x24f4a3(0x152))===_0x1cb881))===null||_0x27860a===void 0x0?void 0x0:_0x27860a[_0x24f4a3(0x16c)])!==null&&_0xb06fa5!==void 0x0?_0xb06fa5:0x0;_0x268b71>0x0?_0xc3283f['push']({'date':_0x1cb881,'value':Number(_0x268b71)}):_0xc3283f[_0x24f4a3(0x15b)]({'date':_0x1cb881,'value':0x0}),_0x16441b[_0x24f4a3(0x158)](_0x16441b[_0x24f4a3(0x161)]()+0x1);}return _0xc3283f;}async['countMjDrawsByTimeRange'](_0xe3a8fd){const _0x159bcc=_0xe3cf91;var _0x353869,_0x526222;const _0x3a3633=new Date();_0x3a3633[_0x159bcc(0x136)](0x0,0x0,0x0,0x0);const _0x5083c3=new Date(_0x3a3633[_0x159bcc(0x14f)]()-(_0xe3a8fd-0x1)*0x18*0x3c*0x3c*0x3e8),_0x5e3069=this[_0x159bcc(0x15f)][_0x159bcc(0x175)](_0x159bcc(0x191)),_0x5d90a0=await _0x5e3069[_0x159bcc(0x12a)](_0x159bcc(0x195))[_0x159bcc(0x17b)](_0x159bcc(0x197),{'status':midjourney_constant_1['MidjourneyStatusEnum']['DRAWED']})[_0x159bcc(0x135)](_0x159bcc(0x176),{'startDate':_0x5083c3})[_0x159bcc(0x138)](_0x159bcc(0x163))[_0x159bcc(0x126)](_0x159bcc(0x163))[_0x159bcc(0x16f)](),_0x32b75c=[],_0x47867e=_0x5083c3;for(let _0x28060f=0x0;_0x28060f<_0xe3a8fd;_0x28060f++){const _0x297856=(0x0,date_1['formatDate'])(new Date(_0x47867e),_0x159bcc(0x152)),_0x3a32cf=(_0x526222=(_0x353869=_0x5d90a0[_0x159bcc(0x156)](_0x4cedff=>(0x0,date_1['formatDate'])(new Date(_0x4cedff[_0x159bcc(0x163)]),_0x159bcc(0x152))===_0x297856))===null||_0x353869===void 0x0?void 0x0:_0x353869[_0x159bcc(0x16c)])!==null&&_0x526222!==void 0x0?_0x526222:0x0;_0x3a32cf>0x0?_0x32b75c[_0x159bcc(0x15b)]({'date':_0x297856,'value':Number(_0x3a32cf)}):_0x32b75c[_0x159bcc(0x15b)]({'date':_0x297856,'value':0x0}),_0x47867e[_0x159bcc(0x158)](_0x47867e[_0x159bcc(0x161)]()+0x1);}return _0x32b75c;}async[_0xe3cf91(0x12c)](_0x5454df){const _0x3563e0=_0xe3cf91;var _0x5033ea,_0x149e5b;const _0x3faa41=(0x0,date_1[_0x3563e0(0x186)])(new Date(),_0x3563e0(0x189)),_0x3caf2f=(0x0,date_1[_0x3563e0(0x186)])(new Date(Date[_0x3563e0(0x17a)]()-Number(_0x5454df-0x1)*0x18*0x3c*0x3c*0x3e8),'YYYYMMDD'),_0x3b2101=_0x3563e0(0x15a),_0x5ce191=_0x3563e0(0x139),_0x5d4029=await this[_0x3563e0(0x184)][_0x3563e0(0x156)]({'where':{'configKey':(0x0,typeorm_2['In'])([_0x3563e0(0x133),_0x3563e0(0x141)])}}),_0x57bb09=(_0x5033ea=_0x5d4029[_0x3563e0(0x156)](_0x2edcc5=>_0x2edcc5[_0x3563e0(0x162)]===_0x3563e0(0x141)))===null||_0x5033ea===void 0x0?void 0x0:_0x5033ea[_0x3563e0(0x164)],_0x190fc5=(_0x149e5b=_0x5d4029[_0x3563e0(0x156)](_0x562b49=>_0x562b49[_0x3563e0(0x162)]===_0x3563e0(0x133)))===null||_0x149e5b===void 0x0?void 0x0:_0x149e5b[_0x3563e0(0x164)];if(!_0x57bb09||!_0x190fc5)return[];if(!_0x57bb09)throw new common_1['HttpException'](_0x3563e0(0x13b),common_1[_0x3563e0(0x14c)][_0x3563e0(0x18e)]);if(!_0x190fc5)throw new common_1['HttpException'](_0x3563e0(0x129),common_1[_0x3563e0(0x14c)][_0x3563e0(0x18e)]);const _0x11ff1f=_0x3563e0(0x181)+_0x190fc5+_0x3563e0(0x159)+_0x57bb09+'&method='+_0x5ce191+'&start_date='+_0x3caf2f+_0x3563e0(0x199)+_0x3faa41+_0x3563e0(0x16e)+_0x3b2101,_0x3dd5cd=await axios_1[_0x3563e0(0x143)][_0x3563e0(0x14a)](_0x11ff1f),{error_code:_0x4fff1a,message:_0x1bc786}=_0x3dd5cd[_0x3563e0(0x149)];if(_0x4fff1a===0x6f)throw new common_1[(_0x3563e0(0x18a))](_0x1bc786||'百度授权码过期',common_1['HttpStatus'][_0x3563e0(0x18e)]);if(_0x4fff1a&&_0x4fff1a!==0xc8)throw new common_1[(_0x3563e0(0x18a))](_0x1bc786||_0x3563e0(0x155),common_1['HttpStatus'][_0x3563e0(0x18e)]);return _0x3dd5cd['data'][_0x3563e0(0x170)];}async[_0xe3cf91(0x15c)](){const _0x347e96=_0xe3cf91,_0x46acc8=await this[_0x347e96(0x160)][_0x347e96(0x16c)]();return _0x46acc8;}async[_0xe3cf91(0x150)](){const _0x365eab=_0xe3cf91,_0x2e62ce=new Date();_0x2e62ce['setHours'](0x0,0x0,0x0,0x0);const _0x3da598=new Date(_0x2e62ce[_0x365eab(0x14f)]()+0x18*0x3c*0x3c*0x3e8),_0xa81b6b=this[_0x365eab(0x160)][_0x365eab(0x175)](_0x365eab(0x188)),_0x3a24ec=await _0xa81b6b[_0x365eab(0x17b)](_0x365eab(0x154),{'today':_0x2e62ce})[_0x365eab(0x135)](_0x365eab(0x14e),{'tomorrow':_0x3da598})[_0x365eab(0x167)]();return _0x3a24ec;}};StatisticService=__decorate([(0x0,common_1['Injectable'])(),__param(0x0,(0x0,typeorm_1[_0xe3cf91(0x177)])(user_entity_1['UserEntity'])),__param(0x1,(0x0,typeorm_1[_0xe3cf91(0x177)])(chatLog_entity_1[_0xe3cf91(0x140)])),__param(0x2,(0x0,typeorm_1['InjectRepository'])(config_entity_1[_0xe3cf91(0x127)])),__param(0x3,(0x0,typeorm_1['InjectRepository'])(order_entity_1[_0xe3cf91(0x17f)])),__param(0x4,(0x0,typeorm_1[_0xe3cf91(0x177)])(midjourney_entity_1[_0xe3cf91(0x137)])),__metadata(_0xe3cf91(0x17c),[typeorm_2['Repository'],typeorm_2[_0xe3cf91(0x153)],typeorm_2[_0xe3cf91(0x153)],typeorm_2[_0xe3cf91(0x153)],typeorm_2[_0xe3cf91(0x153)]])],StatisticService),exports[_0xe3cf91(0x14d)]=StatisticService;