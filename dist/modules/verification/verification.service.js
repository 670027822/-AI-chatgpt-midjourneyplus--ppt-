'use strict';const _0x399f0f=_0x4623;(function(_0x1f2587,_0x29fc6d){const _0x534e33=_0x4623,_0x48a84b=_0x1f2587();while(!![]){try{const _0x172430=parseInt(_0x534e33(0x200))/0x1*(-parseInt(_0x534e33(0x228))/0x2)+-parseInt(_0x534e33(0x208))/0x3*(parseInt(_0x534e33(0x225))/0x4)+parseInt(_0x534e33(0x207))/0x5+parseInt(_0x534e33(0x206))/0x6*(parseInt(_0x534e33(0x1f8))/0x7)+-parseInt(_0x534e33(0x23b))/0x8*(-parseInt(_0x534e33(0x202))/0x9)+parseInt(_0x534e33(0x232))/0xa*(-parseInt(_0x534e33(0x234))/0xb)+parseInt(_0x534e33(0x201))/0xc*(parseInt(_0x534e33(0x20f))/0xd);if(_0x172430===_0x29fc6d)break;else _0x48a84b['push'](_0x48a84b['shift']());}catch(_0x18eeb2){_0x48a84b['push'](_0x48a84b['shift']());}}}(_0x519d,0xec6dd));function _0x4623(_0x654cbc,_0x28c49a){const _0x519d14=_0x519d();return _0x4623=function(_0x462313,_0x5d77c7){_0x462313=_0x462313-0x1f4;let _0x148edb=_0x519d14[_0x462313];return _0x148edb;},_0x4623(_0x654cbc,_0x28c49a);}var __decorate=this&&this[_0x399f0f(0x217)]||function(_0x3f9564,_0x411759,_0x296b28,_0x3bc0d5){const _0x1d9030=_0x399f0f;var _0x48cb3f=arguments[_0x1d9030(0x209)],_0x4d101d=_0x48cb3f<0x3?_0x411759:_0x3bc0d5===null?_0x3bc0d5=Object['getOwnPropertyDescriptor'](_0x411759,_0x296b28):_0x3bc0d5,_0x2db8ae;if(typeof Reflect==='object'&&typeof Reflect['decorate']===_0x1d9030(0x239))_0x4d101d=Reflect[_0x1d9030(0x20c)](_0x3f9564,_0x411759,_0x296b28,_0x3bc0d5);else{for(var _0x402c69=_0x3f9564[_0x1d9030(0x209)]-0x1;_0x402c69>=0x0;_0x402c69--)if(_0x2db8ae=_0x3f9564[_0x402c69])_0x4d101d=(_0x48cb3f<0x3?_0x2db8ae(_0x4d101d):_0x48cb3f>0x3?_0x2db8ae(_0x411759,_0x296b28,_0x4d101d):_0x2db8ae(_0x411759,_0x296b28))||_0x4d101d;}return _0x48cb3f>0x3&&_0x4d101d&&Object['defineProperty'](_0x411759,_0x296b28,_0x4d101d),_0x4d101d;},__metadata=this&&this['__metadata']||function(_0x4a6389,_0x3e6710){const _0x2cd42b=_0x399f0f;if(typeof Reflect===_0x2cd42b(0x221)&&typeof Reflect[_0x2cd42b(0x1f4)]==='function')return Reflect[_0x2cd42b(0x1f4)](_0x4a6389,_0x3e6710);},__param=this&&this[_0x399f0f(0x235)]||function(_0x4cf974,_0x1b4564){return function(_0x21cefb,_0x2679b3){_0x1b4564(_0x21cefb,_0x2679b3,_0x4cf974);};};Object[_0x399f0f(0x21a)](exports,_0x399f0f(0x20a),{'value':!![]}),exports[_0x399f0f(0x1fa)]=void 0x0;const globalConfig_service_1=require(_0x399f0f(0x1f6)),status_constant_1=require(_0x399f0f(0x1f5)),typeorm_1=require(_0x399f0f(0x233)),typeorm_2=require(_0x399f0f(0x22a)),verifycation_entity_1=require(_0x399f0f(0x211)),common_1=require(_0x399f0f(0x21e)),utils_1=require(_0x399f0f(0x216)),redisCache_service_1=require(_0x399f0f(0x21b)),Core=require(_0x399f0f(0x1f9));function _0x519d(){const _0x25451e=['globalConfigService','typeorm','code','expiresAt','GlobalConfigService','verifyCaptcha','design:paramtypes','createVerification','used','11990030ywnuLb','@nestjs/typeorm','11usmkFp','__param','Message','verifycationEntity','BAD_REQUEST','function','InjectRepository','15496zfGlrM','metadata','./../../common/constants/status.constant','../globalConfig/globalConfig.service','stringify','2439815AOYXUk','@alicloud/pop-core','VerificationService','Injectable','get','HttpException','USED',':CAPTCHA:','1234ACPlJl','12PhLMGL','1071VoAuJM','VerificationUseStatusEnum','verifyCode','createdAt','6CmWxwN','4854465yKsocM','1945536oDSWom','length','__esModule','Code','decorate','VerifycationEntity','del','17821401RTjyke','当前验证码已被使用！','./verifycation.entity','https://dysmsapi.aliyuncs.com','DESC','S内不得重新发送','验证码发送失败！','../../common/utils','__decorate','getTime','redisCacheService','defineProperty','../redisCache/redisCache.service','HttpStatus','验证码不存在','@nestjs/common','now','getPhoneVerifyConfig','object','2017-05-25','图形验证码已过期、请重新输入!','POST','4TOCMoB','RedisCacheService','update','170dVGnUE'];_0x519d=function(){return _0x25451e;};return _0x519d();}let VerificationService=class VerificationService{constructor(_0x1dcf6b,_0x59d0e5,_0x16ef3a){const _0x27e5dc=_0x399f0f;this[_0x27e5dc(0x237)]=_0x1dcf6b,this[_0x27e5dc(0x229)]=_0x59d0e5,this[_0x27e5dc(0x219)]=_0x16ef3a;}async[_0x399f0f(0x230)](_0x4e2a51,_0x24b514,_0x58c9ed=0x1e*0x3c){const _0x1fad3b=_0x399f0f,_0x3c5f64=await this[_0x1fad3b(0x237)]['findOne']({'where':{'userId':_0x4e2a51['id'],'type':_0x24b514},'order':{'createdAt':_0x1fad3b(0x213)}});if(_0x3c5f64&&_0x3c5f64[_0x1fad3b(0x205)][_0x1fad3b(0x218)]()+0x1*0x3c*0x3e8>Date[_0x1fad3b(0x21f)]()){const _0xa9d26d=Math['ceil']((_0x3c5f64[_0x1fad3b(0x205)]['getTime']()+0x1*0x3c*0x3e8-Date['now']())/0x3e8);throw new common_1['HttpException'](_0xa9d26d+_0x1fad3b(0x214),common_1[_0x1fad3b(0x21c)][_0x1fad3b(0x238)]);}const _0x7ea372=(0x0,utils_1['createRandomCode'])(),_0x2bb2d1=new Date(Date[_0x1fad3b(0x21f)]()+_0x58c9ed*0x3e8),{id:_0x3e0f46,email:_0x412c39}=_0x4e2a51,_0x2a3665={'userId':_0x3e0f46,'type':_0x24b514,'code':_0x7ea372,'expiresAt':_0x2bb2d1,'email':_0x412c39};return await this[_0x1fad3b(0x237)]['save'](_0x2a3665);}async[_0x399f0f(0x204)]({code:_0x4a6c8a,id:_0x286251},_0x3e2ebb){const _0x526486=_0x399f0f,_0x474f20=await this[_0x526486(0x237)]['findOne']({'where':{'id':_0x286251,'type':_0x3e2ebb},'order':{'createdAt':'DESC'}});if(!_0x474f20)throw new common_1[(_0x526486(0x1fd))](_0x526486(0x21d),common_1['HttpStatus'][_0x526486(0x238)]);if(_0x474f20[_0x526486(0x231)]===status_constant_1[_0x526486(0x203)][_0x526486(0x1fe)])throw new common_1[(_0x526486(0x1fd))](_0x526486(0x210),common_1[_0x526486(0x21c)][_0x526486(0x238)]);else _0x474f20['used']=status_constant_1[_0x526486(0x203)][_0x526486(0x1fe)],await this[_0x526486(0x237)][_0x526486(0x227)]({'id':_0x286251},_0x474f20);if(Number(_0x474f20[_0x526486(0x22b)])!==Number(_0x4a6c8a))throw new common_1['HttpException']('验证码错误',common_1[_0x526486(0x21c)][_0x526486(0x238)]);if(_0x474f20[_0x526486(0x22c)]<new Date())throw new common_1[(_0x526486(0x1fd))]('验证码已过期',common_1[_0x526486(0x21c)][_0x526486(0x238)]);return _0x474f20;}async[_0x399f0f(0x22e)](_0x280fd3){const _0xbad1c4=_0x399f0f,{captchaId:_0x13d01d,captchaCode:_0x2baf05}=_0x280fd3,_0x373091=await this[_0xbad1c4(0x229)]['getNamespace'](),_0x49f019=_0x373091+_0xbad1c4(0x1ff)+_0x13d01d,_0x1456d6=await this[_0xbad1c4(0x219)][_0xbad1c4(0x1fc)]({'key':_0x49f019});await this['redisCacheService'][_0xbad1c4(0x20e)]({'key':_0x49f019});if(!_0x1456d6)throw new common_1[(_0xbad1c4(0x1fd))](_0xbad1c4(0x223),common_1[_0xbad1c4(0x21c)][_0xbad1c4(0x238)]);if(!_0x1456d6||_0x1456d6!==_0x2baf05)throw new common_1[(_0xbad1c4(0x1fd))]('图形验证码错误、请检查填写!',common_1['HttpStatus'][_0xbad1c4(0x238)]);}async['sendPhoneCode'](_0x35c619){const _0x206688=_0x399f0f;var _0x1ec1f0;const {accessKeyId:_0x1dfb6d,accessKeySecret:_0xb18afd,SignName:_0x28aec1,TemplateCode:_0x2cb27b}=await this[_0x206688(0x229)][_0x206688(0x220)](),{phone:_0x542f4b,code:_0x3e6ae2}=_0x35c619;if(!_0x542f4b||!_0x3e6ae2)throw new common_1[(_0x206688(0x1fd))]('确实必要参数错误！',common_1[_0x206688(0x21c)]['BAD_REQUEST']);const _0x5264ed=new Core({'accessKeyId':_0x1dfb6d,'accessKeySecret':_0xb18afd,'endpoint':_0x206688(0x212),'apiVersion':_0x206688(0x222)}),_0x50f18e={'PhoneNumbers':_0x542f4b,'SignName':_0x28aec1,'TemplateCode':_0x2cb27b,'TemplateParam':JSON[_0x206688(0x1f7)]({'code':_0x3e6ae2})},_0x21447f={'method':_0x206688(0x224),'formatParams':![]};try{const _0x112986=await _0x5264ed['request']('SendSms',_0x50f18e,_0x21447f);if(_0x112986[_0x206688(0x20b)]==='OK')return!![];else throw new common_1[(_0x206688(0x1fd))](_0x112986[_0x206688(0x236)]||'验证码发送失败！',common_1['HttpStatus']['BAD_REQUEST']);}catch(_0x4feceb){throw new common_1['HttpException'](((_0x1ec1f0=_0x4feceb===null||_0x4feceb===void 0x0?void 0x0:_0x4feceb['data'])===null||_0x1ec1f0===void 0x0?void 0x0:_0x1ec1f0['Message'])||_0x206688(0x215),common_1[_0x206688(0x21c)][_0x206688(0x238)]);}}};VerificationService=__decorate([(0x0,common_1[_0x399f0f(0x1fb)])(),__param(0x0,(0x0,typeorm_1[_0x399f0f(0x23a)])(verifycation_entity_1[_0x399f0f(0x20d)])),__metadata(_0x399f0f(0x22f),[typeorm_2['Repository'],globalConfig_service_1[_0x399f0f(0x22d)],redisCache_service_1[_0x399f0f(0x226)]])],VerificationService),exports['VerificationService']=VerificationService;