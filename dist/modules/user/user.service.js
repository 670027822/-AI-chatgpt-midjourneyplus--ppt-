'use strict';const _0x309834=_0x1821;(function(_0x325c26,_0xe0528d){const _0x5072b5=_0x1821,_0x18c749=_0x325c26();while(!![]){try{const _0x2a41e2=parseInt(_0x5072b5(0xc9))/0x1*(parseInt(_0x5072b5(0xec))/0x2)+parseInt(_0x5072b5(0xdc))/0x3+-parseInt(_0x5072b5(0x114))/0x4*(-parseInt(_0x5072b5(0x135))/0x5)+parseInt(_0x5072b5(0xfd))/0x6+-parseInt(_0x5072b5(0xca))/0x7+-parseInt(_0x5072b5(0xce))/0x8+-parseInt(_0x5072b5(0x118))/0x9;if(_0x2a41e2===_0xe0528d)break;else _0x18c749['push'](_0x18c749['shift']());}catch(_0x3c0f78){_0x18c749['push'](_0x18c749['shift']());}}}(_0x3c09,0x7f5b5));function _0x1821(_0x31d912,_0x388c70){const _0x3c09d0=_0x3c09();return _0x1821=function(_0x182120,_0xe095da){_0x182120=_0x182120-0xaf;let _0x12e15d=_0x3c09d0[_0x182120];return _0x12e15d;},_0x1821(_0x31d912,_0x388c70);}var __decorate=this&&this['__decorate']||function(_0x3d8c54,_0x184d53,_0x1962fe,_0x2030a2){const _0x3c0e6a=_0x1821;var _0x5d68f9=arguments['length'],_0x10d1b6=_0x5d68f9<0x3?_0x184d53:_0x2030a2===null?_0x2030a2=Object[_0x3c0e6a(0xf3)](_0x184d53,_0x1962fe):_0x2030a2,_0x316290;if(typeof Reflect===_0x3c0e6a(0xd9)&&typeof Reflect[_0x3c0e6a(0xba)]===_0x3c0e6a(0xc2))_0x10d1b6=Reflect[_0x3c0e6a(0xba)](_0x3d8c54,_0x184d53,_0x1962fe,_0x2030a2);else{for(var _0x55d5a0=_0x3d8c54['length']-0x1;_0x55d5a0>=0x0;_0x55d5a0--)if(_0x316290=_0x3d8c54[_0x55d5a0])_0x10d1b6=(_0x5d68f9<0x3?_0x316290(_0x10d1b6):_0x5d68f9>0x3?_0x316290(_0x184d53,_0x1962fe,_0x10d1b6):_0x316290(_0x184d53,_0x1962fe))||_0x10d1b6;}return _0x5d68f9>0x3&&_0x10d1b6&&Object[_0x3c0e6a(0x136)](_0x184d53,_0x1962fe,_0x10d1b6),_0x10d1b6;},__metadata=this&&this[_0x309834(0x11a)]||function(_0x25c2ff,_0x27c1ef){const _0x120cf7=_0x309834;if(typeof Reflect===_0x120cf7(0xd9)&&typeof Reflect[_0x120cf7(0x158)]===_0x120cf7(0xc2))return Reflect[_0x120cf7(0x158)](_0x25c2ff,_0x27c1ef);},__param=this&&this[_0x309834(0x12f)]||function(_0x41d235,_0xbdb404){return function(_0x2dc0f5,_0x31361f){_0xbdb404(_0x2dc0f5,_0x31361f,_0x41d235);};};Object['defineProperty'](exports,'__esModule',{'value':!![]}),exports['UserService']=void 0x0;const globalConfig_service_1=require(_0x309834(0xef)),user_constant_1=require(_0x309834(0xe0)),mailer_1=require(_0x309834(0xbe)),verification_service_1=require(_0x309834(0x143)),common_1=require('@nestjs/common'),typeorm_1=require(_0x309834(0xbd)),typeorm_2=require(_0x309834(0x109)),user_entity_1=require('./user.entity'),bcrypt=require(_0x309834(0xe8)),_=require(_0x309834(0xda)),verification_constant_1=require(_0x309834(0xb6)),userBalance_service_1=require(_0x309834(0x150)),utils_1=require(_0x309834(0x12d)),balance_constant_1=require('../../common/constants/balance.constant'),config_entity_1=require('../globalConfig/config.entity'),whiteList_entity_1=require(_0x309834(0x104));function _0x3c09(){const _0xdba8c8=['1SDoSPM','5425840OOISPf','UNAUTHORIZED','修改用户信息成功！','Injectable','2225672XXncEi','username','您的账户已被永久加入黑名单、如有疑问、请联系管理员！','GlobalConfigService','@default.com','userDefautlAvatar','PENDING','isVerifyEmail','findOne','visitor','assign','object','lodash','checkUserStatus','1202322vJKovL','UserBalanceService','VerificationEnum','WhiteListEntity','./../../common/constants/user.constant','addBalanceToUser','whiteListEntity','BLACKLISTED','未激活用户不可手动变更状态！','当前账户不存在！','Like','生成邀请码失败，请重新试一次吧！','bcryptjs','verifyUserPassword','updateInfo','configEntity','892094mKLdnn','connection','ConfigEntity','./../globalConfig/globalConfig.service','registerIp','forEach','Registration','getOwnPropertyDescriptor','userId','registerVerifyExpir','VerificationService','find','maskIpAddress','affected','openId','queryAll','status','4209150GvvmvH','您的账户已被封禁、如有疑问、请联系管理员！','createUserFromOpenId','createUser','configMap:\x20','globalConfigService','lastLoginIp','../chatgpt/whiteList.entity','修改用户信息失败！','split',']成功!','UserService','typeorm','HttpStatus','当前绑定用户不存在！','MailerService','user','save','log','当前密码错误！','ACTIVE','的账号激活','registerVerifyEmailDesc','1034684bHwGvH','DESC','getUserFromOpenId','avatar','2088315bcHlPe','修改用户状态成功！','__metadata','addBalanceToNewUser','inviteCode','verifyUserCredentials','UserStatusEnum','verifyUserRegisterByPhone','isBindWx','savaLoginIp','qureyUserInfoByInviteCode','UserStatusErrMsg','update','userBalanceService','userEntity','getSuper','当前用户不存在！','updateUserPassword','createUserAndVerifycation','cloneDeep','queryUserBalanceByIds','../../common/utils','consecutiveDays','__param','verificationService','findAndCount','HttpException','超级管理员不可被操作！','phone','5idWcnF','defineProperty','绑定微信失败、请联系管理员！','reduce','InjectRepository','error:\x20','updateUserStatus','userRecharge','client','map','queryOneUserInfo','maskEmail','balanceInfo','role','./../verification/verification.service','email','该微信已绑定其他账号！','configKey','用户名或者邮箱已被注册！','没有变更，无需更改！','当前手机号已注册、请勿重复注册！','createRandomUid','用户不存在！','getUserStatus','当前用户信息失效、请重新登录！','BAD_REQUEST','compareSync','../userBalance/userBalance.service','LOCKED','queryOne','design:paramtypes','hashSync','inviteLink','registerBaseUrl','Not','metadata','密码重置为[','Repository','ADMIN_GIFT','用户名已存在！','sign','RechargeType','getInviteRecord','bindWx','../../common/constants/verification.constant','Connection','mailerService','getUserOpenId','decorate','super','getConfigs','@nestjs/typeorm','@nestjs-modules/mailer','updateStatus','queryUserInfoById','registerVerifyEmailTitle','function','getOpenIdByUserId','getUserInfo','不可将用户置为未激活状态！','password','configVal','createdAt'];_0x3c09=function(){return _0xdba8c8;};return _0x3c09();}let UserService=class UserService{constructor(_0x2cf1b5,_0x28c79a,_0x450bae,_0x8a9e51,_0x161aa1,_0x21b063,_0x5201a3,_0x4868ef){const _0x8cd222=_0x309834;this[_0x8cd222(0x126)]=_0x2cf1b5,this[_0x8cd222(0xe2)]=_0x28c79a,this[_0x8cd222(0xed)]=_0x450bae,this[_0x8cd222(0x130)]=_0x8a9e51,this[_0x8cd222(0xb8)]=_0x161aa1,this[_0x8cd222(0x125)]=_0x21b063,this[_0x8cd222(0x102)]=_0x5201a3,this[_0x8cd222(0xeb)]=_0x4868ef;}async[_0x309834(0x12a)](_0x122152,_0x2ed493){const _0x48ff00=_0x309834,{username:_0x53216e,email:_0x3647ea,password:_0x5e4443,invitedBy:_0x3439fe,client:client=0x0}=_0x122152;if(_0x3439fe){const _0x46aa69=await this[_0x48ff00(0x126)][_0x48ff00(0xd6)]({'where':{'inviteCode':_0x3439fe}});if(!_0x46aa69)throw new common_1[(_0x48ff00(0x132))]('无效的邀请码！',common_1['HttpStatus']['BAD_REQUEST']);}const _0x3cb3e4=[{'username':_0x53216e},{'email':_0x3647ea}],_0x5bb7e6=await this[_0x48ff00(0x126)]['findOne']({'where':_0x3cb3e4});if(_0x5bb7e6&&_0x5bb7e6['status']!==user_constant_1[_0x48ff00(0x11e)][_0x48ff00(0xd4)])throw new common_1[(_0x48ff00(0x132))](_0x48ff00(0x147),common_1[_0x48ff00(0x10a)][_0x48ff00(0x14e)]);try{const _0x247cba=_[_0x48ff00(0x12b)](_0x122152),_0x5233f9=bcrypt[_0x48ff00(0x154)](_0x5e4443,0xa),_0x41c87b=(0x0,utils_1['getClientIp'])(_0x2ed493);_0x247cba[_0x48ff00(0xc6)]=_0x5233f9,_0x247cba[_0x48ff00(0xf0)]=_0x41c87b,_0x247cba[_0x48ff00(0x13d)]=client;let _0x232c66;if(!_0x5bb7e6){const _0x1acf82=await this['globalConfigService'][_0x48ff00(0xbc)]([_0x48ff00(0xd3)]);_0x247cba[_0x48ff00(0x117)]=_0x1acf82,_0x232c66=await this['userEntity']['save'](_0x247cba);}else _0x232c66=_0x5bb7e6;const _0x3ab77c=await this[_0x48ff00(0xeb)][_0x48ff00(0xf7)]({'where':{'configKey':(0x0,typeorm_2['In'])(['isVerifyEmail','registerBaseUrl',_0x48ff00(0xc1),_0x48ff00(0x113),'registerVerifyEmailFrom','registerVerifyExpir'])}}),_0x2af127=_0x3ab77c[_0x48ff00(0x138)]((_0x5614c2,_0x203753)=>{const _0x5428fe=_0x48ff00;return _0x5614c2[_0x203753[_0x5428fe(0x146)]]=_0x203753[_0x5428fe(0xc7)],_0x5614c2;},{}),_0x2b130f=_0x2af127[_0x48ff00(0xd5)]?Number(_0x2af127[_0x48ff00(0xd5)]):0x1;if(_0x2b130f){const _0x52bcd1=_0x2af127[_0x48ff00(0xf5)]?Number(_0x2af127[_0x48ff00(0xf5)]):0x1e*0x3c,_0x23c17d=await this[_0x48ff00(0x130)]['createVerification'](_0x232c66,verification_constant_1[_0x48ff00(0xde)][_0x48ff00(0xf2)],_0x52bcd1),{code:_0x2939db,email:_0x363d18,id:_0x472250}=_0x23c17d,{registerVerifyEmailFrom:_0x32bd85}=_0x2af127;console[_0x48ff00(0x10f)](_0x48ff00(0x101),_0x2af127);const _0x48a13b=await this['mailerService']['sendMail']({'to':_0x363d18,'subject':'来自'+_0x32bd85+_0x48ff00(0x112),'template':'register','context':Object['assign']({'baseUrl':_0x2af127[_0x48ff00(0x156)],'code':_0x2939db,'id':_0x472250},_0x2af127)});console[_0x48ff00(0x10f)]('email\x20response\x20\x20->\x20:\x20',_0x48a13b);}else{const {username:_0x27cd21,email:_0x15ac8f,id:_0xa8320b,invitedBy:_0x50d9d6}=_0x232c66;await this[_0x48ff00(0x13b)](_0xa8320b,user_constant_1['UserStatusEnum'][_0x48ff00(0x111)]);let _0x32037f;_0x50d9d6&&(_0x32037f=await this[_0x48ff00(0x122)](_0x50d9d6)),await this['userBalanceService'][_0x48ff00(0x11b)](_0xa8320b,_0x32037f===null||_0x32037f===void 0x0?void 0x0:_0x32037f['id']);}return _0x232c66;}catch(_0x5d3700){console['log'](_0x48ff00(0x13a),_0x5d3700);throw _0x5d3700;}}async[_0x309834(0x127)](){const _0x542716=_0x309834,_0x12daf6=await this['userEntity'][_0x542716(0xd6)]({'where':{'role':'super'}});return _0x12daf6;}async[_0x309834(0x11d)](_0x57b583){const _0x4ebc20=_0x309834,{username:_0x2f8c68,password:_0x3b8e52,uid:uid=0x0,phone:_0x3d7310}=_0x57b583;let _0x52b3e5=null;if(uid>0x0){_0x52b3e5=await this['userEntity'][_0x4ebc20(0xd6)]({'where':{'id':uid}});if(!_0x52b3e5)throw new common_1[(_0x4ebc20(0x132))]('当前账户不存在！',common_1[_0x4ebc20(0x10a)][_0x4ebc20(0x14e)]);if(!bcrypt[_0x4ebc20(0x14f)](_0x3b8e52,_0x52b3e5[_0x4ebc20(0xc6)]))throw new common_1['HttpException'](_0x4ebc20(0x110),common_1['HttpStatus'][_0x4ebc20(0x14e)]);}if(_0x2f8c68&&_0x3b8e52){const _0x28f424=[{'username':_0x2f8c68},{'email':_0x2f8c68}];_0x52b3e5=await this['userEntity'][_0x4ebc20(0xd6)]({'where':_0x28f424});if(!_0x52b3e5)throw new common_1[(_0x4ebc20(0x132))](_0x4ebc20(0xe5),common_1[_0x4ebc20(0x10a)]['BAD_REQUEST']);if(!bcrypt[_0x4ebc20(0x14f)](_0x3b8e52,_0x52b3e5[_0x4ebc20(0xc6)]))throw new common_1[(_0x4ebc20(0x132))](_0x4ebc20(0x110),common_1[_0x4ebc20(0x10a)][_0x4ebc20(0x14e)]);}if(_0x3d7310&&_0x3b8e52){const _0x1f3e0d=[{'phone':_0x3d7310}];_0x52b3e5=await this[_0x4ebc20(0x126)][_0x4ebc20(0xd6)]({'where':_0x1f3e0d});if(!_0x52b3e5)throw new common_1['HttpException'](_0x4ebc20(0xe5),common_1[_0x4ebc20(0x10a)][_0x4ebc20(0x14e)]);if(!bcrypt['compareSync'](_0x3b8e52,_0x52b3e5[_0x4ebc20(0xc6)]))throw new common_1[(_0x4ebc20(0x132))](_0x4ebc20(0x110),common_1[_0x4ebc20(0x10a)]['BAD_REQUEST']);}if(!_0x52b3e5)throw new common_1[(_0x4ebc20(0x132))](_0x4ebc20(0xe5),common_1['HttpStatus'][_0x4ebc20(0x14e)]);if(_0x52b3e5[_0x4ebc20(0xfc)]!==user_constant_1['UserStatusEnum'][_0x4ebc20(0x111)])throw new common_1[(_0x4ebc20(0x132))](user_constant_1[_0x4ebc20(0x123)][_0x52b3e5[_0x4ebc20(0xfc)]],common_1[_0x4ebc20(0x10a)][_0x4ebc20(0x14e)]);return _0x52b3e5;}async[_0x309834(0xe9)](_0x16964a,_0x25502b){const _0x640cd6=_0x309834,_0x533a9d=await this[_0x640cd6(0x126)][_0x640cd6(0xd6)]({'where':{'id':_0x16964a}});return bcrypt[_0x640cd6(0x14f)](_0x25502b,_0x533a9d['password']);}async[_0x309834(0x13b)](_0x526af9,_0x2a47a6){const _0x5c56c7=_0x309834,_0x7cade5=await this[_0x5c56c7(0x126)][_0x5c56c7(0x124)]({'id':_0x526af9},{'status':_0x2a47a6});return _0x7cade5[_0x5c56c7(0xf9)]>0x0;}async[_0x309834(0x14c)](_0x1277b7){const _0x9ef1e2=_0x309834,_0x7ecd28=await this['userEntity'][_0x9ef1e2(0xd6)]({'where':{'id':_0x1277b7}});return _0x7ecd28['status'];}async[_0x309834(0xc0)](_0x4f3e58){const _0x56bfbf=_0x309834;return await this[_0x56bfbf(0x126)]['findOne']({'where':{'id':_0x4f3e58}});}async[_0x309834(0x13f)](_0x2d2544){return await this['userEntity']['findOne']({'where':{'id':_0x2d2544}});}async[_0x309834(0xdb)](_0x1a2a56){const _0x52f48e=_0x309834,{id:_0x26cfd6,role:_0x2c47ba}=_0x1a2a56;if(_0x2c47ba===_0x52f48e(0xd7))return!![];const _0x5c7102=await this[_0x52f48e(0x126)][_0x52f48e(0xd6)]({'where':{'id':_0x26cfd6}});if(!_0x5c7102)throw new common_1[(_0x52f48e(0x132))](_0x52f48e(0x14d),common_1[_0x52f48e(0x10a)][_0x52f48e(0xcb)]);if(_0x5c7102[_0x52f48e(0xfc)]===user_constant_1['UserStatusEnum'][_0x52f48e(0xe3)])throw new common_1[(_0x52f48e(0x132))](_0x52f48e(0xd0),common_1['HttpStatus'][_0x52f48e(0x14e)]);if(_0x5c7102[_0x52f48e(0xfc)]===user_constant_1[_0x52f48e(0x11e)][_0x52f48e(0x151)])throw new common_1[(_0x52f48e(0x132))](_0x52f48e(0xfe),common_1['HttpStatus'][_0x52f48e(0x14e)]);}async[_0x309834(0xc4)](_0x2d3c38){const _0x6e848a=_0x309834,_0x39b014=await this[_0x6e848a(0x126)][_0x6e848a(0xd6)]({'where':{'id':_0x2d3c38},'select':['username',_0x6e848a(0x117),_0x6e848a(0x142),_0x6e848a(0x144),'sign','inviteCode',_0x6e848a(0xfa),_0x6e848a(0x12e)]});if(!_0x39b014)throw new common_1['HttpException'](_0x6e848a(0x14d),common_1[_0x6e848a(0x10a)][_0x6e848a(0xcb)]);_0x39b014[_0x6e848a(0x120)]=!!(_0x39b014===null||_0x39b014===void 0x0?void 0x0:_0x39b014['openId']),delete _0x39b014[_0x6e848a(0xfa)];const _0xa027a8=await this[_0x6e848a(0x125)]['queryUserBalance'](_0x2d3c38);return{'userInfo':_0x39b014,'userBalance':Object['assign']({},_0xa027a8)};}async['getUserById'](_0x33a6be){const _0xb92895=_0x309834;return await this[_0xb92895(0x126)]['findOne']({'where':{'id':_0x33a6be}});}async[_0x309834(0xb9)](_0x597cdf){return await this['userEntity']['findOne']({'where':{'openId':_0x597cdf}});}async[_0x309834(0xea)](_0x4cef21,_0x44ff80){const _0x598dc4=_0x309834,{id:_0x490a5c}=_0x44ff80[_0x598dc4(0x10d)],_0x1d16f6=await this[_0x598dc4(0x126)][_0x598dc4(0xd6)]({'where':{'id':_0x490a5c}});if(!_0x1d16f6)throw new common_1[(_0x598dc4(0x132))](_0x598dc4(0x128),common_1[_0x598dc4(0x10a)]['BAD_REQUEST']);if(_0x4cef21[_0x598dc4(0xcf)]&&_0x1d16f6['username']===_0x4cef21[_0x598dc4(0xcf)])throw new common_1[(_0x598dc4(0x132))](_0x598dc4(0x148),common_1[_0x598dc4(0x10a)][_0x598dc4(0x14e)]);if(_0x4cef21[_0x598dc4(0xcf)]){const _0x23dd4c=await this[_0x598dc4(0x126)][_0x598dc4(0xd6)]({'where':{'username':_0x4cef21[_0x598dc4(0xcf)],'id':(0x0,typeorm_2[_0x598dc4(0x157)])(_0x490a5c)}});if(_0x23dd4c)throw new common_1[(_0x598dc4(0x132))](_0x598dc4(0xb1),common_1[_0x598dc4(0x10a)][_0x598dc4(0x14e)]);}const _0x2f3f81=await this[_0x598dc4(0x126)]['update']({'id':_0x490a5c},_0x4cef21);if(_0x2f3f81[_0x598dc4(0xf9)]<=0x0)throw new common_1[(_0x598dc4(0x132))](_0x598dc4(0x105),common_1[_0x598dc4(0x10a)][_0x598dc4(0x14e)]);return _0x598dc4(0xcc);}async[_0x309834(0x129)](_0x5298d0,_0x209417){const _0x29367f=_0x309834,_0x484adc=bcrypt[_0x29367f(0x154)](_0x209417,0xa),_0x5c87af=await this[_0x29367f(0x126)]['update']({'id':_0x5298d0},{'password':_0x484adc});if(_0x5c87af[_0x29367f(0xf9)]<=0x0)throw new common_1[(_0x29367f(0x132))]('修改密码失败、请重新试试吧。',common_1[_0x29367f(0x10a)][_0x29367f(0x14e)]);}async['genInviteCode'](_0x33bedf){const _0x484c1f=_0x309834,{id:_0x583b94}=_0x33bedf['user'],_0x20b1eb=await this[_0x484c1f(0x126)]['findOne']({'where':{'id':_0x583b94}});if(!_0x20b1eb||_0x20b1eb['inviteCode'])throw new common_1[(_0x484c1f(0x132))]('已生成过邀请码、请勿重复生成',common_1[_0x484c1f(0x10a)][_0x484c1f(0x14e)]);const _0x4f2914=(0x0,utils_1['generateRandomString'])(),_0x481eca=await this[_0x484c1f(0x126)][_0x484c1f(0xd6)]({'where':{'inviteCode':_0x4f2914}});if(_0x481eca)throw new common_1[(_0x484c1f(0x132))](_0x484c1f(0xe7),common_1[_0x484c1f(0x10a)]['BAD_REQUEST']);const _0x4a0b97=await this[_0x484c1f(0x126)][_0x484c1f(0x124)]({'id':_0x583b94},{'inviteCode':_0x4f2914});if(_0x4a0b97[_0x484c1f(0xf9)]<=0x0)throw new common_1[(_0x484c1f(0x132))](_0x484c1f(0xe7),common_1[_0x484c1f(0x10a)][_0x484c1f(0x14e)]);return _0x4f2914;}async[_0x309834(0xb4)](_0x3656ac,_0x21de5b){const _0x50bd79=_0x309834;try{const {id:_0xad7d37}=_0x3656ac[_0x50bd79(0x10d)],{page:page=0x1,size:size=0xa}=_0x21de5b,_0x21cf02=await this['userEntity'][_0x50bd79(0xd6)]({'where':{'id':_0xad7d37}}),{inviteCode:_0x2f09f6}=_0x21cf02;if(!_0x2f09f6)return[];const [_0x5e726e,_0x105b72]=await this[_0x50bd79(0x126)][_0x50bd79(0x131)]({'where':{'inviteCode':_0x2f09f6},'order':{'id':'DESC'},'select':[_0x50bd79(0xcf),_0x50bd79(0x144),_0x50bd79(0xc8),_0x50bd79(0xfc),'avatar'],'take':size,'skip':(page-0x1)*size});return(0x0,utils_1['formatCreateOrUpdateDate'])(_0x5e726e)[_0x50bd79(0x13e)](_0x55c923=>{const _0xb78846=_0x50bd79;return _0x55c923[_0xb78846(0x144)]=(0x0,utils_1[_0xb78846(0x140)])(_0x55c923[_0xb78846(0x144)]),_0x55c923;}),{'rows':_0x5e726e,'count':_0x105b72};}catch(_0x1b1adc){console[_0x50bd79(0x10f)](_0x50bd79(0x13a),_0x1b1adc);throw new common_1['HttpException']('获取邀请记录失败！',common_1['HttpStatus'][_0x50bd79(0x14e)]);}}async[_0x309834(0x155)](_0x2eba16){const _0x480774=_0x309834,_0x545bda=await this[_0x480774(0x126)][_0x480774(0xd6)]({'where':{'inviteCode':_0x2eba16}});if(!_0x545bda)return 0x1;const {inviteLinkCount:inviteLinkCount=0x0}=_0x545bda,_0x189f23=await this[_0x480774(0x126)][_0x480774(0x124)]({'inviteCode':_0x2eba16},{'inviteLinkCount':inviteLinkCount+0x1});return _0x189f23['affected']?0x1:0x0;}async['qureyUserInfoByInviteCode'](_0x4b72ff){const _0x1efedb=_0x309834;return await this['userEntity'][_0x1efedb(0xd6)]({'where':{'inviteCode':_0x4b72ff}});}async[_0x309834(0x13c)](_0x447db9){const _0x2b702a=_0x309834,{userId:_0x4376a6,model3Count:model3Count=0x0,model4Count:model4Count=0x0,drawMjCount:drawMjCount=0x0}=_0x447db9;await this[_0x2b702a(0x125)][_0x2b702a(0xe1)](_0x4376a6,{'model3Count':model3Count,'model4Count':model4Count,'drawMjCount':drawMjCount});const _0xfae36e=await this[_0x2b702a(0x125)]['saveRecordRechargeLog']({'userId':_0x4376a6,'rechargeType':balance_constant_1[_0x2b702a(0xb3)][_0x2b702a(0xb0)],'model3Count':model3Count,'model4Count':model4Count,'drawMjCount':drawMjCount,'extent':''});return _0xfae36e;}async[_0x309834(0xfb)](_0xc21e8d,_0x4a498){const _0x168fd5=_0x309834,{page:page=0x1,size:size=0xa,username:_0x5e40ff,email:_0xed9e4a,status:_0x56072a,keyword:_0x44b874,phone:_0x4d34ef}=_0xc21e8d;let _0x5b161c={};_0x5e40ff&&Object[_0x168fd5(0xd8)](_0x5b161c,{'username':(0x0,typeorm_2[_0x168fd5(0xe6)])('%'+_0x5e40ff+'%')}),_0xed9e4a&&Object[_0x168fd5(0xd8)](_0x5b161c,{'email':(0x0,typeorm_2[_0x168fd5(0xe6)])('%'+_0xed9e4a+'%')}),_0x4d34ef&&Object[_0x168fd5(0xd8)](_0x5b161c,{'phone':(0x0,typeorm_2[_0x168fd5(0xe6)])('%'+_0x4d34ef+'%')}),_0x56072a&&Object[_0x168fd5(0xd8)](_0x5b161c,{'status':_0x56072a});_0x44b874&&(_0x5b161c=[{'username':(0x0,typeorm_2[_0x168fd5(0xe6)])('%'+_0x44b874+'%')},{'email':(0x0,typeorm_2[_0x168fd5(0xe6)])('%'+_0x44b874+'%')},{'phone':(0x0,typeorm_2[_0x168fd5(0xe6)])('%'+_0x44b874+'%')}]);const [_0x2d1065,_0x42803b]=await this['userEntity'][_0x168fd5(0x131)]({'skip':(page-0x1)*size,'where':_0x5b161c,'take':size,'order':{'createdAt':_0x168fd5(0x115)},'cache':!![],'select':['username',_0x168fd5(0x117),_0x168fd5(0x11c),_0x168fd5(0x142),'sign','status','id',_0x168fd5(0x144),_0x168fd5(0xc8),_0x168fd5(0x103),_0x168fd5(0x134)]}),_0x1dae1d=_0x2d1065[_0x168fd5(0x13e)](_0x5b6af2=>_0x5b6af2['id']),_0x326442=await this[_0x168fd5(0x125)][_0x168fd5(0x12c)](_0x1dae1d);return _0x2d1065[_0x168fd5(0xf1)](_0x5cdf3a=>_0x5cdf3a[_0x168fd5(0x141)]=_0x326442['find'](_0x550bb8=>_0x550bb8[_0x168fd5(0xf4)]===_0x5cdf3a['id'])),_0x4a498[_0x168fd5(0x10d)][_0x168fd5(0x142)]!==_0x168fd5(0xbb)&&_0x2d1065[_0x168fd5(0xf1)](_0x365440=>_0x365440[_0x168fd5(0x144)]=(0x0,utils_1['maskEmail'])(_0x365440[_0x168fd5(0x144)])),_0x4a498['user'][_0x168fd5(0x142)]!=='super'&&_0x2d1065['forEach'](_0x4b5d5a=>_0x4b5d5a[_0x168fd5(0x103)]=(0x0,utils_1[_0x168fd5(0xf8)])(_0x4b5d5a[_0x168fd5(0x103)])),_0x4a498[_0x168fd5(0x10d)][_0x168fd5(0x142)]!==_0x168fd5(0xbb)&&_0x2d1065[_0x168fd5(0xf1)](_0x4800ce=>_0x4800ce[_0x168fd5(0x134)]=(0x0,utils_1[_0x168fd5(0xf8)])(_0x4800ce[_0x168fd5(0x134)])),{'rows':_0x2d1065,'count':_0x42803b};}async[_0x309834(0x152)]({id:_0x56c9ae}){const _0x5caa6a=_0x309834;return await this[_0x5caa6a(0x126)]['findOne']({'where':{'id':_0x56c9ae},'select':[_0x5caa6a(0xcf),_0x5caa6a(0x117),'inviteCode','role',_0x5caa6a(0xb2),'status']});}async[_0x309834(0xbf)](_0x213bea){const _0x62d2e9=_0x309834,{id:_0x1b1261,status:_0x144608}=_0x213bea,_0x394696=await this[_0x62d2e9(0x126)][_0x62d2e9(0xd6)]({'where':{'id':_0x1b1261}});if(!_0x394696)throw new common_1['HttpException']('用户不存在！',common_1[_0x62d2e9(0x10a)][_0x62d2e9(0x14e)]);if(_0x394696[_0x62d2e9(0x142)]===_0x62d2e9(0xbb))throw new common_1['HttpException']('超级管理员不可被操作！',common_1[_0x62d2e9(0x10a)][_0x62d2e9(0x14e)]);if(_0x394696['status']===user_constant_1['UserStatusEnum']['PENDING'])throw new common_1[(_0x62d2e9(0x132))](_0x62d2e9(0xe4),common_1[_0x62d2e9(0x10a)][_0x62d2e9(0x14e)]);if(_0x394696['role']===_0x62d2e9(0xbb))throw new common_1['HttpException'](_0x62d2e9(0x133),common_1[_0x62d2e9(0x10a)][_0x62d2e9(0x14e)]);if(_0x144608===user_constant_1[_0x62d2e9(0x11e)]['PENDING'])throw new common_1[(_0x62d2e9(0x132))](_0x62d2e9(0xc5),common_1[_0x62d2e9(0x10a)][_0x62d2e9(0x14e)]);const _0x1730f5=await this[_0x62d2e9(0x126)][_0x62d2e9(0x124)]({'id':_0x1b1261},{'status':_0x144608});if(_0x1730f5['affected']<=0x0)throw new common_1[(_0x62d2e9(0x132))]('修改用户状态失败！',common_1[_0x62d2e9(0x10a)]['BAD_REQUEST']);return _0x62d2e9(0x119);}async['resetUserPass'](_0x50e555){const _0x378589=_0x309834,{id:_0x3e0aca}=_0x50e555,_0x2e4635=await this['userEntity']['findOne']({'where':{'id':_0x3e0aca}});if(!_0x2e4635)throw new common_1[(_0x378589(0x132))](_0x378589(0x14b),common_1[_0x378589(0x10a)][_0x378589(0x14e)]);const _0xbdf6e6='123456',_0x4b75a9=bcrypt[_0x378589(0x154)](_0xbdf6e6,0xa),_0x1d9941=await this[_0x378589(0x126)]['update']({'id':_0x3e0aca},{'password':_0x4b75a9});if(_0x1d9941['affected']<=0x0)throw new common_1[(_0x378589(0x132))]('重置密码失败！',common_1[_0x378589(0x10a)][_0x378589(0x14e)]);return _0x378589(0x159)+_0xbdf6e6+_0x378589(0x107);}async[_0x309834(0x121)](_0x536a6f,_0x2c7723){const _0x19a388=_0x309834;return await this[_0x19a388(0x126)][_0x19a388(0x124)]({'id':_0x536a6f},{'lastLoginIp':_0x2c7723});}async[_0x309834(0x116)](_0x16b5d8,_0x3f934a){const _0x332404=_0x309834,_0x31d004=await this[_0x332404(0x126)][_0x332404(0xd6)]({'where':{'openId':_0x16b5d8}});if(!_0x31d004){const _0x4020e2=_0x3f934a?_0x3f934a[_0x332404(0x106)](':')[0x1]:'',_0x37e1b0=await this[_0x332404(0x122)](_0x4020e2),_0x309488=await this[_0x332404(0xff)](_0x16b5d8,_0x4020e2);return await this[_0x332404(0x125)][_0x332404(0x11b)](_0x309488['id'],_0x4020e2?_0x37e1b0===null||_0x37e1b0===void 0x0?void 0x0:_0x37e1b0['id']:null),_0x309488;}return _0x31d004;}async['createUserFromOpenId'](_0x34fdea,_0x4428f7){const _0x2aa4fe=_0x309834,_0x95f686=await this['globalConfigService'][_0x2aa4fe(0xbc)](['userDefautlAvatar']),_0x1b123c={'avatar':_0x95f686,'username':'用户'+(0x0,utils_1[_0x2aa4fe(0x14a)])(),'status':user_constant_1[_0x2aa4fe(0x11e)]['ACTIVE'],'sex':0x0,'email':(0x0,utils_1[_0x2aa4fe(0x14a)])()+_0x2aa4fe(0xd2),'invitedBy':_0x4428f7,'openId':_0x34fdea},_0x2b545a=await this[_0x2aa4fe(0x126)][_0x2aa4fe(0x10e)](_0x1b123c);return _0x2b545a;}async[_0x309834(0xb5)](_0x1b1e3c,_0x39336e){const _0x567bfb=_0x309834;try{const _0x422315=await this[_0x567bfb(0x126)][_0x567bfb(0xd6)]({'where':{'id':_0x39336e}});if(!_0x422315)return{'status':![],'msg':_0x567bfb(0x10b)};const _0x4dce22=await this['userEntity'][_0x567bfb(0xd6)]({'where':{'openId':_0x1b1e3c}});if(_0x4dce22)return{'status':![],'msg':_0x567bfb(0x145)};const _0x5e9e28=await this[_0x567bfb(0x126)][_0x567bfb(0x124)]({'id':_0x39336e},{'openId':_0x1b1e3c});if(_0x5e9e28[_0x567bfb(0xf9)]<=0x0)return{'status':![],'msg':_0x567bfb(0x137)};return{'status':!![],'msg':'恭喜您绑定成功、后续可直接扫码登录了！'};}catch(_0x119909){return{'status':![],'msg':_0x567bfb(0x137)};}}async[_0x309834(0xc3)](_0x4a4a53){const _0x4bdc15=_0x309834,_0x36c8ca=await this[_0x4bdc15(0x126)][_0x4bdc15(0xd6)]({'where':{'id':_0x4a4a53}});return _0x36c8ca===null||_0x36c8ca===void 0x0?void 0x0:_0x36c8ca[_0x4bdc15(0xfa)];}async[_0x309834(0x11f)](_0x2ce522){const _0x1e8068=_0x309834,{username:_0x5da5ea,password:_0x39b373,phone:_0x5ea27b,phoneCode:_0x31c723}=_0x2ce522,_0x13e453=await this[_0x1e8068(0x126)][_0x1e8068(0xd6)]({'where':[{'username':_0x5da5ea},{'phone':_0x5ea27b}]});if(_0x13e453&&_0x13e453[_0x1e8068(0xcf)]===_0x5da5ea)throw new common_1[(_0x1e8068(0x132))]('用户名已存在、请更换用户名！',common_1[_0x1e8068(0x10a)][_0x1e8068(0x14e)]);if(_0x13e453&&_0x13e453['phone']===_0x5ea27b)throw new common_1['HttpException'](_0x1e8068(0x149),common_1[_0x1e8068(0x10a)][_0x1e8068(0x14e)]);}async[_0x309834(0x100)](_0x206d3c){const _0x78811f=_0x309834;return await this[_0x78811f(0x126)]['save'](_0x206d3c);}};UserService=__decorate([(0x0,common_1[_0x309834(0xcd)])(),__param(0x0,(0x0,typeorm_1[_0x309834(0x139)])(user_entity_1['UserEntity'])),__param(0x1,(0x0,typeorm_1[_0x309834(0x139)])(whiteList_entity_1[_0x309834(0xdf)])),__param(0x7,(0x0,typeorm_1[_0x309834(0x139)])(config_entity_1[_0x309834(0xee)])),__metadata(_0x309834(0x153),[typeorm_2[_0x309834(0xaf)],typeorm_2[_0x309834(0xaf)],typeorm_2[_0x309834(0xb7)],verification_service_1[_0x309834(0xf6)],mailer_1[_0x309834(0x10c)],userBalance_service_1[_0x309834(0xdd)],globalConfig_service_1[_0x309834(0xd1)],typeorm_2['Repository']])],UserService),exports[_0x309834(0x108)]=UserService;